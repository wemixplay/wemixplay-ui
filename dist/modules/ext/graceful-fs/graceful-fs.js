"use strict";var e,t,n=require("../../_virtual/_commonjsHelpers.js"),o=require("./polyfills.js"),r=require("./clone.js"),i=require("./legacy-streams.js"),u=require("assert"),c=require("fs"),a=require("util"),f=c,l=o.polyfills,p=i.legacyStreams,s=r.clone_1,y=a;function d(t,n){Object.defineProperty(t,e,{get:function(){return n}})}"function"==typeof Symbol&&"function"==typeof Symbol.for?(e=Symbol.for("graceful-fs.queue"),t=Symbol.for("graceful-fs.previous")):(e="___graceful-fs.queue",t="___graceful-fs.previous");var m,v=function(){};if(y.debuglog?v=y.debuglog("gfs4"):/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&(v=function(){var e=y.format.apply(y,arguments);e="GFS4: "+e.split(/\n/).join("\nGFS4: ")}),!f[e]){var E=n.commonjsGlobal[e]||[];d(f,E),f.close=function(e){function n(t,n){return e.call(f,t,(function(e){e||h(),"function"==typeof n&&n.apply(this,arguments)}))}return Object.defineProperty(n,t,{value:e}),n}(f.close),f.closeSync=function(e){function n(t){e.apply(f,arguments),h()}return Object.defineProperty(n,t,{value:e}),n}(f.closeSync),/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&process.on("exit",(function(){v(f[e]),u.equal(f[e].length,0)}))}function b(e){l(e),e.gracefulify=b,e.createReadStream=function(t,n){return new e.ReadStream(t,n)},e.createWriteStream=function(t,n){return new e.WriteStream(t,n)};var t=e.readFile;e.readFile=function(e,n,o){"function"==typeof n&&(o=n,n=null);return function e(n,o,r,i){return t(n,o,(function(t){!t||"EMFILE"!==t.code&&"ENFILE"!==t.code?"function"==typeof r&&r.apply(this,arguments):g([e,[n,o,r],t,i||Date.now(),Date.now()])}))}(e,n,o)};var n=e.writeFile;e.writeFile=function(e,t,o,r){"function"==typeof o&&(r=o,o=null);return function e(t,o,r,i,u){return n(t,o,r,(function(n){!n||"EMFILE"!==n.code&&"ENFILE"!==n.code?"function"==typeof i&&i.apply(this,arguments):g([e,[t,o,r,i],n,u||Date.now(),Date.now()])}))}(e,t,o,r)};var o=e.appendFile;o&&(e.appendFile=function(e,t,n,r){"function"==typeof n&&(r=n,n=null);return function e(t,n,r,i,u){return o(t,n,r,(function(o){!o||"EMFILE"!==o.code&&"ENFILE"!==o.code?"function"==typeof i&&i.apply(this,arguments):g([e,[t,n,r,i],o,u||Date.now(),Date.now()])}))}(e,t,n,r)});var r=e.copyFile;r&&(e.copyFile=function(e,t,n,o){"function"==typeof n&&(o=n,n=0);return function e(t,n,o,i,u){return r(t,n,o,(function(r){!r||"EMFILE"!==r.code&&"ENFILE"!==r.code?"function"==typeof i&&i.apply(this,arguments):g([e,[t,n,o,i],r,u||Date.now(),Date.now()])}))}(e,t,n,o)});var i=e.readdir;e.readdir=function(e,t,n){"function"==typeof t&&(n=t,t=null);var o=u.test(process.version)?function(e,t,n,o){return i(e,r(e,t,n,o))}:function(e,t,n,o){return i(e,t,r(e,t,n,o))};return o(e,t,n);function r(e,t,n,r){return function(i,u){!i||"EMFILE"!==i.code&&"ENFILE"!==i.code?(u&&u.sort&&u.sort(),"function"==typeof n&&n.call(this,i,u)):g([o,[e,t,n],i,r||Date.now(),Date.now()])}}};var u=/^v[0-5]\./;if("v0.8"===process.version.substr(0,4)){var c=p(e);d=c.ReadStream,m=c.WriteStream}var a=e.ReadStream;a&&(d.prototype=Object.create(a.prototype),d.prototype.open=function(){var e=this;E(e.path,e.flags,e.mode,(function(t,n){t?(e.autoClose&&e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n),e.read())}))});var f=e.WriteStream;f&&(m.prototype=Object.create(f.prototype),m.prototype.open=function(){var e=this;E(e.path,e.flags,e.mode,(function(t,n){t?(e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n))}))}),Object.defineProperty(e,"ReadStream",{get:function(){return d},set:function(e){d=e},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WriteStream",{get:function(){return m},set:function(e){m=e},enumerable:!0,configurable:!0});var s=d;Object.defineProperty(e,"FileReadStream",{get:function(){return s},set:function(e){s=e},enumerable:!0,configurable:!0});var y=m;function d(e,t){return this instanceof d?(a.apply(this,arguments),this):d.apply(Object.create(d.prototype),arguments)}function m(e,t){return this instanceof m?(f.apply(this,arguments),this):m.apply(Object.create(m.prototype),arguments)}Object.defineProperty(e,"FileWriteStream",{get:function(){return y},set:function(e){y=e},enumerable:!0,configurable:!0});var v=e.open;function E(e,t,n,o){return"function"==typeof n&&(o=n,n=null),function e(t,n,o,r,i){return v(t,n,o,(function(u,c){!u||"EMFILE"!==u.code&&"ENFILE"!==u.code?"function"==typeof r&&r.apply(this,arguments):g([e,[t,n,o,r],u,i||Date.now(),Date.now()])}))}(e,t,n,o)}return e.open=E,e}function g(t){v("ENQUEUE",t[0].name,t[1]),f[e].push(t),F()}function h(){for(var t=Date.now(),n=0;n<f[e].length;++n)f[e][n].length>2&&(f[e][n][3]=t,f[e][n][4]=t);F()}function F(){if(clearTimeout(m),m=void 0,0!==f[e].length){var t=f[e].shift(),n=t[0],o=t[1],r=t[2],i=t[3],u=t[4];if(void 0===i)v("RETRY",n.name,o),n.apply(null,o);else if(Date.now()-i>=6e4){v("TIMEOUT",n.name,o);var c=o.pop();"function"==typeof c&&c.call(null,r)}else{var a=Date.now()-u,l=Math.max(u-i,1);a>=Math.min(1.2*l,100)?(v("RETRY",n.name,o),n.apply(null,o.concat([i]))):f[e].push(t)}void 0===m&&(m=setTimeout(F,0))}}n.commonjsGlobal[e]||d(n.commonjsGlobal,f[e]),exports.gracefulFs=b(s(f)),process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&!f.__patched&&(exports.gracefulFs=b(f),f.__patched=!0);
