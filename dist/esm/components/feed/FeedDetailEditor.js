import e from"@babel/runtime/helpers/toConsumableArray";import t from"@babel/runtime/helpers/slicedToArray";import n from"@babel/runtime/regenerator";import{__rest as a,__awaiter as r}from"../../_virtual/_tslib.js";import i,{forwardRef as o,useRef as l,useState as s,useMemo as c,useCallback as m,useEffect as u,useImperativeHandle as d}from"react";import f from"./FeedDetailEditor.module.scss.js";import g from"../editor/WpEditor.js";import p from"../../plugins/mention/Mention.js";import v from"../../plugins/hashTag/HashTag.js";import h from"../../plugins/autoUrlMatch/AutoUrlMatch.js";import b from"../../plugins/pasteToPlainText/PasteToPlainText.js";import{makeCxFunc as x}from"../../utils/forReactUtils.js";import y from'./../../ext/lodash/uniqBy.js';import{readAsDataURLAsync as E,imageFileUpload as C}from"../../utils/fileUtils.js";import j from"./FeedImagesView.js";import{convertIframeYouTubeURL as I,convertIframeTwitchURL as w,isYouTubeURL as N,isTwitchURL as U}from"../../utils/urlUtils.js";import k from"./FeedIframesView.js";import M from"./FeedLinkPreview.js";import S from"../../assets/svgs/ico-chevron-down.svg.js";import T from"../../assets/svgs/ico-image.svg.js";import A from"../../plugins/countTextLength/CountTextLength.js";import{convertMarkdownToHtmlStr as O,removeSpaceAndLineBreak as D,convertHtmlToMarkdownStr as P,commaWithValue as F}from"../../utils/valueParserUtils.js";import L from"../avatars/Person.js";import V from"../popover/PopoverButton.js";import z from"../loadings/Spinner.js";function W(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return _(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_(e,t):void 0}}(e))||t){n&&(e=n);var a=0,r=function(){};return{s:r,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){l=!0,i=e},f:function(){try{o||null==n.return||n.return()}finally{if(l)throw i}}}}function _(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}var J=x(f),$=o((function(o,f){var x,_=o.className,$=void 0===_?"":_,B=o.textValue,R=o.images,q=o.media,H=o.ogMetaData,G=o.name,K=o.minLength,Q=void 0===K?10:K,X=o.isOfficial,Y=o.writerName,Z=o.writerImg,ee=o.channelName,te=o.channelImg,ne=o.categoryName,ae=o.btnSubmitText,re=void 0===ae?"POST":ae,ie=o.maxLength,oe=void 0===ie?1e3:ie,le=o.placeholder,se=void 0===le?"What is happening?!":le,ce=o.config,me=void 0===ce?{}:ce,ue=o.imageMaxCnt,de=void 0===ue?4:ue,fe=o.iframeMaxCnt,ge=void 0===fe?4:fe,pe=o.selectChannelPopoverElement,ve=void 0===pe?i.createElement(i.Fragment,null):pe,he=o.selectCategoryPopoverElement,be=void 0===he?i.createElement(i.Fragment,null):he,xe=o.loading,ye=o.handleTextChange,Ee=o.handleImageChange,Ce=o.handleMediaChange,je=o.handleSubmit,Ie=o.handleExternalUrlChange,we=o.onSelectChannelClick,Ne=o.onSelectCategoryClick,Ue=o.onUserClick,ke=o.onMaxImageUploads,Me=o.onMaxIframeUploads,Se=a(o,["className","textValue","images","media","ogMetaData","name","minLength","isOfficial","writerName","writerImg","channelName","channelImg","categoryName","btnSubmitText","maxLength","placeholder","config","imageMaxCnt","iframeMaxCnt","selectChannelPopoverElement","selectCategoryPopoverElement","loading","handleTextChange","handleImageChange","handleMediaChange","handleSubmit","handleExternalUrlChange","onSelectChannelClick","onSelectCategoryClick","onUserClick","onMaxImageUploads","onMaxIframeUploads"]),Te=l(),Ae=l(),Oe=s(null!==(x=null==B?void 0:B.length)&&void 0!==x?x:0),De=t(Oe,2),Pe=De[0],Fe=De[1],Le=s(O(null!=B?B:"")),Ve=t(Le,2),ze=Ve[0],We=Ve[1],_e=s(R),Je=t(_e,2),$e=Je[0],Be=Je[1],Re=s(q),qe=t(Re,2),He=qe[0],Ge=qe[1],Ke=s(H),Qe=t(Ke,2),Xe=Qe[0],Ye=Qe[1],Ze=s([]),et=t(Ze,2),tt=et[0],nt=et[1],at=c((function(){return Object.assign(Object.assign({},He),{textValue:ze,images:y($e,"src"),media:y(He,"src")})}),[ze,$e,He]),rt=c((function(){var e,t,n,a=!!D(at.textValue),r=!!(null!==(e=at.images)&&void 0!==e?e:[]).length,i=!!(null!==(t=at.media)&&void 0!==t?t:[]).length,o=(null!==(n=at.images)&&void 0!==n?n:[]).some((function(e){return!!e.loading}));return{loading:xe||o,disalbed:Q>Pe||xe||o||!i&&!r&&!a}}),[xe,Q,Pe,at]),it=m((function(t){var n,a=e(null!==(n=null==at?void 0:at.images)&&void 0!==n?n:[]);if("newImage"in t){if(Array.isArray(t.newImage)&&a.length<de)a=[].concat(e(a),e(t.newImage.slice(0,de-a.length)));else if(!Array.isArray(t.newImage)){if(a.length>=de)return ke?ke():alert("이미지는 최대 ".concat(de,"까지 업로드가 가능합니다.")),a;a.push(t.newImage)}a=y(a,"src")}else a=a.filter((function(e,n){return t.deleteIndex!==n}));return Ae.current.value="",a}),[at,G,de,ke]),ot=m((function(e){e.preventDefault()}),[]),lt=m((function(t){return r(void 0,void 0,void 0,n.mark((function a(){var r,i,o,l,s,c,m,u,d;return n.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(t.preventDefault(),i=Array.from(t.dataTransfer.files),o=i.filter((function(e){return e.type.startsWith("image/")})),0!==o.length){n.next=5;break}return n.abrupt("return");case 5:l=e(null!==(r=null==at?void 0:at.images)&&void 0!==r?r:[]),s=W(o),n.prev=7,s.s();case 9:if((c=s.n()).done){n.next=17;break}return m=c.value,n.next=13,E(m);case 13:u=n.sent,l.push({file:m,src:u});case 15:n.next=9;break;case 17:n.next=22;break;case 19:n.prev=19,n.t0=n.catch(7),s.e(n.t0);case 22:return n.prev=22,s.f(),n.finish(22);case 25:d=it({newImage:l}),Be(d),Ee&&Ee(d,G);case 28:case"end":return n.stop()}}),a,null,[[7,19,22,25]])})))}),[G,at,it,Ee]),st=m((function(e){return r(void 0,void 0,void 0,n.mark((function t(){var a,r,i,o;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,C(e);case 2:a=t.sent,r=a.file,i=a.dataUrl,o=it({newImage:{file:r,src:i}}),Be(o),Ee&&Ee(o,G);case 8:case"end":return t.stop()}}),t)})))}),[G,at,it,Ee]),ct=m((function(t){var n=e(at.media);if("media"in t){if(n.length>=ge)return Me&&Me(),n;if(Array.isArray(t.media)?n=[].concat(e(n),e(t.media)):n.push(t.media),(n=y(n,"src")).length>ge)return void(Me&&Me())}else n=n.filter((function(e,n){return t.deleteIndex!==n}));return n}),[at.media,ge]),mt=m((function(t){var n=t.textUrls,a=t.mediaUrls,r=/\.(jpg|jpeg|png|gif|bmp|tiff|webp|avif)(\?.*)?$/i,i=[].concat(e(n),e(a.map((function(e){return e.src})))).reduce((function(e,t){var n="etc";return r.test(t)?n="image":N(t)?n="youtube":U(t)&&(n="twitch"),e[n]||(e[n]=[]),e[n].push(t),e}),{}),o=i.image,l=void 0===o?[]:o,s=i.youtube,c=void 0===s?[]:s,m=i.twitch,u=void 0===m?[]:m,d=it({newImage:[].concat(e(a.filter((function(e){return"img"===e.tag}))),e(l.map((function(e){return{src:e}}))))}),f=ct({media:[].concat(e(c.map((function(e){return{type:"youtube",src:I(e)}}))),e(u.map((function(e){return{type:"twitch",src:w(e)}}))))});return Ge(f),Be(d),Ce&&Ce(f,G),Ee&&Ee(d,G),n.map((function(e){return'<a href="'.concat(e.startsWith("http")?e:"https://".concat(e),'" target="_blank">').concat(e,"</a>")}))}),[G,at,Ee,Ce,it,ct]),ut=m((function(e){return r(void 0,void 0,void 0,n.mark((function t(){var a,r,i;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==(a=e.clipboardData.items[0]).type.indexOf("image")){t.next=7;break}return r=a.getAsFile(),t.next=5,E(r);case 5:i=t.sent,it({newImage:{file:r,src:i}});case 7:case"end":return t.stop()}}),t)})))}),[it]),dt=m((function(e){var t=P(e);We(t),ye&&ye(t,G)}),[G,ye]);return u((function(){Ge(q)}),[JSON.stringify(q)]),u((function(){Be(R)}),[JSON.stringify(R)]),u((function(){Ye(H)}),[JSON.stringify(H)]),u((function(){if(B&&!ze){var e=O(B);We(e)}}),[B,ze]),d(f,(function(){var e=Te.current.setData;return Te.current.setData=function(t){var n=O(t);e(n)},Te.current})),i.createElement("div",{className:J($,"feed-detail-editor")},i.createElement("div",{className:J("feed-detail-editor-header",{"exist-user-click-event":!!Ue})},i.createElement(L,{src:Z,size:"custom",className:J("avatar","user-img"),onClick:Ue}),i.createElement("div",{className:J("profile-info")},i.createElement("strong",{className:J("user-name"),onClick:Ue},Y||"-"),i.createElement("div",{className:J("btn-post-popover")},X?i.createElement(V,{anchorId:Ne?"":"post-category",id:"post-category",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:be,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!be&&!Ne},onClick:Ne},i.createElement("span",{className:J("selected-channel")},ne||"-"," ",be||Ne?i.createElement(S,null):i.createElement(i.Fragment,null))):i.createElement(V,{anchorId:we?"":"post-channel",id:"post-channel",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:ve,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!ve&&!we},onClick:we},i.createElement("span",{className:J("selected-channel")},!!te&&i.createElement(L,{src:te,size:"custom",className:J("avatar")}),ee||"내 채널에 포스트",ve||we?i.createElement(S,null):i.createElement(i.Fragment,null)))))),i.createElement("div",{className:J("feed-detail-editor-body")},i.createElement(g,Object.assign({className:J("editor","post-content",{filled:ze.length}),ref:Te,plugin:[p,v,h,b,A],initialValue:ze,placeholder:se,maxLength:oe},Se,{config:Object.assign(Object.assign({},me),{pasteToPlainText:{onMatchUrlReplace:mt},autoUrlMatch:{onMatchUrl:function(e){return mt({textUrls:[e],mediaUrls:[]})},onChangeMatchUrls:function(e){var t=/\.(jpg|jpeg|png|gif|bmp|webp|tiff|avif)$/i,n=e.filter((function(e){return!t.test(e)&&!N(e)&&!U(e)}));nt(tt.filter((function(e){return n.includes(e)})));var a=n.filter((function(e){return!tt.includes(e)}));tt.includes(a[0])||Ie&&Ie(a[0])}},countTextLength:{hideUi:!0,onChangeTextLength:Fe}}),onDragOver:ot,onDrop:lt,onPaste:ut,handleChange:dt})),at.images.length>0&&i.createElement(j,{images:at.images,handleDeleteImg:function(e){var t=e.deleteIndex,n=it({deleteIndex:t});Be(n),Ee&&Ee(n)}}),at.media.length>0&&i.createElement(k,{media:at.media,handleDeleteIframe:function(e){var t=e.deleteIndex,n=ct({deleteIndex:t});Ge(n),Ce&&Ce(n)}}),!!Xe&&i.createElement(M,{ogMetaData:Xe,handleDeleteOgMetaData:function(t){var n=t.urls;Ye(void 0),Ie&&Ie(void 0),nt((function(t){return e(new Set([].concat(e(t),e((null!=n?n:[]).map((function(e){return e.endsWith("/")?e.slice(0,-1):e}))))))}))}})),i.createElement("div",{className:J("control-box")},i.createElement("div",{className:J("left")},i.createElement("label",{className:J("btn-img-upload")},i.createElement("input",{ref:Ae,type:"file",accept:"image/png, image/gif, image/jpeg, image/jpg, image/webp, image/bmp, image/tiff",onChange:st}),i.createElement(T,null))),i.createElement("div",{className:J("right")},i.createElement("span",{className:J("text-count")},i.createElement("b",null,F(Pe))," / ",F(oe)),i.createElement("button",{className:J("btn-submit",{loading:rt.loading}),disabled:rt.disalbed,onClick:function(){return je(Object.assign(Object.assign({},at),{textValue:P(at.textValue)}),G)}},i.createElement("span",{className:J("text")},re),xe?i.createElement("span",{className:J("spinner")},i.createElement(z,{size:20})):i.createElement(i.Fragment,null)))))}));$.displayName="FeedDetailEditor";var B=$;export{B as default};
