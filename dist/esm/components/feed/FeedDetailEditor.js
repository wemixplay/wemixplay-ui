"use client";
import{__rest as e,__awaiter as t}from"../../_virtual/_tslib.js";import a,{forwardRef as n,useRef as l,useState as i,useMemo as r,useCallback as s,useEffect as o,useImperativeHandle as m}from"react";import c from"./FeedDetailEditor.module.scss.js";import d from"../editor/WpEditor.js";import g from"../../plugins/mention/Mention.js";import p from"../../plugins/hashTag/HashTag.js";import u from"../../plugins/autoUrlMatch/AutoUrlMatch.js";import f from"../../plugins/pasteToPlainText/PasteToPlainText.js";import{makeCxFunc as h}from"../../utils/forReactUtils.js";import v from'./../../ext/lodash/uniqBy.js';import x from'./../../ext/lodash/merge.js';import{readAsDataURLAsync as E,imageFileUpload as b}from"../../utils/fileUtils.js";import C from"./FeedImagesView.js";import{convertIframeYouTubeURL as y,convertIframeTwitchURL as j,isYouTubeURL as I,isTwitchURL as N}from"../../utils/urlUtils.js";import w from"./FeedIframesView.js";import U from"./FeedLinkPreview.js";import M from"../../assets/svgs/ico-chevron-down.svg.js";import D from"../../assets/svgs/ico-image.svg.js";import S from"../../plugins/countTextLength/CountTextLength.js";import{convertMarkdownToHtmlStr as T,removeSpaceAndLineBreak as k,convertHtmlToMarkdownStr as O,commaWithValue as P}from"../../utils/valueParserUtils.js";import A from"../avatars/Person.js";import F from"../popover/PopoverButton.js";import L from"../loadings/Spinner.js";const V=h(c),z=n(((n,c)=>{var h,{className:z="",textValue:W,images:_,media:J,ogMetaData:B,name:R,minLength:$=10,isOfficial:q,writerName:H,writerImg:G,channelName:K,channelImg:Q,categoryName:X,btnSubmitText:Y="POST",maxLength:Z=1e3,placeholder:ee="What is happening?!",config:te={},imageMaxCnt:ae=4,iframeMaxCnt:ne=4,selectChannelPopoverElement:le=a.createElement(a.Fragment,null),selectCategoryPopoverElement:ie=a.createElement(a.Fragment,null),loading:re,isSubmitDisabled:se=!1,handleTextChange:oe,handleImageChange:me,handleMediaChange:ce,handleSubmit:de,handleExternalUrlChange:ge,onSelectChannelClick:pe,onSelectCategoryClick:ue,onUserClick:fe,onMaxImageUploads:he,onMaxIframeUploads:ve}=n,xe=e(n,["className","textValue","images","media","ogMetaData","name","minLength","isOfficial","writerName","writerImg","channelName","channelImg","categoryName","btnSubmitText","maxLength","placeholder","config","imageMaxCnt","iframeMaxCnt","selectChannelPopoverElement","selectCategoryPopoverElement","loading","isSubmitDisabled","handleTextChange","handleImageChange","handleMediaChange","handleSubmit","handleExternalUrlChange","onSelectChannelClick","onSelectCategoryClick","onUserClick","onMaxImageUploads","onMaxIframeUploads"]);const Ee=l(),be=l(),[Ce,ye]=i(null!==(h=null==W?void 0:W.length)&&void 0!==h?h:0),[je,Ie]=i(T(null!=W?W:"")),[Ne,we]=i(_),[Ue,Me]=i(J),[De,Se]=i(B),[Te,ke]=i([]),Oe=r((()=>Object.assign(Object.assign({},Ue),{textValue:je,images:v(Ne,"src"),media:v(Ue,"src")})),[je,Ne,Ue]),Pe=r((()=>{var e,t,a;const n=!!k(Oe.textValue),l=!!(null!==(e=Oe.images)&&void 0!==e?e:[]).length,i=!!(null!==(t=Oe.media)&&void 0!==t?t:[]).length,r=(null!==(a=Oe.images)&&void 0!==a?a:[]).some((e=>!!e.loading));return{loading:re||r,disabled:$>Ce||re||r||!i&&!l&&!n||se}}),[re,$,Ce,Oe]),Ae=s((e=>{var t;let a=[...null!==(t=null==Oe?void 0:Oe.images)&&void 0!==t?t:[]];if("newImage"in e){if(Array.isArray(e.newImage)&&a.length<ae)a=[...a,...e.newImage.slice(0,ae-a.length)];else if(!Array.isArray(e.newImage)){if(a.length>=ae)return he?he():alert("이미지는 최대 ".concat(ae,"까지 업로드가 가능합니다.")),a;a.push(e.newImage)}a=v(a,"src")}else a=a.filter(((t,a)=>e.deleteIndex!==a));return be.current.value="",a}),[Oe,R,ae,he]),Fe=s((e=>{e.preventDefault()}),[]),Le=s((e=>t(void 0,void 0,void 0,(function*(){var t;e.preventDefault();const a=Array.from(e.dataTransfer.files).filter((e=>e.type.startsWith("image/")));if(0===a.length)return;const n=[...null!==(t=null==Oe?void 0:Oe.images)&&void 0!==t?t:[]];for(const e of a){const t=yield E(e);n.push({file:e,src:t})}const l=Ae({newImage:n});we(l),me&&me(l,R)}))),[R,Oe,Ae,me]),Ve=s((e=>t(void 0,void 0,void 0,(function*(){const{file:t,dataUrl:a}=yield b(e),n=Ae({newImage:{file:t,src:a}});we(n),me&&me(n,R)}))),[R,Oe,Ae,me]),ze=s((e=>{let t=[...Oe.media];if("media"in e){if(t.length>=ne)return ve&&ve(),t;if(Array.isArray(e.media)?t=[...t,...e.media]:t.push(e.media),t=v(t,"src"),t.length>ne)return void(ve&&ve())}else t=t.filter(((t,a)=>e.deleteIndex!==a));return t}),[Oe.media,ne]),We=s((e=>{let{textUrls:t,mediaUrls:a}=e;const n=/\.(jpg|jpeg|png|gif|bmp|tiff|webp|avif)(\?.*)?$/i,l=[...t,...a.map((e=>e.src))].reduce(((e,t)=>{let a="etc";return n.test(t)?a="image":I(t)?a="youtube":N(t)&&(a="twitch"),e[a]||(e[a]=[]),e[a].push(t),e}),{}),{image:i=[],youtube:r=[],twitch:s=[],etc:o=[]}=l,m=Ae({newImage:[...a.filter((e=>"img"===e.tag)),...i.map((e=>({src:e})))]}),c=ze({media:[...r.map((e=>({type:"youtube",src:y(e)}))),...s.map((e=>({type:"twitch",src:j(e)})))]});return Me(c),we(m),ce&&ce(c,R),me&&me(m,R),t.map((e=>'<a href="'.concat(e.startsWith("http")?e:"https://".concat(e),'" target="_blank">').concat(e,"</a>")))}),[R,Oe,me,ce,Ae,ze]),_e=s((e=>t(void 0,void 0,void 0,(function*(){const t=e.clipboardData.items[0];if(0===t.type.indexOf("image")){const e=t.getAsFile(),a=yield E(e);Ae({newImage:{file:e,src:a}})}}))),[Ae]),Je=s((e=>{const t=O(e);Ie(t),oe&&oe(t,R)}),[R,oe]);return o((()=>{Me(J)}),[JSON.stringify(J)]),o((()=>{we(_)}),[JSON.stringify(_)]),o((()=>{Se(B)}),[JSON.stringify(B)]),o((()=>{if(W&&!je){const e=T(W);Ie(e)}}),[W,je]),m(c,(()=>{const{setData:e}=Ee.current;return Ee.current.setData=t=>{const a=T(t);e(a)},Ee.current})),a.createElement("div",{className:V(z,"feed-detail-editor")},a.createElement("div",{className:V("feed-detail-editor-header",{"exist-user-click-event":!!fe})},a.createElement(A,{src:G,size:"custom",className:V("avatar","user-img"),onClick:fe}),a.createElement("div",{className:V("profile-info")},a.createElement("strong",{className:V("user-name"),onClick:fe},H||"-"),a.createElement("div",{className:V("btn-post-popover")},q?a.createElement(F,{anchorId:ue?"":"post-category",id:"post-category",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:ie,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!ie&&!ue},onClick:ue},a.createElement("span",{className:V("selected-channel")},X||"-"," ",ie||ue?a.createElement(M,null):a.createElement(a.Fragment,null))):a.createElement(F,{anchorId:pe?"":"post-channel",id:"post-channel",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:le,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!le&&!pe},onClick:pe},a.createElement("span",{className:V("selected-channel")},!!Q&&a.createElement(A,{src:Q,size:"custom",className:V("avatar")}),K||"내 채널에 포스트",le||pe?a.createElement(M,null):a.createElement(a.Fragment,null)))))),a.createElement("div",{className:V("feed-detail-editor-body")},a.createElement(d,Object.assign({className:V("editor","post-content",{filled:je.length}),ref:Ee,plugin:[g,p,u,f,S],initialValue:je,placeholder:ee,maxLength:Z},xe,{config:x({pasteToPlainText:{onMatchUrlReplace:We},autoUrlMatch:{onMatchUrl:e=>We({textUrls:[e],mediaUrls:[]}),onChangeMatchUrls:e=>{const t=/\.(jpg|jpeg|png|gif|bmp|webp|tiff|avif)$/i,a=e.filter((e=>!t.test(e)&&!I(e)&&!N(e)));ke(Te.filter((e=>a.includes(e))));const n=a.filter((e=>!Te.includes(e)));Te.includes(n[0])||ge&&ge(n[0])}},countTextLength:{hideUi:!0,onChangeTextLength:ye}},te),onDragOver:Fe,onDrop:Le,onPaste:_e,handleChange:Je})),Oe.images.length>0&&a.createElement(C,{images:Oe.images,handleDeleteImg:e=>{let{deleteIndex:t}=e;const a=Ae({deleteIndex:t});we(a),me&&me(a)}}),Oe.media.length>0&&a.createElement(w,{media:Oe.media,handleDeleteIframe:e=>{let{deleteIndex:t}=e;const a=ze({deleteIndex:t});Me(a),ce&&ce(a)}}),!!De&&a.createElement(U,{ogMetaData:De,handleDeleteOgMetaData:e=>{let{urls:t}=e;Se(void 0),ge&&ge(void 0),ke((e=>[...new Set([...e,...(null!=t?t:[]).map((e=>e.endsWith("/")?e.slice(0,-1):e))])]))}})),a.createElement("div",{className:V("control-box")},a.createElement("div",{className:V("left")},a.createElement("label",{className:V("btn-img-upload")},a.createElement("input",{ref:be,type:"file",accept:"image/png, image/gif, image/jpeg, image/jpg, image/webp, image/bmp, image/tiff",onChange:Ve}),a.createElement(D,null))),a.createElement("div",{className:V("right")},a.createElement("span",{className:V("text-count")},a.createElement("b",null,P(Ce))," / ",P(Z)),a.createElement("button",{className:V("btn-submit",{loading:Pe.loading}),disabled:Pe.disabled,onClick:()=>de(Object.assign(Object.assign({},Oe),{textValue:O(Oe.textValue)}),R)},a.createElement("span",{className:V("text")},Y),re?a.createElement("span",{className:V("spinner")},a.createElement(L,{size:20})):a.createElement(a.Fragment,null)))))}));z.displayName="FeedDetailEditor";var W=z;export{W as default};
