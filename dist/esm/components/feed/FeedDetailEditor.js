"use client";
import{__rest as e,__awaiter as t}from"../../_virtual/_tslib.js";import a,{forwardRef as n,useRef as l,useState as i,useMemo as r,useCallback as s,useEffect as o,useImperativeHandle as m}from"react";import c from"./FeedDetailEditor.module.scss.js";import d from"../editor/WpEditor.js";import g from"../../plugins/mention/Mention.js";import p from"../../plugins/hashTag/HashTag.js";import u from"../../plugins/autoUrlMatch/AutoUrlMatch.js";import f from"../../plugins/pasteToPlainText/PasteToPlainText.js";import{makeCxFunc as h}from"../../utils/forReactUtils.js";import v from'./../../ext/lodash/uniqBy.js';import{readAsDataURLAsync as x,imageFileUpload as E}from"../../utils/fileUtils.js";import b from"./FeedImagesView.js";import{convertIframeYouTubeURL as C,convertIframeTwitchURL as j,isYouTubeURL as y,isTwitchURL as I}from"../../utils/urlUtils.js";import N from"./FeedIframesView.js";import w from"./FeedLinkPreview.js";import U from"../../assets/svgs/ico-chevron-down.svg.js";import M from"../../assets/svgs/ico-image.svg.js";import T from"../../plugins/countTextLength/CountTextLength.js";import{convertMarkdownToHtmlStr as D,removeSpaceAndLineBreak as O,convertHtmlToMarkdownStr as S,commaWithValue as k}from"../../utils/valueParserUtils.js";import P from"../avatars/Person.js";import A from"../popover/PopoverButton.js";import F from"../loadings/Spinner.js";const L=h(c),V=n(((n,c)=>{var h,{className:V="",textValue:z,images:W,media:_,ogMetaData:J,name:B,minLength:R=10,isOfficial:$,writerName:q,writerImg:H,channelName:G,channelImg:K,categoryName:Q,btnSubmitText:X="POST",maxLength:Y=1e3,placeholder:Z="What is happening?!",config:ee={},imageMaxCnt:te=4,iframeMaxCnt:ae=4,selectChannelPopoverElement:ne=a.createElement(a.Fragment,null),selectCategoryPopoverElement:le=a.createElement(a.Fragment,null),loading:ie,handleTextChange:re,handleImageChange:se,handleMediaChange:oe,handleSubmit:me,handleExternalUrlChange:ce,onSelectChannelClick:de,onSelectCategoryClick:ge,onUserClick:pe,onMaxImageUploads:ue,onMaxIframeUploads:fe}=n,he=e(n,["className","textValue","images","media","ogMetaData","name","minLength","isOfficial","writerName","writerImg","channelName","channelImg","categoryName","btnSubmitText","maxLength","placeholder","config","imageMaxCnt","iframeMaxCnt","selectChannelPopoverElement","selectCategoryPopoverElement","loading","handleTextChange","handleImageChange","handleMediaChange","handleSubmit","handleExternalUrlChange","onSelectChannelClick","onSelectCategoryClick","onUserClick","onMaxImageUploads","onMaxIframeUploads"]);const ve=l(),xe=l(),[Ee,be]=i(null!==(h=null==z?void 0:z.length)&&void 0!==h?h:0),[Ce,je]=i(D(null!=z?z:"")),[ye,Ie]=i(W),[Ne,we]=i(_),[Ue,Me]=i(J),[Te,De]=i([]),Oe=r((()=>Object.assign(Object.assign({},Ne),{textValue:Ce,images:v(ye,"src"),media:v(Ne,"src")})),[Ce,ye,Ne]),Se=r((()=>{var e,t,a;const n=!!O(Oe.textValue),l=!!(null!==(e=Oe.images)&&void 0!==e?e:[]).length,i=!!(null!==(t=Oe.media)&&void 0!==t?t:[]).length,r=(null!==(a=Oe.images)&&void 0!==a?a:[]).some((e=>!!e.loading));return{loading:ie||r,disalbed:R>Ee||ie||r||!i&&!l&&!n}}),[ie,R,Ee,Oe]),ke=s((e=>{var t;let a=[...null!==(t=null==Oe?void 0:Oe.images)&&void 0!==t?t:[]];if("newImage"in e){if(Array.isArray(e.newImage)&&a.length<te)a=[...a,...e.newImage.slice(0,te-a.length)];else if(!Array.isArray(e.newImage)){if(a.length>=te)return ue?ue():alert("이미지는 최대 ".concat(te,"까지 업로드가 가능합니다.")),a;a.push(e.newImage)}a=v(a,"src")}else a=a.filter(((t,a)=>e.deleteIndex!==a));return xe.current.value="",a}),[Oe,B,te,ue]),Pe=s((e=>{e.preventDefault()}),[]),Ae=s((e=>t(void 0,void 0,void 0,(function*(){var t;e.preventDefault();const a=Array.from(e.dataTransfer.files).filter((e=>e.type.startsWith("image/")));if(0===a.length)return;const n=[...null!==(t=null==Oe?void 0:Oe.images)&&void 0!==t?t:[]];for(const e of a){const t=yield x(e);n.push({file:e,src:t})}const l=ke({newImage:n});Ie(l),se&&se(l,B)}))),[B,Oe,ke,se]),Fe=s((e=>t(void 0,void 0,void 0,(function*(){const{file:t,dataUrl:a}=yield E(e),n=ke({newImage:{file:t,src:a}});Ie(n),se&&se(n,B)}))),[B,Oe,ke,se]),Le=s((e=>{let t=[...Oe.media];if("media"in e){if(t.length>=ae)return fe&&fe(),t;if(Array.isArray(e.media)?t=[...t,...e.media]:t.push(e.media),t=v(t,"src"),t.length>ae)return void(fe&&fe())}else t=t.filter(((t,a)=>e.deleteIndex!==a));return t}),[Oe.media,ae]),Ve=s((e=>{let{textUrls:t,mediaUrls:a}=e;const n=/\.(jpg|jpeg|png|gif|bmp|tiff|webp|avif)(\?.*)?$/i,l=[...t,...a.map((e=>e.src))].reduce(((e,t)=>{let a="etc";return n.test(t)?a="image":y(t)?a="youtube":I(t)&&(a="twitch"),e[a]||(e[a]=[]),e[a].push(t),e}),{}),{image:i=[],youtube:r=[],twitch:s=[],etc:o=[]}=l,m=ke({newImage:[...a.filter((e=>"img"===e.tag)),...i.map((e=>({src:e})))]}),c=Le({media:[...r.map((e=>({type:"youtube",src:C(e)}))),...s.map((e=>({type:"twitch",src:j(e)})))]});return we(c),Ie(m),oe&&oe(c,B),se&&se(m,B),t.map((e=>'<a href="'.concat(e.startsWith("http")?e:"https://".concat(e),'" target="_blank">').concat(e,"</a>")))}),[B,Oe,se,oe,ke,Le]),ze=s((e=>t(void 0,void 0,void 0,(function*(){const t=e.clipboardData.items[0];if(0===t.type.indexOf("image")){const e=t.getAsFile(),a=yield x(e);ke({newImage:{file:e,src:a}})}}))),[ke]),We=s((e=>{const t=S(e);je(t),re&&re(t,B)}),[B,re]);return o((()=>{we(_)}),[JSON.stringify(_)]),o((()=>{Ie(W)}),[JSON.stringify(W)]),o((()=>{Me(J)}),[JSON.stringify(J)]),o((()=>{if(z&&!Ce){const e=D(z);je(e)}}),[z,Ce]),m(c,(()=>{const{setData:e}=ve.current;return ve.current.setData=t=>{const a=D(t);e(a)},ve.current})),a.createElement("div",{className:L(V,"feed-detail-editor")},a.createElement("div",{className:L("feed-detail-editor-header",{"exist-user-click-event":!!pe})},a.createElement(P,{src:H,size:"custom",className:L("avatar","user-img"),onClick:pe}),a.createElement("div",{className:L("profile-info")},a.createElement("strong",{className:L("user-name"),onClick:pe},q||"-"),a.createElement("div",{className:L("btn-post-popover")},$?a.createElement(A,{anchorId:ge?"":"post-category",id:"post-category",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:le,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!le&&!ge},onClick:ge},a.createElement("span",{className:L("selected-channel")},Q||"-"," ",le||ge?a.createElement(U,null):a.createElement(a.Fragment,null))):a.createElement(A,{anchorId:de?"":"post-channel",id:"post-channel",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:ne,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!ne&&!de},onClick:de},a.createElement("span",{className:L("selected-channel")},!!K&&a.createElement(P,{src:K,size:"custom",className:L("avatar")}),G||"내 채널에 포스트",ne||de?a.createElement(U,null):a.createElement(a.Fragment,null)))))),a.createElement("div",{className:L("feed-detail-editor-body")},a.createElement(d,Object.assign({className:L("editor","post-content",{filled:Ce.length}),ref:ve,plugin:[g,p,u,f,T],initialValue:Ce,placeholder:Z,maxLength:Y},he,{config:Object.assign(Object.assign({},ee),{pasteToPlainText:{onMatchUrlReplace:Ve},autoUrlMatch:{onMatchUrl:e=>Ve({textUrls:[e],mediaUrls:[]}),onChangeMatchUrls:e=>{const t=/\.(jpg|jpeg|png|gif|bmp|webp|tiff|avif)$/i,a=e.filter((e=>!t.test(e)&&!y(e)&&!I(e)));De(Te.filter((e=>a.includes(e))));const n=a.filter((e=>!Te.includes(e)));Te.includes(n[0])||ce&&ce(n[0])}},countTextLength:{hideUi:!0,onChangeTextLength:be}}),onDragOver:Pe,onDrop:Ae,onPaste:ze,handleChange:We})),Oe.images.length>0&&a.createElement(b,{images:Oe.images,handleDeleteImg:e=>{let{deleteIndex:t}=e;const a=ke({deleteIndex:t});Ie(a),se&&se(a)}}),Oe.media.length>0&&a.createElement(N,{media:Oe.media,handleDeleteIframe:e=>{let{deleteIndex:t}=e;const a=Le({deleteIndex:t});we(a),oe&&oe(a)}}),!!Ue&&a.createElement(w,{ogMetaData:Ue,handleDeleteOgMetaData:e=>{let{urls:t}=e;Me(void 0),ce&&ce(void 0),De((e=>[...new Set([...e,...(null!=t?t:[]).map((e=>e.endsWith("/")?e.slice(0,-1):e))])]))}})),a.createElement("div",{className:L("control-box")},a.createElement("div",{className:L("left")},a.createElement("label",{className:L("btn-img-upload")},a.createElement("input",{ref:xe,type:"file",accept:"image/png, image/gif, image/jpeg, image/jpg, image/webp, image/bmp, image/tiff",onChange:Fe}),a.createElement(M,null))),a.createElement("div",{className:L("right")},a.createElement("span",{className:L("text-count")},a.createElement("b",null,k(Ee))," / ",k(Y)),a.createElement("button",{className:L("btn-submit",{loading:Se.loading}),disabled:Se.disalbed,onClick:()=>me(Object.assign(Object.assign({},Oe),{textValue:S(Oe.textValue)}),B)},a.createElement("span",{className:L("text")},X),ie?a.createElement("span",{className:L("spinner")},a.createElement(F,{size:20})):a.createElement(a.Fragment,null)))))}));V.displayName="FeedDetailEditor";var z=V;export{z as default};
