"use client";
import{__rest as e,__awaiter as t}from"../../_virtual/_tslib.js";import a,{forwardRef as n,useRef as l,useState as i,useMemo as r,useCallback as s,useEffect as o,useImperativeHandle as m}from"react";import c from"./FeedDetailEditor.module.scss.js";import d from"../editor/WpEditor.js";import g from"../../plugins/mention/Mention.js";import p from"../../plugins/hashTag/HashTag.js";import u from"../../plugins/autoUrlMatch/AutoUrlMatch.js";import f from"../../plugins/pasteToPlainText/PasteToPlainText.js";import{makeCxFunc as h}from"../../utils/forReactUtils.js";import v from'./../../ext/lodash/uniqBy.js';import E from'./../../ext/lodash/merge.js';import{readAsDataURLAsync as x,imageFileUpload as b}from"../../utils/fileUtils.js";import C from"./FeedImagesView.js";import{convertIframeYouTubeURL as j,convertIframeTwitchURL as y,isYouTubeURL as I,isTwitchURL as N}from"../../utils/urlUtils.js";import w from"./FeedIframesView.js";import U from"./FeedLinkPreview.js";import M from"../../assets/svgs/icon-chevron-down.svg.js";import D from"../../assets/svgs/icon-image.svg.js";import S from"../../assets/svgs/icon-post.svg.js";import T from"../../plugins/countTextLength/CountTextLength.js";import{convertMarkdownToHtmlStr as k,removeSpaceAndLineBreak as O,convertHtmlToMarkdownStr as P,commaWithValue as A}from"../../utils/valueParserUtils.js";import F from"../avatars/Person.js";import L from"../popover/PopoverButton.js";import V from"../loadings/Spinner.js";const z=h(c),W=n(((n,c)=>{var h,{className:W="",textValue:_,images:J,media:B,ogMetaData:R,name:$,minLength:q=10,isOfficial:H,writerName:G,writerImg:K,channelName:Q,channelImg:X,categoryName:Y,btnSubmitText:Z="POST",maxLength:ee=1e3,placeholder:te="What is happening?!",config:ae={},imageMaxCnt:ne=4,iframeMaxCnt:le=4,selectChannelPopoverElement:ie=a.createElement(a.Fragment,null),selectCategoryPopoverElement:re=a.createElement(a.Fragment,null),loading:se,isSubmitDisabled:oe=!1,handleTextChange:me,handleImageChange:ce,handleMediaChange:de,handleSubmit:ge,handleExternalUrlChange:pe,onSelectChannelClick:ue,onSelectCategoryClick:fe,onUserClick:he,onMaxImageUploads:ve,onMaxIframeUploads:Ee}=n,xe=e(n,["className","textValue","images","media","ogMetaData","name","minLength","isOfficial","writerName","writerImg","channelName","channelImg","categoryName","btnSubmitText","maxLength","placeholder","config","imageMaxCnt","iframeMaxCnt","selectChannelPopoverElement","selectCategoryPopoverElement","loading","isSubmitDisabled","handleTextChange","handleImageChange","handleMediaChange","handleSubmit","handleExternalUrlChange","onSelectChannelClick","onSelectCategoryClick","onUserClick","onMaxImageUploads","onMaxIframeUploads"]);const be=l(),Ce=l(),[je,ye]=i(null!==(h=null==_?void 0:_.length)&&void 0!==h?h:0),[Ie,Ne]=i(k(null!=_?_:"")),[we,Ue]=i(J),[Me,De]=i(B),[Se,Te]=i(R),[ke,Oe]=i([]),Pe=r((()=>Object.assign(Object.assign({},Me),{textValue:Ie,images:v(we,"src"),media:v(Me,"src")})),[Ie,we,Me]),Ae=r((()=>{var e,t,a;const n=!!O(Pe.textValue),l=!!(null!==(e=Pe.images)&&void 0!==e?e:[]).length,i=!!(null!==(t=Pe.media)&&void 0!==t?t:[]).length,r=(null!==(a=Pe.images)&&void 0!==a?a:[]).some((e=>!!e.loading));return{loading:se||r,disabled:q>je||se||r||!i&&!l&&!n||oe}}),[se,q,je,Pe]),Fe=s((e=>{var t;let a=[...null!==(t=null==Pe?void 0:Pe.images)&&void 0!==t?t:[]];if("newImage"in e){if(Array.isArray(e.newImage)&&a.length<ne)a=[...a,...e.newImage.slice(0,ne-a.length)];else if(!Array.isArray(e.newImage)){if(a.length>=ne)return ve?ve():alert("이미지는 최대 ".concat(ne,"까지 업로드가 가능합니다.")),a;a.push(e.newImage)}a=v(a,"src")}else a=a.filter(((t,a)=>e.deleteIndex!==a));return Ce.current.value="",a}),[Pe,$,ne,ve]),Le=s((e=>{e.preventDefault()}),[]),Ve=s((e=>t(void 0,void 0,void 0,(function*(){var t;e.preventDefault();const a=Array.from(e.dataTransfer.files).filter((e=>e.type.startsWith("image/")));if(0===a.length)return;const n=[...null!==(t=null==Pe?void 0:Pe.images)&&void 0!==t?t:[]];for(const e of a){const t=yield x(e);n.push({file:e,src:t})}const l=Fe({newImage:n});Ue(l),ce&&ce(l,$)}))),[$,Pe,Fe,ce]),ze=s((e=>t(void 0,void 0,void 0,(function*(){const{file:t,dataUrl:a}=yield b(e),n=Fe({newImage:{file:t,src:a}});Ue(n),ce&&ce(n,$)}))),[$,Pe,Fe,ce]),We=s((e=>{let t=[...Pe.media];if("media"in e){if(t.length>=le)return Ee&&Ee(),t;if(Array.isArray(e.media)?t=[...t,...e.media]:t.push(e.media),t=v(t,"src"),t.length>le)return void(Ee&&Ee())}else t=t.filter(((t,a)=>e.deleteIndex!==a));return t}),[Pe.media,le]),_e=s((e=>{let{textUrls:t,mediaUrls:a}=e;const n=/\.(jpg|jpeg|png|gif|bmp|tiff|webp|avif)(\?.*)?$/i,l=[...t,...a.map((e=>e.src))].reduce(((e,t)=>{let a="etc";return n.test(t)?a="image":I(t)?a="youtube":N(t)&&(a="twitch"),e[a]||(e[a]=[]),e[a].push(t),e}),{}),{image:i=[],youtube:r=[],twitch:s=[],etc:o=[]}=l,m=Fe({newImage:[...a.filter((e=>"img"===e.tag)),...i.map((e=>({src:e})))]}),c=We({media:[...r.map((e=>({type:"youtube",src:j(e)}))),...s.map((e=>({type:"twitch",src:y(e)})))]});return De(c),Ue(m),de&&de(c,$),ce&&ce(m,$),t.map((e=>'<a href="'.concat(e.startsWith("http")?e:"https://".concat(e),'" target="_blank">').concat(e,"</a>")))}),[$,Pe,ce,de,Fe,We]),Je=s((e=>t(void 0,void 0,void 0,(function*(){const t=e.clipboardData.items[0];if(0===t.type.indexOf("image")){const e=t.getAsFile(),a=yield x(e);Fe({newImage:{file:e,src:a}})}}))),[Fe]),Be=s((e=>{const t=P(e);Ne(t),me&&me(t,$)}),[$,me]);return o((()=>{De(B)}),[JSON.stringify(B)]),o((()=>{Ue(J)}),[JSON.stringify(J)]),o((()=>{Te(R)}),[JSON.stringify(R)]),o((()=>{if(_&&!Ie){const e=k(_);Ne(e)}}),[_,Ie]),m(c,(()=>{const{setData:e}=be.current;return be.current.setData=t=>{const a=k(t);e(a)},be.current})),a.createElement("div",{className:z(W,"feed-detail-editor")},a.createElement("div",{className:z("feed-detail-editor-header",{"exist-user-click-event":!!he})},a.createElement(F,{src:K,size:"custom",className:z("avatar","user-img"),onClick:he}),a.createElement("div",{className:z("profile-info")},a.createElement("strong",{className:z("user-name"),onClick:he},G||"-"),a.createElement("div",{className:z("btn-post-popover")},H?a.createElement(L,{anchorId:fe?"":"post-category",id:"post-category",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:re,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!re&&!fe},onClick:fe},a.createElement("span",{className:z("selected-channel")},Y||"-"," ",re||fe?a.createElement(M,{width:16,height:16}):a.createElement(a.Fragment,null))):a.createElement(L,{anchorId:ue?"":"post-channel",id:"post-channel",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:ie,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!ie&&!ue},onClick:ue},a.createElement("span",{className:z("selected-channel")},!!X&&a.createElement(F,{src:X,size:"custom",className:z("avatar")}),Q||"내 채널에 포스트",ie||ue?a.createElement(M,{width:16,height:16}):a.createElement(a.Fragment,null)))))),a.createElement("div",{className:z("feed-detail-editor-body")},a.createElement(d,Object.assign({className:z("editor","post-content",{filled:Ie.length}),ref:be,plugin:[g,p,u,f,T],initialValue:Ie,placeholder:te,maxLength:ee},xe,{config:E({pasteToPlainText:{onMatchUrlReplace:_e},autoUrlMatch:{onMatchUrl:e=>_e({textUrls:[e],mediaUrls:[]}),onChangeMatchUrls:e=>{const t=/\.(jpg|jpeg|png|gif|bmp|webp|tiff|avif)$/i,a=e.filter((e=>!t.test(e)&&!I(e)&&!N(e)));Oe(ke.filter((e=>a.includes(e))));const n=a.filter((e=>!ke.includes(e)));ke.includes(n[0])||pe&&pe(n[0])}},countTextLength:{hideUi:!0,onChangeTextLength:ye}},ae),onDragOver:Le,onDrop:Ve,onPaste:Je,handleChange:Be})),Pe.images.length>0&&a.createElement(C,{images:Pe.images,handleDeleteImg:e=>{let{deleteIndex:t}=e;const a=Fe({deleteIndex:t});Ue(a),ce&&ce(a)}}),Pe.media.length>0&&a.createElement(w,{media:Pe.media,handleDeleteIframe:e=>{let{deleteIndex:t}=e;const a=We({deleteIndex:t});De(a),de&&de(a)}}),!!Se&&a.createElement(U,{ogMetaData:Se,handleDeleteOgMetaData:e=>{let{urls:t}=e;Te(void 0),pe&&pe(void 0),Oe((e=>[...new Set([...e,...(null!=t?t:[]).map((e=>e.endsWith("/")?e.slice(0,-1):e))])]))}})),a.createElement("div",{className:z("control-box")},a.createElement("div",{className:z("left")},a.createElement("label",{className:z("btn-img-upload")},a.createElement("input",{ref:Ce,type:"file",accept:"image/png, image/gif, image/jpeg, image/jpg, image/webp, image/bmp, image/tiff",onChange:ze}),a.createElement(D,null))),a.createElement("div",{className:z("right")},a.createElement("span",{className:z("text-count")},a.createElement("b",null,A(je))," / ",A(ee)),a.createElement("button",{className:z("btn-submit",{loading:Ae.loading}),disabled:Ae.disabled,onClick:()=>ge(Object.assign(Object.assign({},Pe),{textValue:P(Pe.textValue)}),$)},a.createElement(S,null),a.createElement("span",{className:z("text")},Z),se?a.createElement("span",{className:z("spinner")},a.createElement(V,{size:20})):a.createElement(a.Fragment,null)))))}));W.displayName="FeedDetailEditor";var _=W;export{_ as default};
