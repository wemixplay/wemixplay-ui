"use client";
import{__rest as e,__awaiter as t}from"../../_virtual/_tslib.js";import a,{forwardRef as n,useRef as l,useState as i,useMemo as r,useCallback as s,useEffect as o,useImperativeHandle as m}from"react";import c from"./FeedDetailEditor.module.scss.js";import d from"../editor/WpEditor.js";import g from"../../plugins/mention/Mention.js";import p from"../../plugins/hashTag/HashTag.js";import u from"../../plugins/autoUrlMatch/AutoUrlMatch.js";import f from"../../plugins/pasteToPlainText/PasteToPlainText.js";import{makeCxFunc as h}from"../../utils/forReactUtils.js";import v from'./../../ext/lodash/uniqBy.js';import x from'./../../ext/lodash/merge.js';import{readAsDataURLAsync as E,imageFileUpload as b}from"../../utils/fileUtils.js";import C from"./FeedImagesView.js";import{convertIframeYouTubeURL as y,convertIframeTwitchURL as j,isYouTubeURL as I,isTwitchURL as N}from"../../utils/urlUtils.js";import w from"./FeedIframesView.js";import U from"./FeedLinkPreview.js";import M from"../../assets/svgs/ico-chevron-down.svg.js";import T from"../../assets/svgs/ico-image.svg.js";import D from"../../plugins/countTextLength/CountTextLength.js";import{convertMarkdownToHtmlStr as S,removeSpaceAndLineBreak as k,convertHtmlToMarkdownStr as O,commaWithValue as P}from"../../utils/valueParserUtils.js";import A from"../avatars/Person.js";import F from"../popover/PopoverButton.js";import L from"../loadings/Spinner.js";const V=h(c),z=n(((n,c)=>{var h,{className:z="",textValue:W,images:_,media:J,ogMetaData:B,name:R,minLength:$=10,isOfficial:q,writerName:H,writerImg:G,channelName:K,channelImg:Q,categoryName:X,btnSubmitText:Y="POST",maxLength:Z=1e3,placeholder:ee="What is happening?!",config:te={},imageMaxCnt:ae=4,iframeMaxCnt:ne=4,selectChannelPopoverElement:le=a.createElement(a.Fragment,null),selectCategoryPopoverElement:ie=a.createElement(a.Fragment,null),loading:re,handleTextChange:se,handleImageChange:oe,handleMediaChange:me,handleSubmit:ce,handleExternalUrlChange:de,onSelectChannelClick:ge,onSelectCategoryClick:pe,onUserClick:ue,onMaxImageUploads:fe,onMaxIframeUploads:he}=n,ve=e(n,["className","textValue","images","media","ogMetaData","name","minLength","isOfficial","writerName","writerImg","channelName","channelImg","categoryName","btnSubmitText","maxLength","placeholder","config","imageMaxCnt","iframeMaxCnt","selectChannelPopoverElement","selectCategoryPopoverElement","loading","handleTextChange","handleImageChange","handleMediaChange","handleSubmit","handleExternalUrlChange","onSelectChannelClick","onSelectCategoryClick","onUserClick","onMaxImageUploads","onMaxIframeUploads"]);const xe=l(),Ee=l(),[be,Ce]=i(null!==(h=null==W?void 0:W.length)&&void 0!==h?h:0),[ye,je]=i(S(null!=W?W:"")),[Ie,Ne]=i(_),[we,Ue]=i(J),[Me,Te]=i(B),[De,Se]=i([]),ke=r((()=>Object.assign(Object.assign({},we),{textValue:ye,images:v(Ie,"src"),media:v(we,"src")})),[ye,Ie,we]),Oe=r((()=>{var e,t,a;const n=!!k(ke.textValue),l=!!(null!==(e=ke.images)&&void 0!==e?e:[]).length,i=!!(null!==(t=ke.media)&&void 0!==t?t:[]).length,r=(null!==(a=ke.images)&&void 0!==a?a:[]).some((e=>!!e.loading));return{loading:re||r,disalbed:$>be||re||r||!i&&!l&&!n}}),[re,$,be,ke]),Pe=s((e=>{var t;let a=[...null!==(t=null==ke?void 0:ke.images)&&void 0!==t?t:[]];if("newImage"in e){if(Array.isArray(e.newImage)&&a.length<ae)a=[...a,...e.newImage.slice(0,ae-a.length)];else if(!Array.isArray(e.newImage)){if(a.length>=ae)return fe?fe():alert("이미지는 최대 ".concat(ae,"까지 업로드가 가능합니다.")),a;a.push(e.newImage)}a=v(a,"src")}else a=a.filter(((t,a)=>e.deleteIndex!==a));return Ee.current.value="",a}),[ke,R,ae,fe]),Ae=s((e=>{e.preventDefault()}),[]),Fe=s((e=>t(void 0,void 0,void 0,(function*(){var t;e.preventDefault();const a=Array.from(e.dataTransfer.files).filter((e=>e.type.startsWith("image/")));if(0===a.length)return;const n=[...null!==(t=null==ke?void 0:ke.images)&&void 0!==t?t:[]];for(const e of a){const t=yield E(e);n.push({file:e,src:t})}const l=Pe({newImage:n});Ne(l),oe&&oe(l,R)}))),[R,ke,Pe,oe]),Le=s((e=>t(void 0,void 0,void 0,(function*(){const{file:t,dataUrl:a}=yield b(e),n=Pe({newImage:{file:t,src:a}});Ne(n),oe&&oe(n,R)}))),[R,ke,Pe,oe]),Ve=s((e=>{let t=[...ke.media];if("media"in e){if(t.length>=ne)return he&&he(),t;if(Array.isArray(e.media)?t=[...t,...e.media]:t.push(e.media),t=v(t,"src"),t.length>ne)return void(he&&he())}else t=t.filter(((t,a)=>e.deleteIndex!==a));return t}),[ke.media,ne]),ze=s((e=>{let{textUrls:t,mediaUrls:a}=e;const n=/\.(jpg|jpeg|png|gif|bmp|tiff|webp|avif)(\?.*)?$/i,l=[...t,...a.map((e=>e.src))].reduce(((e,t)=>{let a="etc";return n.test(t)?a="image":I(t)?a="youtube":N(t)&&(a="twitch"),e[a]||(e[a]=[]),e[a].push(t),e}),{}),{image:i=[],youtube:r=[],twitch:s=[],etc:o=[]}=l,m=Pe({newImage:[...a.filter((e=>"img"===e.tag)),...i.map((e=>({src:e})))]}),c=Ve({media:[...r.map((e=>({type:"youtube",src:y(e)}))),...s.map((e=>({type:"twitch",src:j(e)})))]});return Ue(c),Ne(m),me&&me(c,R),oe&&oe(m,R),t.map((e=>'<a href="'.concat(e.startsWith("http")?e:"https://".concat(e),'" target="_blank">').concat(e,"</a>")))}),[R,ke,oe,me,Pe,Ve]),We=s((e=>t(void 0,void 0,void 0,(function*(){const t=e.clipboardData.items[0];if(0===t.type.indexOf("image")){const e=t.getAsFile(),a=yield E(e);Pe({newImage:{file:e,src:a}})}}))),[Pe]),_e=s((e=>{const t=O(e);je(t),se&&se(t,R)}),[R,se]);return o((()=>{Ue(J)}),[JSON.stringify(J)]),o((()=>{Ne(_)}),[JSON.stringify(_)]),o((()=>{Te(B)}),[JSON.stringify(B)]),o((()=>{if(W&&!ye){const e=S(W);je(e)}}),[W,ye]),m(c,(()=>{const{setData:e}=xe.current;return xe.current.setData=t=>{const a=S(t);e(a)},xe.current})),a.createElement("div",{className:V(z,"feed-detail-editor")},a.createElement("div",{className:V("feed-detail-editor-header",{"exist-user-click-event":!!ue})},a.createElement(A,{src:G,size:"custom",className:V("avatar","user-img"),onClick:ue}),a.createElement("div",{className:V("profile-info")},a.createElement("strong",{className:V("user-name"),onClick:ue},H||"-"),a.createElement("div",{className:V("btn-post-popover")},q?a.createElement(F,{anchorId:pe?"":"post-category",id:"post-category",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:ie,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!ie&&!pe},onClick:pe},a.createElement("span",{className:V("selected-channel")},X||"-"," ",ie||pe?a.createElement(M,null):a.createElement(a.Fragment,null))):a.createElement(F,{anchorId:ge?"":"post-channel",id:"post-channel",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:le,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!le&&!ge},onClick:ge},a.createElement("span",{className:V("selected-channel")},!!Q&&a.createElement(A,{src:Q,size:"custom",className:V("avatar")}),K||"내 채널에 포스트",le||ge?a.createElement(M,null):a.createElement(a.Fragment,null)))))),a.createElement("div",{className:V("feed-detail-editor-body")},a.createElement(d,Object.assign({className:V("editor","post-content",{filled:ye.length}),ref:xe,plugin:[g,p,u,f,D],initialValue:ye,placeholder:ee,maxLength:Z},ve,{config:x({pasteToPlainText:{onMatchUrlReplace:ze},autoUrlMatch:{onMatchUrl:e=>ze({textUrls:[e],mediaUrls:[]}),onChangeMatchUrls:e=>{const t=/\.(jpg|jpeg|png|gif|bmp|webp|tiff|avif)$/i,a=e.filter((e=>!t.test(e)&&!I(e)&&!N(e)));Se(De.filter((e=>a.includes(e))));const n=a.filter((e=>!De.includes(e)));De.includes(n[0])||de&&de(n[0])}},countTextLength:{hideUi:!0,onChangeTextLength:Ce}},te),onDragOver:Ae,onDrop:Fe,onPaste:We,handleChange:_e})),ke.images.length>0&&a.createElement(C,{images:ke.images,handleDeleteImg:e=>{let{deleteIndex:t}=e;const a=Pe({deleteIndex:t});Ne(a),oe&&oe(a)}}),ke.media.length>0&&a.createElement(w,{media:ke.media,handleDeleteIframe:e=>{let{deleteIndex:t}=e;const a=Ve({deleteIndex:t});Ue(a),me&&me(a)}}),!!Me&&a.createElement(U,{ogMetaData:Me,handleDeleteOgMetaData:e=>{let{urls:t}=e;Te(void 0),de&&de(void 0),Se((e=>[...new Set([...e,...(null!=t?t:[]).map((e=>e.endsWith("/")?e.slice(0,-1):e))])]))}})),a.createElement("div",{className:V("control-box")},a.createElement("div",{className:V("left")},a.createElement("label",{className:V("btn-img-upload")},a.createElement("input",{ref:Ee,type:"file",accept:"image/png, image/gif, image/jpeg, image/jpg, image/webp, image/bmp, image/tiff",onChange:Le}),a.createElement(T,null))),a.createElement("div",{className:V("right")},a.createElement("span",{className:V("text-count")},a.createElement("b",null,P(be))," / ",P(Z)),a.createElement("button",{className:V("btn-submit",{loading:Oe.loading}),disabled:Oe.disalbed,onClick:()=>ce(Object.assign(Object.assign({},ke),{textValue:O(ke.textValue)}),R)},a.createElement("span",{className:V("text")},Y),re?a.createElement("span",{className:V("spinner")},a.createElement(L,{size:20})):a.createElement(a.Fragment,null)))))}));z.displayName="FeedDetailEditor";var W=z;export{W as default};
