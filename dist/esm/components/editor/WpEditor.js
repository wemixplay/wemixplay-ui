import{__rest as e}from"../../_virtual/_tslib.js";import n,{forwardRef as t,useRef as o,useState as r,useMemo as a,useCallback as i,useEffect as c,useImperativeHandle as l}from"react";import s from"./WpEditor.module.scss.js";import d from"../../node_modules/lodash/debounce.js";import u from"./WpEditorContents.js";import{makeCxFunc as p}from"../../utils/forReactUtils.js";import{checkValidHashTag as m,checkValidMention as g}from"../../utils/pluginUtils.js";const h=p(s),v=e=>{let{plugin:n,contentEditableEl:t}=e;return n.map((e=>new e({contentEditableEl:t})))},f=t(((t,s)=>{var{className:p="",name:f,initialValue:y,config:C={},plugin:b=[],placeholder:E,maxLength:T,onClick:L,handleChange:w}=t,x=e(t,["className","name","initialValue","config","plugin","placeholder","maxLength","onClick","handleChange"]);const R=o(!1),k=o(),K=o({index:0,stack:[""],disabled:!1}),[D,M]=r(v({plugin:b,contentEditableEl:k})),H=a((()=>d((()=>{var e;k.current&&K.current.stack[K.current.index]!==(null===(e=k.current)||void 0===e?void 0:e.innerHTML)&&(K.current.stack.push(k.current.innerHTML),K.current.index+=1)}),300)),[]),N=a((()=>{if("undefined"!=typeof window)return new MutationObserver((()=>{k.current&&K.current&&(K.current.disabled?K.current.disabled=!1:H())}))}),[H]),B=i((()=>{const e=document.createRange();return{selection:window.getSelection(),range:e}}),[]),j=i((()=>{var e;const{selection:n,range:t}=B();return t.selectNodeContents(null!==(e=k.current.lastChild)&&void 0!==e?e:k.current),t.collapse(!1),n.removeAllRanges(),n.addRange(t),t}),[B]),P=i((e=>{let{range:n}=B();if("historyUndo"===e.inputType||"historyRedo"===e.inputType){e.preventDefault&&e.preventDefault();const{index:t,stack:o}=K.current,r="historyUndo"===e.inputType?t-1:t+1;if(r>=0&&r<o.length){const t=o[r];k.current.innerHTML=t,w&&w(t.replace(/&nbsp;/g," "),f),n=j(),"historyUndo"===e.inputType?K.current.index-=1:K.current.index+=1;const a=n.getBoundingClientRect(),i=k.current.getBoundingClientRect();a.top<i.top?k.current.scrollTop-=i.top-a.top:a.bottom>i.bottom&&(k.current.scrollTop+=a.bottom-i.bottom)}K.current.disabled=!0,D.forEach((n=>{n.handleUndoRedo&&n.handleUndoRedo({type:e.inputType})}))}else{const{index:e}=K.current;e>0&&(K.current.stack=K.current.stack.slice(0,e+1)),K.current.disabled=!1}}),[f,w,B,D,j]),U=i((e=>{const{selection:n}=B(),t=k.current.innerHTML;if((e.ctrlKey&&"KeyB"===e.code||e.metaKey&&"KeyB"===e.code)&&e.preventDefault(),"KeyZ"===e.code&&(e.metaKey||e.ctrlKey)&&e.shiftKey&&(P(Object.assign(Object.assign({},e),{inputType:"historyRedo"})),e.preventDefault()),D.forEach((n=>{n.handleKeyDown&&n.handleKeyDown({event:e})})),!("Enter"!==e.code&&"NumpadEnter"!==e.code||e.shiftKey||e.nativeEvent.isComposing||k.current.innerHTML!==t)){e.preventDefault(),e.stopPropagation(),document.execCommand("insertLineBreak");let t=n.getRangeAt(0);t=t.cloneRange(),t.setStart(t.startContainer,0);const o=t.getBoundingClientRect(),r=k.current.getBoundingClientRect();if(o.bottom>r.bottom){const e=o.bottom-r.bottom;k.current.scrollTo({top:k.current.scrollTop+2*e})}}x.onKeyDown&&x.onKeyDown(e)}),[B,P,D,x]),F=i((e=>{e.target.innerHTML||(k.current.innerHTML=""),(()=>{const e=window.getSelection();if(e.rangeCount>0){const n=e.getRangeAt(0),t=n.startContainer.parentNode;if("tagName"in t&&"font"===t.tagName.toLowerCase()){const o=t.textContent,r=document.createDocumentFragment(),a=document.createTextNode(o);r.appendChild(a),t.parentNode.replaceChild(r,t),n.setStart(a,o.length),n.setEnd(a,o.length),e.removeAllRanges(),e.addRange(n)}}})();for(const n of D)n.handleChange&&n.handleChange({event:e});w&&w(k.current.innerHTML.replace(/&nbsp;/g," "),f),x.onChange&&x.onChange(e),x.onInput&&x.onInput(e),H()}),[w,H,f,D,x]),S=i((e=>{D.forEach((n=>{n.handleClick&&n.handleClick({event:e})}))}),[D]),A=i((e=>{D.forEach((n=>{n.handleCopy&&n.handleCopy({event:e})})),x.onCopy&&x.onCopy(e)}),[D,x]),O=i((e=>{var n,t,o,r,a,i;K.current.stack[K.current.index]!==k.current.innerHTML&&(K.current.stack.push(k.current.innerHTML),K.current.index+=1);let c=D;const l=window.getSelection().focusNode,s=!!(null===(o=null===(t=null===(n=null==l?void 0:l.parentElement)||void 0===n?void 0:n.classList)||void 0===t?void 0:t.contains)||void 0===o?void 0:o.call(t,"hash")),d=!!(null===(i=null===(a=null===(r=null==l?void 0:l.parentElement)||void 0===r?void 0:r.classList)||void 0===a?void 0:a.contains)||void 0===i?void 0:i.call(a,"mention")),u=e.nativeEvent.clipboardData.getData("text");s&&m(u)&&(c=c.filter((e=>"pasteToPlainText"!==e.commandKey))),d&&g(u)&&(c=c.filter((e=>"pasteToPlainText"!==e.commandKey))),c.forEach((n=>{n.handlePaste&&n.handlePaste({event:e})})),x.onPaste&&x.onPaste(e)}),[D,x]),I=i((e=>{D.forEach((n=>{n.handleFocus&&n.handleFocus({event:e})})),x.onFocus&&x.onFocus(e)}),[D,x]),W=i((e=>{D.forEach((n=>{n.handleBlur&&n.handleBlur({event:e})})),x.onBlur&&x.onBlur(e)}),[D,x]),_=i((function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{keepRange:!0};k.current.innerHTML=e,k.current.dispatchEvent(new Event("input",{bubbles:!0})),n.keepRange&&j()}),[j]);return c((()=>{D.forEach((e=>{e.setConfig&&e.setConfig(C[e.commandKey])}))}),[C,D]),c((()=>{if(N){const e=k.current;return N.observe(e,{childList:!0,subtree:!0,characterData:!0}),e.addEventListener("beforeinput",P),()=>{N.disconnect(),e.removeEventListener("beforeinput",P)}}}),[N,P]),c((()=>{!y||k.current.innerHTML||R.current||(k.current.innerHTML=y,j(),R.current=!0)}),[y,j]),c((()=>{M(v({plugin:b,contentEditableEl:k}))}),[]),l(s,(()=>(k.current.setData=_,k.current))),n.createElement("div",{className:h("wp-editor"),onClick:L},n.createElement(u,Object.assign({ref:k,className:h(p,"wp-editor-content")},x,{"aria-placeholder":E,"aria-valuemax":T,contentEditable:!0,onInput:F,onPaste:O,onCopy:A,onKeyDown:U,onFocus:I,onBlur:W,onClick:S})),D.filter((e=>null==e?void 0:e.component)).map(((e,t)=>{var o;const r=e.component;return n.createElement(r,{key:null!==(o=e.commandKey)&&void 0!==o?o:t,plugin:e})})))}));f.displayName="WpEditor";var y=f;export{y as default};
