import n from"@babel/runtime/helpers/slicedToArray";import{__rest as e}from"../../_virtual/_tslib.js";import t,{forwardRef as r,useRef as o,useState as i,useMemo as a,useCallback as c,useEffect as u,useImperativeHandle as l}from"react";import d from"./WpEditor.module.scss.js";import s from"../../_virtual/debounce.js";import f from"./WpEditorContents.js";import{makeCxFunc as p}from"../../utils/forReactUtils.js";import{checkValidHashTag as v,checkValidMention as m}from"../../utils/pluginUtils.js";function g(n,e){var t="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(!t){if(Array.isArray(n)||(t=function(n,e){if(n){if("string"==typeof n)return h(n,e);var t={}.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?h(n,e):void 0}}(n))||e){t&&(n=t);var r=0,o=function(){};return{s:o,n:function(){return r>=n.length?{done:!0}:{done:!1,value:n[r++]}},e:function(n){throw n},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,c=!1;return{s:function(){t=t.call(n)},n:function(){var n=t.next();return a=n.done,n},e:function(n){c=!0,i=n},f:function(){try{a||null==t.return||t.return()}finally{if(c)throw i}}}}function h(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}var y=p(d),b=function(n){var e=n.plugin,t=n.contentEditableEl;return e.map((function(n){return new n({contentEditableEl:t})}))},C=r((function(r,d){var p=r.className,h=void 0===p?"":p,C=r.name,E=r.initialValue,T=r.config,w=void 0===T?{}:T,L=r.plugin,x=void 0===L?[]:L,R=r.placeholder,k=r.maxLength,K=r.onClick,D=r.handleChange,M=e(r,["className","name","initialValue","config","plugin","placeholder","maxLength","onClick","handleChange"]),H=o(!1),N=o(),B=o({index:0,stack:[""],disabled:!1}),j=i(b({plugin:x,contentEditableEl:N})),A=n(j,2),S=A[0],P=A[1],U=a((function(){return s((function(){var n;N.current&&B.current.stack[B.current.index]!==(null===(n=N.current)||void 0===n?void 0:n.innerHTML)&&(B.current.stack.push(N.current.innerHTML),B.current.index+=1)}),300)}),[]),F=a((function(){if("undefined"!=typeof window)return new MutationObserver((function(){N.current&&B.current&&(B.current.disabled?B.current.disabled=!1:U())}))}),[U]),I=c((function(){var n=document.createRange();return{selection:window.getSelection(),range:n}}),[]),O=c((function(){var n,e=I(),t=e.selection,r=e.range;return r.selectNodeContents(null!==(n=N.current.lastChild)&&void 0!==n?n:N.current),r.collapse(!1),t.removeAllRanges(),t.addRange(r),r}),[I]),W=c((function(n){var e=I().range;if("historyUndo"===n.inputType||"historyRedo"===n.inputType){n.preventDefault&&n.preventDefault();var t=B.current,r=t.index,o=t.stack,i="historyUndo"===n.inputType?r-1:r+1;if(i>=0&&i<o.length){var a=o[i];N.current.innerHTML=a,D&&D(a.replace(/&nbsp;/g," "),C),e=O(),"historyUndo"===n.inputType?B.current.index-=1:B.current.index+=1;var c=e.getBoundingClientRect(),u=N.current.getBoundingClientRect();c.top<u.top?N.current.scrollTop-=u.top-c.top:c.bottom>u.bottom&&(N.current.scrollTop+=c.bottom-u.bottom)}B.current.disabled=!0,S.forEach((function(e){e.handleUndoRedo&&e.handleUndoRedo({type:n.inputType})}))}else{var l=B.current.index;l>0&&(B.current.stack=B.current.stack.slice(0,l+1)),B.current.disabled=!1}}),[C,D,I,S,O]),_=c((function(n){var e=I().selection,t=N.current.innerHTML;if((n.ctrlKey&&"KeyB"===n.code||n.metaKey&&"KeyB"===n.code)&&n.preventDefault(),"KeyZ"===n.code&&(n.metaKey||n.ctrlKey)&&n.shiftKey&&(W(Object.assign(Object.assign({},n),{inputType:"historyRedo"})),n.preventDefault()),S.forEach((function(e){e.handleKeyDown&&e.handleKeyDown({event:n})})),!("Enter"!==n.code&&"NumpadEnter"!==n.code||n.shiftKey||n.nativeEvent.isComposing||N.current.innerHTML!==t)){n.preventDefault(),n.stopPropagation(),document.execCommand("insertLineBreak");var r=e.getRangeAt(0);(r=r.cloneRange()).setStart(r.startContainer,0);var o=r.getBoundingClientRect(),i=N.current.getBoundingClientRect();if(o.bottom>i.bottom){var a=o.bottom-i.bottom;N.current.scrollTo({top:N.current.scrollTop+2*a})}}M.onKeyDown&&M.onKeyDown(n)}),[I,W,S,M]),V=c((function(n){n.target.innerHTML||(N.current.innerHTML=""),function(){var n=window.getSelection();if(n.rangeCount>0){var e=n.getRangeAt(0),t=e.startContainer.parentNode;if("tagName"in t&&"font"===t.tagName.toLowerCase()){var r=t.textContent,o=document.createDocumentFragment(),i=document.createTextNode(r);o.appendChild(i),t.parentNode.replaceChild(o,t),e.setStart(i,r.length),e.setEnd(i,r.length),n.removeAllRanges(),n.addRange(e)}}}();var e,t=g(S);try{for(t.s();!(e=t.n()).done;){var r=e.value;r.handleChange&&r.handleChange({event:n})}}catch(n){t.e(n)}finally{t.f()}D&&D(N.current.innerHTML.replace(/&nbsp;/g," "),C),M.onChange&&M.onChange(n),M.onInput&&M.onInput(n),U()}),[D,U,C,S,M]),Z=c((function(n){S.forEach((function(e){e.handleClick&&e.handleClick({event:n})}))}),[S]),$=c((function(n){S.forEach((function(e){e.handleCopy&&e.handleCopy({event:n})})),M.onCopy&&M.onCopy(n)}),[S,M]),q=c((function(n){var e,t,r,o,i,a;B.current.stack[B.current.index]!==N.current.innerHTML&&(B.current.stack.push(N.current.innerHTML),B.current.index+=1);var c=S,u=window.getSelection().focusNode,l=!!(null===(r=null===(t=null===(e=null==u?void 0:u.parentElement)||void 0===e?void 0:e.classList)||void 0===t?void 0:t.contains)||void 0===r?void 0:r.call(t,"hash")),d=!!(null===(a=null===(i=null===(o=null==u?void 0:u.parentElement)||void 0===o?void 0:o.classList)||void 0===i?void 0:i.contains)||void 0===a?void 0:a.call(i,"mention")),s=n.nativeEvent.clipboardData.getData("text");l&&v(s)&&(c=c.filter((function(n){return"pasteToPlainText"!==n.commandKey}))),d&&m(s)&&(c=c.filter((function(n){return"pasteToPlainText"!==n.commandKey}))),c.forEach((function(e){e.handlePaste&&e.handlePaste({event:n})})),M.onPaste&&M.onPaste(n)}),[S,M]),z=c((function(n){S.forEach((function(e){e.handleFocus&&e.handleFocus({event:n})})),M.onFocus&&M.onFocus(n)}),[S,M]),G=c((function(n){S.forEach((function(e){e.handleBlur&&e.handleBlur({event:n})})),M.onBlur&&M.onBlur(n)}),[S,M]),J=c((function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{keepRange:!0};N.current.innerHTML=n,N.current.dispatchEvent(new Event("input",{bubbles:!0})),e.keepRange&&O()}),[O]);return u((function(){S.forEach((function(n){n.setConfig&&n.setConfig(w[n.commandKey])}))}),[w,S]),u((function(){if(F){var n=N.current;return F.observe(n,{childList:!0,subtree:!0,characterData:!0}),n.addEventListener("beforeinput",W),function(){F.disconnect(),n.removeEventListener("beforeinput",W)}}}),[F,W]),u((function(){!E||N.current.innerHTML||H.current||(N.current.innerHTML=E,O(),H.current=!0)}),[E,O]),u((function(){P(b({plugin:x,contentEditableEl:N}))}),[]),l(d,(function(){return N.current.setData=J,N.current})),t.createElement("div",{className:y("wp-editor"),onClick:K},t.createElement(f,Object.assign({ref:N,className:y(h,"wp-editor-content")},M,{"aria-placeholder":R,"aria-valuemax":k,contentEditable:!0,onInput:V,onPaste:q,onCopy:$,onKeyDown:_,onFocus:z,onBlur:G,onClick:Z})),S.filter((function(n){return null==n?void 0:n.component})).map((function(n,e){var r,o=n.component;return t.createElement(o,{key:null!==(r=n.commandKey)&&void 0!==r?r:e,plugin:n})})))}));C.displayName="WpEditor";export{C as default};
