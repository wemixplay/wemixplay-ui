import e from"@babel/runtime/helpers/typeof";import n from"@babel/runtime/helpers/toConsumableArray";import t from"@babel/runtime/helpers/slicedToArray";import r,{memo as i,useRef as o,useState as u,useMemo as a,createElement as c,useCallback as l,useEffect as d,cloneElement as s}from"react";import{makeCxFunc as f}from"../../utils/forReactUtils.js";import m from"../loadings/Spinner.js";import v from"../noData/NoDataText.js";import h from"./imageCacher.js";import p from"./VirtualScroll.module.scss.js";function g(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=function(e,n){if(e){if("string"==typeof e)return b(e,n);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?b(e,n):void 0}}(e))||n){t&&(e=t);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,u=!0,a=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return u=e.done,e},e:function(e){a=!0,o=e},f:function(){try{u||null==t.return||t.return()}finally{if(a)throw o}}}}function b(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=Array(n);t<n;t++)r[t]=e[t];return r}"undefined"==typeof window&&(r.useLayoutEffect=r.useEffect);var x=f(p),y=i((function(e){var n,i,a=e.gapY,c=e.index,s=e.resizeObserver,f=e.children,m=e.heightList,v=e.updateHeight,h=o(),p=u({position:"absolute",width:"100%",top:(null!==(i=null===(n=h.current)||void 0===n?void 0:n.offsetHeight)&&void 0!==i?i:0+a)*c,left:0,zIndex:1,visibility:m[c]?"visible":"hidden"}),g=t(p,2),b=g[0],y=g[1],I=l((function(){if(h.current){var e=h.current.offsetHeight;v(e,c)}}),[c,v]),w=l((function(){if(m[c]){var e=m.slice(0,c).reduce((function(e,n){return e+n}),0);y((function(n){return Object.assign(Object.assign({},n),{left:0,top:e+a,visibility:"visible"})}))}else I()}),[a,m,c,I]);return d((function(){w()}),[w]),d((function(){var e=h.current;return s.observe(e),function(){s.unobserve(e)}}),[s]),r.createElement("div",{ref:h,"data-index":c,className:x("virtual-item"),style:b},f)}));y.displayName="VirtualItem";var I=i((function(i){var f,p,b,I,w=i.className,E=void 0===w?"":w,j=i.scrollTarget,A=i.list,O=i.preloadCnt,H=void 0===O?5:O,N=i.itemHeight,W=i.gapY,Y=void 0===W?0:W,M=i.loading,S=i.loadingElement,T=void 0===S?r.createElement(m,null):S,C=i.skeletonElement,L=i.skeletonCnt,k=void 0===L?3:L,z=i.noDataMsg,D=i.element,F=o(),R=o(null),U=o(0),V=o(0),q=o({startIndex:0,endIndex:50}),$=u(!!A),B=t($,1)[0],G=u([]),J=t(G,2),K=J[0],P=J[1],Q=u({startIndex:0,endIndex:50}),X=t(Q,2),Z=X[0],_=X[1],ee=u({containerWidth:null!==(p=null===(f=F.current)||void 0===f?void 0:f.clientWidth)&&void 0!==p?p:0,gapY:"number"==typeof Y?Y:Y(null!==(I=null===(b=F.current)||void 0===b?void 0:b.clientWidth)&&void 0!==I?I:0)}),ne=t(ee,2),te=ne[0],re=ne[1],ie=a((function(){return c(D)}),[D]),oe=a((function(){return new ResizeObserver((function(e){var n,t,r=g(e);try{var i=function(){var e=t.value.target,r=e.clientWidth,i=e.offsetHeight,o=e.dataset,u=Number(null!==(n=o.index)&&void 0!==n?n:-1);-1===u?re({containerWidth:null!=r?r:0,gapY:"number"==typeof Y?Y:Y(null!=r?r:0)}):P((function(e){return e.map((function(e,n){return n===u?i:e}))}))};for(r.s();!(t=r.n()).done;)i()}catch(e){r.e(e)}finally{r.f()}}))}),[Y]),ue=a((function(){return M||!A}),[M,A]),ae=a((function(){return A||C?ue?Array.from({length:k}).map((function(){})):A.slice(Z.startIndex,Z.endIndex):[]}),[A,C,Z,k,ue]),ce=a((function(){var e="number"==typeof N?N:N(te.containerWidth);return K.filter((function(e){return!!e})).length?Math.max.apply(Math,n(K.filter((function(e){return!!e})))):e}),[K,N,te.containerWidth]),le=a((function(){var e=A?A.length:k;return e>0&&K.length===e?K.reduce((function(e,n){return e+n+te.gapY}),0):ce>0?ce*e:0}),[A,k,K,ce,te.gapY]),de=l((function(){var e=j?"current"in j?j.current:j:null,n=e?e.scrollTop:window.scrollY,t=e?e.offsetHeight:window.innerHeight,r=K.reduce((function(e,n){var t,r=(null!==(t=e[e.length-1])&&void 0!==t?t:0)+n;return e.push(r),e}),[]),i=r.findIndex((function(e){return e>=n})),o=r.findIndex((function(e){return e>=n+t}));return-1===i?i=q.current.startIndex:(i=i-10-H,i=ce&&i>0?i:0),-1===o?o=q.current.endIndex:(o=o+10+H,o=ce&&o>0?o:50),{startIndex:i,endIndex:o}}),[j,K,ce,H]),se=l((function(e,n){(A||C)&&P((function(t){return t[n]=e,t.slice(0,A?A.length:k)}))}),[A,C,k]),fe=l((function(){var e=j?"current"in j?j.current:j:null,n=e?e.scrollTop:window.scrollY,t=Date.now(),r=n-V.current,i=r>0,o=Math.abs(r);null!==R.current&&cancelAnimationFrame(R.current),R.current=requestAnimationFrame((function(){var e=de();return o>0&&n>0&&(i&&e.endIndex<q.current.endIndex||!i&&e.startIndex>q.current.startIndex)?(cancelAnimationFrame(R.current),void(R.current=null)):(i&&o>ce?e.endIndex+=Math.floor(o/ce):!i&&o>ce&&(e.startIndex-=Math.floor(o/ce),e.startIndex<=0&&(e.startIndex=0)),t-U.current>=200||n<=0||0===o?(_(e),V.current=n,q.current=Object.assign({},e),U.current=t,void(R.current=null)):void(o>=ce*(H/2)?(_(e),V.current=n,q.current=Object.assign({},e),U.current=t,R.current=null):(q.current.endIndex-e.endIndex>H||e.startIndex-q.current.startIndex>H)&&(_(e),V.current=n,U.current=t,q.current=Object.assign({},e))))}))}),[de,ce,H,j]);return d((function(){oe.observe(F.current)}),[F,oe]),d((function(){if("undefined"!=typeof window&&F.current){var e=j?"current"in j?j.current:j:window;return fe(),e.removeEventListener("scroll",fe),e.addEventListener("scroll",fe),function(){null!==R.current&&cancelAnimationFrame(R.current),e.removeEventListener("scroll",fe)}}}),[j,R,fe]),r.createElement("div",{ref:F,className:x(E,"virtual-scroll",{"no-data":A&&!A.length}),style:{height:le,minHeight:B&&!A?"100000px":0}},ue&&!C&&r.createElement("div",{className:x("loading")},T),!ue&&0===A.length&&("object"===e(z)?z:r.createElement(v,{className:x("no-msg-comp"),nullText:z})),ae.map((function(e,n){var t=Z.startIndex+n;return r.createElement(y,Object.assign({key:"".concat(t,"-").concat(te.containerWidth,"-").concat(A?"":"skeleton")},te,{index:t,resizeObserver:oe,heightList:K,updateHeight:se}),r.createElement("div",null,s(A?ie:C,{item:e,imageCacher:h,index:t})))})))}));export{I as default};
