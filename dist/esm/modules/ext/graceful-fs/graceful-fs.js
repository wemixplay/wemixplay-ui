import{commonjsGlobal as e}from"../../_virtual/_commonjsHelpers.js";import{p as t}from"./polyfills.js";import{c as n}from"./clone.js";import{l as o}from"./legacy-streams.js";import r from"assert";import i from"fs";import u from"util";var c,f,a=i,p=t,l=o,s=n,y=u;function m(e,t){Object.defineProperty(e,c,{get:function(){return t}})}"function"==typeof Symbol&&"function"==typeof Symbol.for?(c=Symbol.for("graceful-fs.queue"),f=Symbol.for("graceful-fs.previous")):(c="___graceful-fs.queue",f="___graceful-fs.previous");var d=function(){};if(y.debuglog?d=y.debuglog("gfs4"):/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&(d=function(){var e=y.format.apply(y,arguments);e="GFS4: "+e.split(/\n/).join("\nGFS4: ")}),!a[c]){var v=e[c]||[];m(a,v),a.close=function(e){function t(t,n){return e.call(a,t,(function(e){e||F(),"function"==typeof n&&n.apply(this,arguments)}))}return Object.defineProperty(t,f,{value:e}),t}(a.close),a.closeSync=function(e){function t(t){e.apply(a,arguments),F()}return Object.defineProperty(t,f,{value:e}),t}(a.closeSync),/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&process.on("exit",(function(){d(a[c]),r.equal(a[c].length,0)}))}e[c]||m(e,a[c]);var E,b=g(s(a));function g(e){p(e),e.gracefulify=g,e.createReadStream=function(t,n){return new e.ReadStream(t,n)},e.createWriteStream=function(t,n){return new e.WriteStream(t,n)};var t=e.readFile;e.readFile=function(e,n,o){"function"==typeof n&&(o=n,n=null);return function e(n,o,r,i){return t(n,o,(function(t){!t||"EMFILE"!==t.code&&"ENFILE"!==t.code?"function"==typeof r&&r.apply(this,arguments):h([e,[n,o,r],t,i||Date.now(),Date.now()])}))}(e,n,o)};var n=e.writeFile;e.writeFile=function(e,t,o,r){"function"==typeof o&&(r=o,o=null);return function e(t,o,r,i,u){return n(t,o,r,(function(n){!n||"EMFILE"!==n.code&&"ENFILE"!==n.code?"function"==typeof i&&i.apply(this,arguments):h([e,[t,o,r,i],n,u||Date.now(),Date.now()])}))}(e,t,o,r)};var o=e.appendFile;o&&(e.appendFile=function(e,t,n,r){"function"==typeof n&&(r=n,n=null);return function e(t,n,r,i,u){return o(t,n,r,(function(o){!o||"EMFILE"!==o.code&&"ENFILE"!==o.code?"function"==typeof i&&i.apply(this,arguments):h([e,[t,n,r,i],o,u||Date.now(),Date.now()])}))}(e,t,n,r)});var r=e.copyFile;r&&(e.copyFile=function(e,t,n,o){"function"==typeof n&&(o=n,n=0);return function e(t,n,o,i,u){return r(t,n,o,(function(r){!r||"EMFILE"!==r.code&&"ENFILE"!==r.code?"function"==typeof i&&i.apply(this,arguments):h([e,[t,n,o,i],r,u||Date.now(),Date.now()])}))}(e,t,n,o)});var i=e.readdir;e.readdir=function(e,t,n){"function"==typeof t&&(n=t,t=null);var o=u.test(process.version)?function(e,t,n,o){return i(e,r(e,t,n,o))}:function(e,t,n,o){return i(e,t,r(e,t,n,o))};return o(e,t,n);function r(e,t,n,r){return function(i,u){!i||"EMFILE"!==i.code&&"ENFILE"!==i.code?(u&&u.sort&&u.sort(),"function"==typeof n&&n.call(this,i,u)):h([o,[e,t,n],i,r||Date.now(),Date.now()])}}};var u=/^v[0-5]\./;if("v0.8"===process.version.substr(0,4)){var c=l(e);m=c.ReadStream,d=c.WriteStream}var f=e.ReadStream;f&&(m.prototype=Object.create(f.prototype),m.prototype.open=function(){var e=this;E(e.path,e.flags,e.mode,(function(t,n){t?(e.autoClose&&e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n),e.read())}))});var a=e.WriteStream;a&&(d.prototype=Object.create(a.prototype),d.prototype.open=function(){var e=this;E(e.path,e.flags,e.mode,(function(t,n){t?(e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n))}))}),Object.defineProperty(e,"ReadStream",{get:function(){return m},set:function(e){m=e},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WriteStream",{get:function(){return d},set:function(e){d=e},enumerable:!0,configurable:!0});var s=m;Object.defineProperty(e,"FileReadStream",{get:function(){return s},set:function(e){s=e},enumerable:!0,configurable:!0});var y=d;function m(e,t){return this instanceof m?(f.apply(this,arguments),this):m.apply(Object.create(m.prototype),arguments)}function d(e,t){return this instanceof d?(a.apply(this,arguments),this):d.apply(Object.create(d.prototype),arguments)}Object.defineProperty(e,"FileWriteStream",{get:function(){return y},set:function(e){y=e},enumerable:!0,configurable:!0});var v=e.open;function E(e,t,n,o){return"function"==typeof n&&(o=n,n=null),function e(t,n,o,r,i){return v(t,n,o,(function(u,c){!u||"EMFILE"!==u.code&&"ENFILE"!==u.code?"function"==typeof r&&r.apply(this,arguments):h([e,[t,n,o,r],u,i||Date.now(),Date.now()])}))}(e,t,n,o)}return e.open=E,e}function h(e){d("ENQUEUE",e[0].name,e[1]),a[c].push(e),S()}function F(){for(var e=Date.now(),t=0;t<a[c].length;++t)a[c][t].length>2&&(a[c][t][3]=e,a[c][t][4]=e);S()}function S(){if(clearTimeout(E),E=void 0,0!==a[c].length){var e=a[c].shift(),t=e[0],n=e[1],o=e[2],r=e[3],i=e[4];if(void 0===r)d("RETRY",t.name,n),t.apply(null,n);else if(Date.now()-r>=6e4){d("TIMEOUT",t.name,n);var u=n.pop();"function"==typeof u&&u.call(null,o)}else{var f=Date.now()-i,p=Math.max(i-r,1);f>=Math.min(1.2*p,100)?(d("RETRY",t.name,n),t.apply(null,n.concat([r]))):a[c].push(e)}void 0===E&&(E=setTimeout(S,0))}}process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&!a.__patched&&(b=g(a),a.__patched=!0);export{b as g};
