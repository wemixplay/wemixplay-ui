import t from"isomorphic-dompurify";const{sanitize:e}=t;class n{constructor(t){let{contentEditableEl:e}=t;this.commandKey="pasteToPlainText",this.config={},this.contentEditableEl=e}setConfig(t){this.config=Object.assign(Object.assign({},this.config),null!=t?t:{})}checkHTMLFormat(t){return/<(div|span|p|img|video|iframe)(\s[^>]*)?>/i.test(t)}getMediaMatchUrlList(t){const e=/<(img|video|iframe)(?=[^>]*\s+src=["']([^"']+)["'])[^>]*>/g;let n;const i=[];for(;null!==(n=e.exec(t));)i.push({tag:n[1],src:n[2].startsWith("http")?n[2]:"https://".concat(n[2])});return i}getUrlMatchList(t){var e,n;return null!==(n=null===(e=(null!=t?t:"").match(/\bhttps?:\/\/[^\s"']+|www\.[^\s"']+|ftp:\/\/[^\s"']+/gi))||void 0===e?void 0:e.map((t=>{const e=t.trim();return e.startsWith("http")?e:"https://".concat(e)})))&&void 0!==n?n:[]}handlePaste(t){let{event:n}=t;var i,a,s;const c=window.getSelection(),r=e(n.nativeEvent.clipboardData.getData("text")),l=e(n.nativeEvent.clipboardData.getData("text/html"));let o=n.nativeEvent.clipboardData.getData("text/plain");o=e(o);const d=this.contentEditableEl.current.getAttribute("aria-valuemax");if(d){const t=this.contentEditableEl.current.textContent.length,e=o.length;Number(d)-(t+e)<0&&(o="",n.preventDefault())}o=o.replace(/<img[^>]*src="([^"]*)"[^>]*>/gi,"$1").replace(/<video[^>]*>.*?<\/video>/gi,"").replace(/<iframe[^>]*>.*?<\/iframe>/gi,"");const h=[...new Set(this.getMediaMatchUrlList(this.checkHTMLFormat(r)?r:l))],g=[...new Set(this.getUrlMatchList(o))],p=[...new Set(null!==(s=null===(a=(i=this.config).onMatchUrlReplace)||void 0===a?void 0:a.call(i,{textUrls:g,mediaUrls:h}))&&void 0!==s?s:[])];if(g.forEach(((t,e)=>{if(p[e]){const n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=t.replace("https://","");o.includes(t)?o=o.replace(new RegExp(n,"g"),((t,n)=>o.slice(Math.max(0,n-5),n).includes('src="')?t:p[e])):o.includes(i)&&(o=o.replace(new RegExp(i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),((t,n)=>o.slice(Math.max(0,n-5),n).includes('src="')?t:p[e])))}})),o.length>0){const t=c.getRangeAt(0);t.deleteContents();const e=document.createElement("div");e.innerHTML="".concat(o.replace(/<script\b[^>]*>([\s\S]*?)<\/script>|<style\b[^>]*>([\s\S]*?)<\/style>/gi,"").trim(),"&nbsp;");const n=e.lastChild;for(const n of Array.from(e.childNodes).reverse())t.insertNode(n);e.remove(),t.setStartAfter(n),t.setEndAfter(n),c.removeAllRanges(),c.addRange(t)}n.preventDefault(),this.contentEditableEl.current.dispatchEvent(new Event("input",{bubbles:!0}))}}export{n as default};
