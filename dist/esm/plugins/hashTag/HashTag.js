import e from"react";import t from'./../../ext/lodash/uniqueId.js';import n from"./components/HashList.js";import a from"./components/HashContainer.js";import{checkValidHashTag as s}from"../../utils/pluginUtils.js";class i{constructor(e){let{contentEditableEl:t}=e;this.commandKey="hash",this.currentHashList=[],this._config={list:[],onWriteHash:e=>{}},this.contentEditableEl=t}set hashId(e){this._hashId=e,this.setTargetHashId&&this.setTargetHashId(this._hashId),e?this.config.onOpenHashList&&this.config.onOpenHashList():this.config.onCloseHashList&&this.config.onCloseHashList()}get hashId(){return this._hashId}set config(e){this._config=e,this.setNewConfig&&this.setNewConfig(e)}get config(){return this._config}setConfig(e){this.config=Object.assign(Object.assign({},this.config),null!=e?e:{})}component(t){let{plugin:s}=t;return e.createElement(a,{hash:s},(t=>{let{config:a,targetHashId:i}=t;return e.createElement(n,{ref:e=>{s.hashListRef=e},contentEditableEl:s.contentEditableEl,targetHashId:i,list:a.detectDuplicate?a.list.filter((e=>this.currentHashList.every((t=>t.name!==e.name)))):a.list,listElement:a.listElement,selectHashItem:e=>{s.selectHashItem(e)},closeHashList:()=>{s.hashId=""}})}))}getAllHashTag(){const e=this.contentEditableEl.current.querySelectorAll(".hash");return Array.from(e).map((e=>Object.assign(Object.assign({},Object.fromEntries(Object.entries(e.dataset))),{name:e.textContent.replace("#","").trim()})))}updateCurrentHashList(e){this.currentHashList=this.getAllHashTag(),e&&(this.currentHashList=[...this.currentHashList,e]),this.config.onCompleteHash&&this.config.onCompleteHash({allHashTag:this.currentHashList,currentHashTag:e})}leaveHashTag(){let{hash:e,keepTag:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var n,a,s,i,o,l;const r=window.getSelection(),d=document.createRange(),c=this.contentEditableEl.current,h=this.hashId,u=c.querySelector("#".concat(h));if(!u)return;const m="#"===(null===(a=null===(n=u.firstChild)||void 0===n?void 0:n.textContent)||void 0===a?void 0:a.trim())&&!e,p=new RegExp('<span\\s+id="'.concat(h,'"([^>]*)class="hash"([^>]*)>(.*?)<\\/span>'),"g");if(m){const e=document.createTextNode(null===(s=u.firstChild)||void 0===s?void 0:s.textContent);u.replaceWith(e);const t=document.createRange();return t.setStartAfter(e),t.setEndAfter(e),r.removeAllRanges(),r.addRange(t),void(this.hashId="")}if(e)if(this.config.detectDuplicate&&this.currentHashList.some((t=>t.name===e.name)))c.innerHTML=c.innerHTML.replace(p,'<span id="'.concat(h,'" class="duplicate-hash"$1$2>#').concat(e.name,"</span>"));else{c.innerHTML=c.innerHTML.replace(p,'<span id="'.concat(h,'" class="hash complete-hash"$1$2>#').concat(e.name,"</span>"));const t=c.querySelector("#".concat(h));t.dataset.id=String(e.id),t.dataset.name=e.name,t.textContent="#".concat(e.name)}else if(!t){const t=r.focusNode.textContent.trim();if(this.config.detectDuplicate&&this.currentHashList.some((t=>t.name===e.name)))c.innerHTML=c.innerHTML.replace(p,'<span id="'.concat(h,'" class="duplicate-hash"$1$2>').concat(t,"</span>"));else{c.innerHTML=c.innerHTML.replace(p,'<span id="'.concat(h,'" class="hash"$1$2>').concat(t,"</span>"));const e=c.querySelector("#".concat(h));e.dataset.id="0",e.dataset.name=t.replace("#",""),this.updateCurrentHashList({id:Number(e.dataset.id),name:e.dataset.name})}}this.hashId="";const v=null===(i=c.querySelector("#".concat(h)))||void 0===i?void 0:i.nextSibling;(Node.TEXT_NODE!==(null==v?void 0:v.TEXT_NODE)||(null===(o=null==v?void 0:v.nodeValue)||void 0===o?void 0:o.trim()))&&c.querySelector("#".concat(h)).insertAdjacentHTML("afterend","&nbsp;");const g=m?c:null===(l=c.querySelector("#".concat(h)))||void 0===l?void 0:l.nextSibling;m?(d.selectNodeContents(g),d.collapse(!1)):(d.setStart(g,1),d.collapse(!0)),r.removeAllRanges(),r.addRange(d),this.contentEditableEl.current.dispatchEvent(new Event("input",{bubbles:!0}))}selectHashItem(e){var t;const n=this.hashListRef.handleSubmit(e);Number(this.contentEditableEl.current.ariaValueMax)<=(null!==(t=null==n?void 0:n.name)&&void 0!==t?t:"").length+this.contentEditableEl.current.textContent.length?this.hashId="":(this.leaveHashTag({hash:n}),this.updateCurrentHashList(n))}handleClick(e){var t,n,a,s,i;const o=window.getSelection(),l=o.focusNode,r=!!(null===(a=null===(n=null===(t=null==l?void 0:l.parentElement)||void 0===t?void 0:t.classList)||void 0===n?void 0:n.contains)||void 0===a?void 0:a.call(n,"hash")),d=o.getRangeAt(0);r&&d.startOffset>0&&d.startOffset===d.endOffset&&(this.hashId=l.parentElement.id,this.config.onWriteHash&&this.config.onWriteHash(null===(i=null===(s=null==l?void 0:l.parentElement)||void 0===s?void 0:s.textContent)||void 0===i?void 0:i.replace("#","")))}handleKeyDown(e){let{event:t}=e;var n,a,s,i,o,l,r,d,c,h;const u=window.getSelection(),m=document.createRange(),p=this.hashId,v=u.focusNode,g=u.focusOffset,f=!!(null===(s=null===(a=null===(n=null==v?void 0:v.parentElement)||void 0===n?void 0:n.classList)||void 0===a?void 0:a.contains)||void 0===s?void 0:s.call(a,"hash")),E=f&&!(null===(l=null===(o=null===(i=null==v?void 0:v.parentElement)||void 0===i?void 0:i.classList)||void 0===o?void 0:o.contains)||void 0===l?void 0:l.call(o,"complete-hash"));if("ArrowLeft"!==t.code&&"ArrowRight"!==t.code||(f&&g>1&&!p?(this.config.onWriteHash&&this.config.onWriteHash(null===(d=null===(r=null==v?void 0:v.parentElement)||void 0===r?void 0:r.textContent)||void 0===d?void 0:d.replace("#","")),this.hashId=v.parentElement.id):f&&p&&g<=1?this.hashId="":p&&"#"===(null===(c=v.firstChild)||void 0===c?void 0:c.textContent)?this.leaveHashTag():(p&&!f||p&&f&&!E&&g>=v.textContent.length)&&(this.hashId="")),"ArrowRight"===t.code)p&&E&&!v.parentElement.nextElementSibling&&!t.nativeEvent.isComposing?(t.preventDefault(),this.leaveHashTag()):p&&"#"===(null===(h=v.firstChild)||void 0===h?void 0:h.textContent)&&this.leaveHashTag();else if("ArrowUp"===t.code||"ArrowDown"===t.code)p&&(t.preventDefault(),"ArrowUp"===t.code?this.hashListRef.handleArrowUp():this.hashListRef.handleArrowDown());else if("Enter"===t.code)if(p&&!t.nativeEvent.isComposing)t.preventDefault(),this.selectHashItem();else if(f&&g<=1){t.preventDefault();const e=document.createElement("br");v.parentElement.parentNode.insertBefore(e,v.parentElement),m.setStartAfter(e),m.setEndAfter(e),u.removeAllRanges(),u.addRange(m)}}handleChange(e){var n,a,i,o,l,r,d,c,h,u,m;const p=window.getSelection(),v=document.createRange(),g=this.contentEditableEl.current,f=p.focusNode,E=p.focusOffset,H=null===(n=null==f?void 0:f.textContent)||void 0===n?void 0:n[E-1],C=null===(a=null==f?void 0:f.textContent)||void 0===a?void 0:a[E-2],x=!!(null===(l=null===(o=null===(i=null==f?void 0:f.parentElement)||void 0===i?void 0:i.classList)||void 0===o?void 0:o.contains)||void 0===l?void 0:l.call(o,"hash")),N=x&&!!(null===(c=null===(d=null===(r=null==f?void 0:f.parentElement)||void 0===r?void 0:r.classList)||void 0===d?void 0:d.contains)||void 0===c?void 0:c.call(d,"complete-hash")),T=!(null==C?void 0:C.trim())&&(null==f?void 0:f.nodeType)===Node.TEXT_NODE&&!x&&"#"===H;if(this.hashId&&x){const e=f.parentElement,t=e.textContent.replace("#","");this.config.onWriteHash&&this.config.onWriteHash(t),t===(null===(h=this.config.list[0])||void 0===h?void 0:h.name)?e.dataset.id=String(this.config.list[0].id):e.dataset.id="0",e.dataset.name=t,this.updateCurrentHashList()}if(T){this.hashId="hash-".concat(t());const e=null!==(u=null==f?void 0:f.textContent)&&void 0!==u?u:"",n=e.slice(0,E-1),a=e.slice(E),s=document.createElement("span");s.id=this.hashId,s.className="hash",s.textContent="#",s.dataset.id="0",s.dataset.name=e,f.textContent=n;const i=f.parentNode;i.insertBefore(s,f.nextSibling);const o=document.createTextNode(a);i.insertBefore(o,s.nextSibling);const l=g.querySelector("#".concat(this.hashId));if(!l)return;v.setStart(l,1),v.collapse(!0),p.removeAllRanges(),p.addRange(v)}else if(x&&1===E&&" "===H){this.hashId="";const e=window.getSelection(),t=e.getRangeAt(0),n=t.startContainer.parentNode;n.textContent=n.textContent.trimStart();const a=document.createTextNode(" ");n.parentNode.insertBefore(a,n),t.setStartBefore(a),t.setEndBefore(a),e.removeAllRanges(),e.addRange(t)}else{if(x&&f.textContent.split(" ").length>1){this.hashId="";const[e,t]=f.textContent.split(" "),n=document.createTextNode("Â "),a=document.createTextNode("".concat(e," ")),s=document.createTextNode(t);return f.parentNode.parentNode.insertBefore(s,f.parentNode.nextSibling),E!==f.textContent.length?(f.parentElement.replaceWith(a),v.setStartBefore(s),v.setEndBefore(s)):(f.textContent=e,"#"===e?(f.parentElement.replaceWith(a),v.setStartAfter(a),v.setEndAfter(a)):(f.parentNode.parentNode.insertBefore(n,f.parentNode.nextSibling),v.setStartAfter(s),v.setEndAfter(s))),p.removeAllRanges(),void p.addRange(v)}if(x&&!s(f.parentElement.textContent)){this.hashId="";const e=p.getRangeAt(0).startOffset,t=f.parentNode,n=t.textContent.split("#");if((null==n?void 0:n.length)>2){const e=document.createTextNode(f.parentElement.textContent);f.parentElement.replaceWith(e);const t=document.createRange();t.setStart(e,e.length),t.setEnd(e,e.length),p.removeAllRanges(),p.addRange(t)}const[a,s]=n;if(s&&s===f.parentElement.dataset.name){const n=document.createTextNode(a);t.textContent="#".concat(s),t.parentNode.insertBefore(n,t);const i=document.createRange();i.setStart(n,e),i.setEnd(n,e),p.removeAllRanges(),p.addRange(i)}else if(s){const t=document.createTextNode("".concat(f.textContent," "));f.parentElement.parentNode.replaceChild(t,f.parentNode);const n=document.createRange();n.setStart(t,e),n.setEnd(t,e),p.removeAllRanges(),p.addRange(n)}return}if(N&&f.parentElement.dataset.name.trim()!==f.parentElement.textContent.replace("#","").trim()){f.parentElement.classList.remove("complete-hash"),f.parentElement.dataset.id="0",f.parentElement.dataset.name=f.parentElement.textContent.replace("#","").trim();for(const e in f.parentElement.dataset)delete f.parentElement.dataset[e];this.hashId=f.parentElement.id,v.setStart(f,E),v.collapse(!0),p.removeAllRanges(),p.addRange(v)}}T||x||(this.hashId=""),T||!x||N||this.hashId||!(null===(m=f.parentElement)||void 0===m?void 0:m.id)||(this.hashId=f.parentElement.id),!T&&x&&this.hashId&&!f.textContent.slice(-1).trim()&&this.leaveHashTag(),this.currentHashList.length!==this.getAllHashTag().length&&this.updateCurrentHashList()}handleUndoRedo(){var e;const t=document.createRange();if(null===(e=t.startContainer.classList)||void 0===e?void 0:e.contains("hash")){const e=t.startContainer,n=e.id;this.hashId||(this.config.onWriteHash&&this.config.onWriteHash(e.innerText.replace("#","")),this.hashId=n)}else this.hashId=""}handlePaste(e){let{event:t}=e;var n,a,i;const o=window.getSelection(),l=o.focusNode,r=!!(null===(i=null===(a=null===(n=null==l?void 0:l.parentElement)||void 0===n?void 0:n.classList)||void 0===a?void 0:a.contains)||void 0===i?void 0:i.call(a,"hash")),d=t.nativeEvent.clipboardData.getData("text");if(r&&s(d)){const e=l.parentElement,n=document.createTextNode(d);e.nextSibling?e.parentNode.insertBefore(n,e.nextSibling):e.parentNode.appendChild(n);const a=document.createRange();a.setStartAfter(n),a.collapse(!0),o.removeAllRanges(),o.addRange(a),t.preventDefault()}}observe(e){let{setTargetHashId:t,setConfig:n}=e;this.setTargetHashId=t,this.setNewConfig=n}}export{i as default};
