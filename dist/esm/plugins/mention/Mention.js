import{__awaiter as t}from"../../_virtual/_tslib.js";import e from"react";import n from'./../../ext/lodash/uniqueId.js';import i from"./components/MentionList.js";import o from"./components/MentionContainer.js";import{checkValidMention as l}from"../../utils/pluginUtils.js";class s{constructor(t){let{contentEditableEl:e}=t;this.commandKey="mention",this.currentMentionList=[],this._config={list:[],onWriteMention:t=>{}},this.contentEditableEl=e}set mentionId(t){this._mentionId=t,this.setTargetMentionId&&this.setTargetMentionId(this._mentionId),t?this.config.onOpenMentionList&&this.config.onOpenMentionList():this.config.onCloseMentionList&&this.config.onCloseMentionList()}get mentionId(){return this._mentionId}set config(t){this._config=t,this.setNewConfig&&this.setNewConfig(t)}get config(){return this._config}setConfig(t){this.config=Object.assign(Object.assign({},this.config),null!=t?t:{})}component(t){let{plugin:n}=t;return e.createElement(o,{mention:n},(t=>{let{config:o,targetMentionId:l}=t;return e.createElement(i,{ref:t=>{n.mentionListRef=t},targetMentionId:l,contentEditableEl:n.contentEditableEl,list:o.detectDuplicate?o.list.filter((t=>this.currentMentionList.every((e=>e.name!==t.name)))):o.list,listElement:o.listElement,selectMentionItem:t=>{n.selectMentionItem(t)},closeMentionList:()=>{n.mentionId=""}})}))}getCurrentMentionList(){const t=this.contentEditableEl.current.querySelectorAll(".mention.complete-mention"),e=Array.from(t).map((t=>Object.assign(Object.assign({},Object.fromEntries(Object.entries(t.dataset))),{name:t.textContent.replace("@","").trim()})));return this.currentMentionList=e,this.config.onCompleteMention&&this.config.onCompleteMention({allMention:e}),e}leaveMentionTag(){let{mention:t,keepTag:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var n,i,o,l,s;const a=window.getSelection(),r=document.createRange(),c=this.contentEditableEl.current,d=this.mentionId,m=c.querySelector("#".concat(d));if(!m)return;const u="@"===(null===(n=null==m?void 0:m.textContent)||void 0===n?void 0:n.trim())&&!t,v=!!(null==m?void 0:m.classList.contains("will-mention")),g=new RegExp('<span\\s+id="'.concat(d,'"([^>]*)class="mention ').concat(v?"will-mention":"unknown-mention",'"([^>]*)>(.*?)<\\/span>'),"g");if(u){const t=document.createTextNode(null===(i=m.firstChild)||void 0===i?void 0:i.textContent);m.replaceWith(t);const e=document.createRange();return e.setStartAfter(t),e.setEndAfter(t),a.removeAllRanges(),a.addRange(e),void(this.mentionId="")}if(t){c.innerHTML=c.innerHTML.replace(g,'<span id="'.concat(d,'" class="mention complete-mention"$1$2>@').concat(t.name.trim(),"</span>"));const e=c.querySelector("#".concat(d));e.dataset.id=String(t.id),e.dataset.name=t.name.trim(),e.textContent="@".concat(t.name.trim())}else if(!e){const t=a.focusNode.textContent.trim();c.innerHTML=c.innerHTML.replace(g,'<span id="'.concat(d,'" class="mention unknown-mention"$1$2>').concat(t,"</span>"))}this.mentionId="";const f=null===(o=c.querySelector("#".concat(d)))||void 0===o?void 0:o.nextSibling;(Node.TEXT_NODE!==(null==f?void 0:f.TEXT_NODE)||(null===(l=null==f?void 0:f.nodeValue)||void 0===l?void 0:l.trim()))&&c.querySelector("#".concat(d)).insertAdjacentHTML("afterend","&nbsp;");const h=u?c:null===(s=c.querySelector("#".concat(d)))||void 0===s?void 0:s.nextSibling;u?(r.selectNodeContents(h),r.collapse(!1)):(r.setStart(h,1),r.collapse(!0)),a.removeAllRanges(),a.addRange(r),this.contentEditableEl.current.dispatchEvent(new Event("input",{bubbles:!0}))}handleClick(t){var e,n,i,o,l;const s=window.getSelection(),a=s.focusNode,r=!!(null===(i=null===(n=null===(e=null==a?void 0:a.parentElement)||void 0===e?void 0:e.classList)||void 0===n?void 0:n.contains)||void 0===i?void 0:i.call(n,"mention")),c=s.getRangeAt(0);r&&c.startOffset>0&&c.startOffset===c.endOffset&&(this.config.onWriteMention&&this.config.onWriteMention(null===(l=null===(o=null==a?void 0:a.parentElement)||void 0===o?void 0:o.textContent)||void 0===l?void 0:l.replace("@","")),this.mentionId=a.parentElement.id)}selectMentionItem(e){var n;return t(this,void 0,void 0,(function*(){const t=this.mentionListRef.handleSubmit(e);if(Number(this.contentEditableEl.current.ariaValueMax)<=(null!==(n=null==t?void 0:t.name)&&void 0!==n?n:"").length+this.contentEditableEl.current.textContent.length)return void(this.mentionId="");const i=this.contentEditableEl.current.querySelectorAll(".mention.complete-mention");if(this.config.maxMentionCnt&&this.config.maxMentionCnt<=i.length)return this.mentionId="",this.contentEditableEl.current.blur(),void(this.config.onMaxMentionList?yield this.config.onMaxMentionList():alert("최대 ".concat(this.config.maxMentionCnt,"개 까지 작성이 가능합니다.")));this.leaveMentionTag({mention:t});const o=Array.from(i).map((t=>Object.assign(Object.assign({},Object.fromEntries(Object.entries(t.dataset))),{name:t.textContent.replace("@","").trim()})));this.currentMentionList=[...o,t],this.config.onCompleteMention&&this.config.onCompleteMention({allMention:this.currentMentionList,currentMention:t})}))}handleKeyDown(t){let{event:e}=t;var n,i,o,l,s,a,r,c,d,m,u,v,g;const f=window.getSelection(),h=document.createRange(),p=this.mentionId,E=f.focusNode,M=f.focusOffset,C=!!(null===(o=null===(i=null===(n=null==E?void 0:E.parentElement)||void 0===n?void 0:n.classList)||void 0===i?void 0:i.contains)||void 0===o?void 0:o.call(i,"mention")),x=!!(null===(a=null===(s=null===(l=null==E?void 0:E.parentElement)||void 0===l?void 0:l.classList)||void 0===s?void 0:s.contains)||void 0===a?void 0:a.call(s,"will-mention"))||!!(null===(d=null===(c=null===(r=null==E?void 0:E.parentElement)||void 0===r?void 0:r.classList)||void 0===c?void 0:c.contains)||void 0===d?void 0:d.call(c,"unknown-mention"));if("ArrowLeft"!==e.code&&"ArrowRight"!==e.code||(!p&&M>1&&C?(this.config.onWriteMention&&this.config.onWriteMention(null===(u=null===(m=null==E?void 0:E.parentElement)||void 0===m?void 0:m.textContent)||void 0===u?void 0:u.replace("@","")),this.mentionId=E.parentElement.id):C&&p&&M<=1?this.mentionId="":C&&p&&"@"===(null===(v=E.firstChild)||void 0===v?void 0:v.textContent)?this.leaveMentionTag():(p&&!C||p&&C&&!x&&M>=E.textContent.length)&&(this.mentionId="")),"ArrowRight"===e.code)p&&x&&!E.parentElement.nextElementSibling&&!e.nativeEvent.isComposing?(e.preventDefault(),this.leaveMentionTag()):p&&"@"===(null===(g=E.firstChild)||void 0===g?void 0:g.textContent)&&this.leaveMentionTag();else if("ArrowUp"===e.code||"ArrowDown"===e.code)p&&(e.preventDefault(),"ArrowUp"===e.code?this.mentionListRef.handleArrowUp():this.mentionListRef.handleArrowDown());else if("Enter"===e.code)if(p&&!e.nativeEvent.isComposing)e.preventDefault(),this.selectMentionItem();else if(C&&M<=1){e.preventDefault();const t=document.createElement("br");E.parentElement.parentNode.insertBefore(t,E.parentElement),h.setStartAfter(t),h.setEndAfter(t),f.removeAllRanges(),f.addRange(h)}}handleChange(t){var e,i,o,s,a,r,c,d,m,u;const v=window.getSelection(),g=this.contentEditableEl.current,f=v.focusNode,h=v.focusOffset,p=null===(e=null==f?void 0:f.textContent)||void 0===e?void 0:e[h-1],E=null===(i=null==f?void 0:f.textContent)||void 0===i?void 0:i[h-2],M=!!(null===(a=null===(s=null===(o=null==f?void 0:f.parentElement)||void 0===o?void 0:o.classList)||void 0===s?void 0:s.contains)||void 0===a?void 0:a.call(s,"mention")),C=!!(null===(d=null===(c=null===(r=null==f?void 0:f.parentElement)||void 0===r?void 0:r.classList)||void 0===c?void 0:c.contains)||void 0===d?void 0:d.call(c,"complete-mention")),x=this.contentEditableEl.current.querySelectorAll(".mention.complete-mention"),b=!(null==E?void 0:E.trim())&&(null==f?void 0:f.nodeType)===Node.TEXT_NODE&&!M&&"@"===p;if(this.mentionId&&M&&this.config.onWriteMention&&this.config.onWriteMention(f.parentElement.firstChild.textContent.replace("@","")),b&&(null!=x?x:[]).length>=this.config.maxMentionCnt)this.config.onMaxMentionList?this.config.onMaxMentionList():alert("최대 ".concat(this.config.maxMentionCnt,"개 까지 작성이 가능합니다."));else if(b){const t=document.createRange();this.mentionId="mention-".concat(n());const e=null!==(m=f.textContent)&&void 0!==m?m:"",i=e.slice(0,h-1),o=e.slice(h),l=document.createElement("span");l.id=this.mentionId,l.className="mention will-mention",l.textContent="@",f.textContent=i;const s=f.parentNode;s.insertBefore(l,f.nextSibling);const a=document.createTextNode(o);s.insertBefore(a,l.nextSibling);const r=g.querySelector("#".concat(this.mentionId));if(!r)return;t.setStart(r,1),t.collapse(!0),v.removeAllRanges(),v.addRange(t)}else if(M&&1===h&&" "===p){this.mentionId="";const t=window.getSelection(),e=t.getRangeAt(0),n=e.startContainer.parentNode;n.textContent=n.textContent.trimStart();const i=document.createTextNode(" ");n.parentNode.insertBefore(i,n),e.setStartBefore(i),e.setEndBefore(i),t.removeAllRanges(),t.addRange(e)}else{if(M&&f.textContent.split(" ").length>1){this.mentionId="";const t=document.createRange(),[e,n]=f.textContent.split(" "),i=document.createTextNode(" "),o=document.createTextNode("".concat(e," ")),l=document.createTextNode(n);return f.parentNode.parentNode.insertBefore(l,f.parentNode.nextSibling),h!==f.textContent.length?(f.parentElement.replaceWith(o),t.setStartBefore(l),t.setEndBefore(l)):(f.textContent=e,f.parentNode.parentNode.insertBefore(i,f.parentNode.nextSibling),t.setStartAfter(l),t.setEndAfter(l)),v.removeAllRanges(),void v.addRange(t)}if(M&&!l(f.textContent)){this.mentionId="";const t=v.getRangeAt(0).startOffset,e=document.createTextNode("".concat(f.textContent," "));f.parentElement.parentNode.replaceChild(e,f.parentNode);const n=document.createRange();return n.setStart(e,t),n.setEnd(e,t),v.removeAllRanges(),void v.addRange(n)}if(C&&f.parentElement.dataset.name.trim()!==f.parentElement.textContent.replace("@","").trim()){const t=document.createRange();f.parentElement.classList.replace("complete-mention","will-mention");for(const t in f.parentElement.dataset)delete f.parentElement.dataset[t];this.mentionId=f.parentElement.id,t.setStart(f,null!=h?h:0),t.collapse(!0),v.removeAllRanges(),v.addRange(t)}}return b||M||(this.mentionId=""),b||!M||C||this.mentionId||!(null===(u=f.parentElement)||void 0===u?void 0:u.id)||(this.mentionId=f.parentElement.id),!b&&M&&this.mentionId&&!f.textContent.slice(-1).trim()&&this.leaveMentionTag(),this.currentMentionList.length!==x.length&&this.getCurrentMentionList(),!1}handleUndoRedo(){var t;const e=document.createRange();if(null===(t=e.startContainer.classList)||void 0===t?void 0:t.contains("mention")){const t=e.startContainer,n=t.id;this.mentionId||(this.config.onWriteMention&&this.config.onWriteMention(t.innerText.replace("@","")),this.mentionId=n)}else this.mentionId=""}handlePaste(t){let{event:e}=t;var n,i,o;const s=window.getSelection(),a=s.focusNode,r=!!(null===(o=null===(i=null===(n=null==a?void 0:a.parentElement)||void 0===n?void 0:n.classList)||void 0===i?void 0:i.contains)||void 0===o?void 0:o.call(i,"mention")),c=e.nativeEvent.clipboardData.getData("text");if(r&&l(c)){const t=a.parentElement,n=document.createTextNode(c);t.nextSibling?t.parentNode.insertBefore(n,t.nextSibling):t.parentNode.appendChild(n);const i=document.createRange();i.setStartAfter(n),i.collapse(!0),s.removeAllRanges(),s.addRange(i),e.preventDefault()}}observe(t){let{setTargetMentionId:e,setConfig:n}=t;this.setTargetMentionId=e,this.setNewConfig=n}}export{s as default};
