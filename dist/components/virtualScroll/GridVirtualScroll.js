"use strict";var e=require("@babel/runtime/helpers/typeof"),n=require("@babel/runtime/helpers/toConsumableArray"),t=require("@babel/runtime/helpers/slicedToArray"),r=require("react"),i=require("../../utils/forReactUtils.js"),u=require("../loadings/Spinner.js"),o=require("../noData/NoDataText.js"),l=require("./imageCacher.js"),a=require("./VirtualScroll.module.scss.js");function c(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=function(e,n){if(e){if("string"==typeof e)return s(e,n);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?s(e,n):void 0}}(e))||n){t&&(e=t);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,l=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return o=e.done,e},e:function(e){l=!0,u=e},f:function(){try{o||null==t.return||t.return()}finally{if(l)throw u}}}}function s(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=Array(n);t<n;t++)r[t]=e[t];return r}"undefined"==typeof window&&(r.useLayoutEffect=r.useEffect);var d=i.makeCxFunc(a),f=r.memo((function(e){var n,i=e.width,u=e.gapX,o=e.gapY,l=e.rowIndex,a=e.columnIndex,c=e.startIndex,s=e.children;r.useRef();var f=r.useState(),m=t(f,2),v=m[0],h=m[1],g=r.useState({position:"absolute",width:i,top:(null!==(n=null==v?void 0:v.offsetHeight)&&void 0!==n?n:0+o)*(c+a),left:l?(i+u)*l:0,zIndex:1}),p=t(g,2),x=p[0],y=p[1],b=r.useCallback((function(){if(v){var e=v.offsetHeight;y((function(n){return Object.assign(Object.assign({},n),{width:i,left:l?(i+u)*l:0,top:(e+o)*(c+a),visibility:"visible"})}))}}),[v,i,l,u,o,c,a]);return r.useLayoutEffect((function(){b()}),[b]),r.createElement("div",{ref:h,className:d("virtual-item"),style:x},s)}));f.displayName="VirtualItem";var m=function(i){var a,s,m,v,h,g,p,x,y=i.list,b=i.className,I=void 0===b?"":b,w=i.scrollTarget,E=i.preloadRowCnt,M=void 0===E?2:E,j=i.itemWidth,A=i.itemHeight,S=i.gapX,R=i.gapY,W=i.loading,C=i.loadingElement,q=void 0===C?r.createElement(u,null):C,H=i.skeletonElement,k=i.skeletonCnt,O=void 0===k?3:k,Y=i.noDataMsg,N=i.element,T=r.useRef(),F=r.useRef(null),L=r.useRef(0),X=r.useRef(0),D=r.useRef(0),z=r.useRef(0),U=r.useRef({startIndex:0,endIndex:10}),V=r.useState(!!y),B=t(V,1)[0],$=r.useState({startIndex:0,endIndex:10}),G=t($,2),J=G[0],K=G[1],P=r.useState({containerWidth:null!==(s=null===(a=T.current)||void 0===a?void 0:a.clientWidth)&&void 0!==s?s:0,width:"number"==typeof j?j:j(null!==(v=null===(m=T.current)||void 0===m?void 0:m.clientWidth)&&void 0!==v?v:0),gapX:"number"==typeof S?S:S(null!==(g=null===(h=T.current)||void 0===h?void 0:h.clientWidth)&&void 0!==g?g:0),gapY:"number"==typeof R?R:R(null!==(x=null===(p=T.current)||void 0===p?void 0:p.clientWidth)&&void 0!==x?x:0)}),Q=t(P,2),Z=Q[0],_=Q[1],ee=r.useMemo((function(){if("undefined"!=typeof window)return new ResizeObserver((function(e){var n,t=c(e);try{for(t.s();!(n=t.n()).done;){var r=n.value.target.clientWidth;_({containerWidth:null!=r?r:0,width:"number"==typeof j?j:j(null!=r?r:0),gapX:"number"==typeof S?S:S(null!=r?r:0),gapY:"number"==typeof R?R:R(null!=r?r:0)})}}catch(e){t.e(e)}finally{t.f()}}))}),[S,R,j]),ne=r.useMemo((function(){return W||!y}),[W,y]),te=r.useMemo((function(){var e=Array.from({length:O}).map((function(){}));return function(e){for(var n=Z.containerWidth,t=Z.width,r=parseInt((n/t).toString()),i=Math.ceil(e.length/r)||0,u=new Array(i),o=0;o<i;o++)u[o]=e.slice(o*r,(o+1)*r).map((function(e,n){return e}));return u}(ne?e:y)}),[y,ne,Z,O]),re=r.useMemo((function(){return te.slice(J.startIndex,J.endIndex)}),[J,te]),ie=r.useMemo((function(){var e="number"==typeof A?A:A(Z.containerWidth);if(T.current){var t=n(T.current.children);t.length&&(T.current.style.minHeight="");var r=Math.max.apply(Math,n(t.map((function(e){var n;return(null!==(n=e.offsetHeight)&&void 0!==n?n:0)+Z.gapY}))).concat([0]))||e||0;return L.current=r,r}return e||0}),[te,re,Z,A]),ue=r.useMemo((function(){if(y||H){var e=Z.containerWidth,n=Z.width,t=Z.gapX;return parseInt(((e+t)/(n+t)).toString()),ie>0?te.length*ie:0}}),[y,H,Z,O,ie,te.length]),oe=r.useCallback((function(){var e=w?"current"in w?w.current:w:null,n=e?e.scrollTop:window.scrollY,t=e?e.offsetHeight:window.innerHeight,r=e?e.scrollHeight:document.body.scrollHeight,i=X.current>n?0:Math.floor((n-X.current)/ie)-M,u=Math.ceil((n+t)/ie)+M;return r===n+t?{startIndex:U.current.startIndex,endIndex:U.current.endIndex}:{startIndex:ie&&i>=0?i:0,endIndex:ie&&u?u:10}}),[ie,M,w]),le=r.useCallback((function(){var e=w?"current"in w?w.current:w:null,n=e?e.scrollTop:window.scrollY,t=Date.now(),r=n-z.current,i=r>0,u=i?r:-1*r;null!==F.current&&cancelAnimationFrame(F.current),F.current=requestAnimationFrame((function(){var e=oe();return u>0&&n>0&&(i&&e.endIndex<U.current.endIndex||!i&&e.startIndex>U.current.startIndex)?(cancelAnimationFrame(F.current),void(F.current=null)):(i&&u>ie?e.endIndex+=Math.floor(u/ie):!i&&u>ie&&(e.startIndex-=Math.floor(u/ie),e.startIndex<=0&&(e.startIndex=0)),t-D.current>=200||n<=0||0===u?(K(e),z.current=n,U.current=Object.assign({},e),D.current=t,void(F.current=null)):u>=ie*(M/2)?(K(e),z.current=n,D.current=t,U.current=Object.assign({},e),void(F.current=null)):void((U.current.endIndex-e.endIndex>M||e.startIndex-U.current.startIndex>M)&&(K(e),z.current=n,D.current=t,U.current=Object.assign({},e))))}))}),[oe,ie,M,w]);return r.useEffect((function(){if(ee){var e=T.current;return ee.observe(e),function(){e&&ee.unobserve(e)}}}),[T,ee]),r.useEffect((function(){if(T.current){var e=T.current.getBoundingClientRect().top;X.current=window.scrollY+e}}),[]),r.useEffect((function(){if("undefined"!=typeof window&&T.current){var e=w?"current"in w?w.current:w:window;return le(),null==e||e.removeEventListener("scroll",le),null==e||e.addEventListener("scroll",le),function(){null!==F.current&&cancelAnimationFrame(F.current),null==e||e.removeEventListener("scroll",le)}}}),[w,F,le]),r.createElement("div",{ref:T,className:d(I,"virtual-scroll",{"no-data":!!y&&!y.length}),style:{height:ue,minHeight:B&&!re.length?"9999999px":0}},ne&&!H&&r.createElement("div",{className:d("loading")},q),!ne&&0===y.length&&("object"===e(Y)?Y:r.createElement(o,{className:d("no-msg-comp"),nullText:Y})),re.map((function(e,n){return e.map((function(t,i){var u=(J.startIndex+n)*e.length+i,o=n*e.length+i;return r.createElement(f,Object.assign({key:"".concat(o,"-").concat(Z.containerWidth).concat(ne?"skeleton":"")},Z,{rowIndex:i,columnIndex:n,startIndex:J.startIndex}),r.createElement("div",null,r.cloneElement(y?r.createElement(N):H,{item:t,imageCacher:l,index:u})))}))})))},v=r.memo(m);module.exports=v;
