"use strict";var e=require("@babel/runtime/helpers/typeof"),n=require("@babel/runtime/helpers/toConsumableArray"),t=require("@babel/runtime/helpers/slicedToArray"),r=require("react"),i=require("../../utils/forReactUtils.js"),u=require("../loadings/Spinner.js"),a=require("../noData/NoDataText.js"),o=require("./imageCacher.js"),c=require("./VirtualScroll.module.scss.js");function l(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=function(e,n){if(e){if("string"==typeof e)return s(e,n);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?s(e,n):void 0}}(e))||n){t&&(e=t);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,a=!0,o=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return a=e.done,e},e:function(e){o=!0,u=e},f:function(){try{a||null==t.return||t.return()}finally{if(o)throw u}}}}function s(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=Array(n);t<n;t++)r[t]=e[t];return r}"undefined"==typeof window&&(r.useLayoutEffect=r.useEffect);var d=i.makeCxFunc(c),f=r.memo((function(e){var n,i,u=e.gapY,a=e.index,o=e.resizeObserver,c=e.children,l=e.heightList,s=e.updateHeight,f=r.useRef(),m=r.useState({position:"absolute",width:"100%",top:(null!==(i=null===(n=f.current)||void 0===n?void 0:n.offsetHeight)&&void 0!==i?i:0+u)*a,left:0,zIndex:1,visibility:l[a]?"visible":"hidden"}),v=t(m,2),h=v[0],g=v[1],b=r.useCallback((function(){if(f.current){var e=f.current.offsetHeight;s(e,a)}}),[a,s]),p=r.useCallback((function(){if(l[a]){var e=l.slice(0,a).reduce((function(e,n){return e+n}),0);g((function(n){return Object.assign(Object.assign({},n),{left:0,top:e+u,visibility:"visible"})}))}else b()}),[u,l,a,b]);return r.useEffect((function(){p()}),[p]),r.useEffect((function(){var e=f.current;return o.observe(e),function(){o.unobserve(e)}}),[o]),r.createElement("div",{ref:f,"data-index":a,className:d("virtual-item"),style:h},c)}));f.displayName="VirtualItem";var m=function(i){var c,s,m,v,h=i.className,g=void 0===h?"":h,b=i.scrollTarget,p=i.list,x=i.preloadCnt,y=void 0===x?5:x,I=i.itemHeight,E=i.gapY,w=void 0===E?0:E,j=i.loading,A=i.loadingElement,M=void 0===A?r.createElement(u,null):A,C=i.skeletonElement,S=i.skeletonCnt,k=void 0===S?3:S,q=i.noDataMsg,O=i.element,H=r.useRef(),N=r.useRef(null),R=r.useRef(0),W=r.useRef(0),Y=r.useRef({startIndex:0,endIndex:50}),T=r.useState(!!p),L=t(T,1)[0],F=r.useState([]),z=t(F,2),D=z[0],U=z[1],V=r.useState({startIndex:0,endIndex:50}),$=t(V,2),B=$[0],G=$[1],J=r.useState({containerWidth:null!==(s=null===(c=H.current)||void 0===c?void 0:c.clientWidth)&&void 0!==s?s:0,gapY:"number"==typeof w?w:w(null!==(v=null===(m=H.current)||void 0===m?void 0:m.clientWidth)&&void 0!==v?v:0)}),K=t(J,2),P=K[0],Q=K[1],X=r.useMemo((function(){return r.createElement(O)}),[O]),Z=r.useMemo((function(){return new ResizeObserver((function(e){var n,t,r=l(e);try{var i=function(){var e=t.value.target,r=e.clientWidth,i=e.offsetHeight,u=e.dataset,a=Number(null!==(n=u.index)&&void 0!==n?n:-1);-1===a?Q({containerWidth:null!=r?r:0,gapY:"number"==typeof w?w:w(null!=r?r:0)}):U((function(e){return e.map((function(e,n){return n===a?i:e}))}))};for(r.s();!(t=r.n()).done;)i()}catch(e){r.e(e)}finally{r.f()}}))}),[w]),_=r.useMemo((function(){return j||!p}),[j,p]),ee=r.useMemo((function(){return p||C?_?Array.from({length:k}).map((function(){})):p.slice(B.startIndex,B.endIndex):[]}),[p,C,B,k,_]),ne=r.useMemo((function(){var e="number"==typeof I?I:I(P.containerWidth);return D.filter((function(e){return!!e})).length?Math.max.apply(Math,n(D.filter((function(e){return!!e})))):e}),[D,I,P.containerWidth]),te=r.useMemo((function(){var e=p?p.length:k;return e>0&&D.length===e?D.reduce((function(e,n){return e+n+P.gapY}),0):ne>0?ne*e:0}),[p,k,D,ne,P.gapY]),re=r.useCallback((function(){var e=b?"current"in b?b.current:b:null,n=e?e.scrollTop:window.scrollY,t=e?e.offsetHeight:window.innerHeight,r=D.reduce((function(e,n){var t,r=(null!==(t=e[e.length-1])&&void 0!==t?t:0)+n;return e.push(r),e}),[]),i=r.findIndex((function(e){return e>=n})),u=r.findIndex((function(e){return e>=n+t}));return-1===i?i=Y.current.startIndex:(i=i-10-y,i=ne&&i>0?i:0),-1===u?u=Y.current.endIndex:(u=u+10+y,u=ne&&u>0?u:50),{startIndex:i,endIndex:u}}),[b,D,ne,y]),ie=r.useCallback((function(e,n){(p||C)&&U((function(t){return t[n]=e,t.slice(0,p?p.length:k)}))}),[p,C,k]),ue=r.useCallback((function(){var e=b?"current"in b?b.current:b:null,n=e?e.scrollTop:window.scrollY,t=Date.now(),r=n-W.current,i=r>0,u=Math.abs(r);null!==N.current&&cancelAnimationFrame(N.current),N.current=requestAnimationFrame((function(){var e=re();return u>0&&n>0&&(i&&e.endIndex<Y.current.endIndex||!i&&e.startIndex>Y.current.startIndex)?(cancelAnimationFrame(N.current),void(N.current=null)):(i&&u>ne?e.endIndex+=Math.floor(u/ne):!i&&u>ne&&(e.startIndex-=Math.floor(u/ne),e.startIndex<=0&&(e.startIndex=0)),t-R.current>=200||n<=0||0===u?(G(e),W.current=n,Y.current=Object.assign({},e),R.current=t,void(N.current=null)):void(u>=ne*(y/2)?(G(e),W.current=n,Y.current=Object.assign({},e),R.current=t,N.current=null):(Y.current.endIndex-e.endIndex>y||e.startIndex-Y.current.startIndex>y)&&(G(e),W.current=n,R.current=t,Y.current=Object.assign({},e))))}))}),[re,ne,y,b]);return r.useEffect((function(){Z.observe(H.current)}),[H,Z]),r.useEffect((function(){if("undefined"!=typeof window&&H.current){var e=b?"current"in b?b.current:b:window;return ue(),e.removeEventListener("scroll",ue),e.addEventListener("scroll",ue),function(){null!==N.current&&cancelAnimationFrame(N.current),e.removeEventListener("scroll",ue)}}}),[b,N,ue]),r.createElement("div",{ref:H,className:d(g,"virtual-scroll",{"no-data":p&&!p.length}),style:{height:te,minHeight:L&&!p?"100000px":0}},_&&!C&&r.createElement("div",{className:d("loading")},M),!_&&0===p.length&&("object"===e(q)?q:r.createElement(a,{className:d("no-msg-comp"),nullText:q})),ee.map((function(e,n){var t=B.startIndex+n;return r.createElement(f,Object.assign({key:"".concat(t,"-").concat(P.containerWidth,"-").concat(p?"":"skeleton")},P,{index:t,resizeObserver:Z,heightList:D,updateHeight:ie}),r.createElement("div",null,r.cloneElement(p?X:C,{item:e,imageCacher:o,index:t})))})))},v=r.memo(m);module.exports=v;
