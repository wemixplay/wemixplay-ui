"use strict";var e=require("react"),t=require("../../utils/forReactUtils.js"),n=require("../loadings/Spinner.js"),r=require("../noData/NoDataText.js"),s=require("./imageCacher.js"),l=require("./VirtualScroll.module.scss.js");"undefined"==typeof window&&(e.useLayoutEffect=e.useEffect);const i=t.makeCxFunc(l),c=e.memo((t=>{let{gapY:n,index:r,resizeObserver:s,children:l,heightList:c,updateHeight:a}=t;var u,o;const d=e.useRef(),[m,f]=e.useState({position:"absolute",width:"100%",top:(null!==(o=null===(u=d.current)||void 0===u?void 0:u.offsetHeight)&&void 0!==o?o:0+n)*r,left:0,zIndex:1,visibility:c[r]?"visible":"hidden"}),g=e.useCallback((()=>{if(d.current){const e=d.current.offsetHeight;a(e,r)}}),[r,a]),h=e.useCallback((()=>{if(c[r]){const e=c.slice(0,r).reduce(((e,t)=>e+t),0);f((t=>Object.assign(Object.assign({},t),{left:0,top:e+n,visibility:"visible"})))}else g()}),[n,c,r,g]);return e.useEffect((()=>{h()}),[h]),e.useEffect((()=>{const e=d.current;return s.observe(e),()=>{s.unobserve(e)}}),[s]),e.createElement("div",{ref:d,"data-index":r,className:i("virtual-item"),style:m},l)}));c.displayName="VirtualItem";const a=t=>{let{className:l="",scrollTarget:a,list:u,preloadCnt:o=5,itemHeight:d,gapY:m=0,loading:f,loadingElement:g=e.createElement(n,null),skeletonElement:h,skeletonCnt:v=3,noDataMsg:x,element:p}=t;var b,I,E,w;const y=e.useRef(),j=e.useRef(null),M=e.useRef(0),k=e.useRef(0),C=e.useRef({startIndex:0,endIndex:50}),[H]=e.useState(!!u),[O,N]=e.useState([]),[R,W]=e.useState({startIndex:0,endIndex:50}),[Y,q]=e.useState({containerWidth:null!==(I=null===(b=y.current)||void 0===b?void 0:b.clientWidth)&&void 0!==I?I:0,gapY:"number"==typeof m?m:m(null!==(w=null===(E=y.current)||void 0===E?void 0:E.clientWidth)&&void 0!==w?w:0)}),S=e.useMemo((()=>e.createElement(p)),[p]),L=e.useMemo((()=>new ResizeObserver((e=>{var t;for(const n of e){const{clientWidth:e,offsetHeight:r,dataset:s}=n.target,l=Number(null!==(t=s.index)&&void 0!==t?t:-1);-1===l?q({containerWidth:null!=e?e:0,gapY:"number"==typeof m?m:m(null!=e?e:0)}):N((e=>e.map(((e,t)=>t===l?r:e))))}}))),[m]),A=e.useMemo((()=>f||!u),[f,u]),F=e.useMemo((()=>u||h?A?Array.from({length:v}).map((()=>{})):u.slice(R.startIndex,R.endIndex):[]),[u,h,R,v,A]),T=e.useMemo((()=>{const e="number"==typeof d?d:d(Y.containerWidth);return O.filter((e=>!!e)).length?Math.max(...O.filter((e=>!!e))):e}),[O,d,Y.containerWidth]),z=e.useMemo((()=>{const e=u?u.length:v;return e>0&&O.length===e?O.reduce(((e,t)=>e+t+Y.gapY),0):T>0?T*e:0}),[u,v,O,T,Y.gapY]),D=e.useCallback((()=>{const e=a?"current"in a?a.current:a:null,t=e?e.scrollTop:window.scrollY,n=e?e.offsetHeight:window.innerHeight,r=O.reduce(((e,t)=>{var n;const r=(null!==(n=e[e.length-1])&&void 0!==n?n:0)+t;return e.push(r),e}),[]);let s=r.findIndex((e=>e>=t)),l=r.findIndex((e=>e>=t+n));return-1===s?s=C.current.startIndex:(s=s-10-o,s=T&&s>0?s:0),-1===l?l=C.current.endIndex:(l=l+10+o,l=T&&l>0?l:50),{startIndex:s,endIndex:l}}),[a,O,T,o]),V=e.useCallback(((e,t)=>{(u||h)&&N((n=>(n[t]=e,n.slice(0,u?u.length:v))))}),[u,h,v]),U=e.useCallback((()=>{const e=a?"current"in a?a.current:a:null,t=e?e.scrollTop:window.scrollY,n=Date.now(),r=t-k.current,s=r>0,l=Math.abs(r);null!==j.current&&cancelAnimationFrame(j.current),j.current=requestAnimationFrame((()=>{const e=D();return l>0&&t>0&&(s&&e.endIndex<C.current.endIndex||!s&&e.startIndex>C.current.startIndex)?(cancelAnimationFrame(j.current),void(j.current=null)):(s&&l>T?e.endIndex+=Math.floor(l/T):!s&&l>T&&(e.startIndex-=Math.floor(l/T),e.startIndex<=0&&(e.startIndex=0)),n-M.current>=200||t<=0||0===l?(W(e),k.current=t,C.current=Object.assign({},e),M.current=n,void(j.current=null)):void(l>=T*(o/2)?(W(e),k.current=t,C.current=Object.assign({},e),M.current=n,j.current=null):(C.current.endIndex-e.endIndex>o||e.startIndex-C.current.startIndex>o)&&(W(e),k.current=t,M.current=n,C.current=Object.assign({},e))))}))}),[D,T,o,a]);return e.useEffect((()=>{L.observe(y.current)}),[y,L]),e.useEffect((()=>{if("undefined"!=typeof window&&y.current){const e=a?"current"in a?a.current:a:window;return U(),e.removeEventListener("scroll",U),e.addEventListener("scroll",U),()=>{null!==j.current&&cancelAnimationFrame(j.current),e.removeEventListener("scroll",U)}}}),[a,j,U]),e.createElement("div",{ref:y,className:i(l,"virtual-scroll",{"no-data":u&&!u.length}),style:{height:z,minHeight:H&&!u?"100000px":0}},A&&!h&&e.createElement("div",{className:i("loading")},g),!A&&0===u.length&&("object"==typeof x?x:e.createElement(r,{className:i("no-msg-comp"),nullText:x})),F.map(((t,n)=>{const r=R.startIndex+n;return e.createElement(c,Object.assign({key:"".concat(r,"-").concat(Y.containerWidth,"-").concat(u?"":"skeleton")},Y,{index:r,resizeObserver:L,heightList:O,updateHeight:V}),e.createElement("div",null,e.cloneElement(u?S:h,{item:t,imageCacher:s,index:r})))})))};var u=e.memo(a);module.exports=u;
