"use strict";var e=require("@babel/runtime/helpers/slicedToArray"),n=require("../../_virtual/_tslib.js"),t=require("react"),r=require("./WpEditor.module.scss.js"),o=require('./../../ext/lodash/debounce.js'),a=require("./WpEditorContents.js"),i=require("../../utils/forReactUtils.js"),c=require("../../utils/pluginUtils.js");function u(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=function(e,n){if(e){if("string"==typeof e)return l(e,n);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?l(e,n):void 0}}(e))||n){t&&(e=t);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,c=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return i=e.done,e},e:function(e){c=!0,a=e},f:function(){try{i||null==t.return||t.return()}finally{if(c)throw a}}}}function l(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=Array(n);t<n;t++)r[t]=e[t];return r}var s=i.makeCxFunc(r),d=function(e){var n=e.plugin,t=e.contentEditableEl;return n.map((function(e){return new e({contentEditableEl:t})}))},f=t.forwardRef((function(r,i){var l=r.className,f=void 0===l?"":l,p=r.name,v=r.initialValue,h=r.config,m=void 0===h?{}:h,g=r.plugin,b=void 0===g?[]:g,y=r.placeholder,C=r.maxLength,E=r.onClick,k=r.handleChange,T=n.__rest(r,["className","name","initialValue","config","plugin","placeholder","maxLength","onClick","handleChange"]),w=t.useRef(!1),R=t.useRef(),L=t.useRef({index:0,stack:[""],disabled:!1}),x=t.useState(d({plugin:b,contentEditableEl:R})),K=e(x,2),M=K[0],D=K[1],H=t.useMemo((function(){return o((function(){var e;R.current&&L.current.stack[L.current.index]!==(null===(e=R.current)||void 0===e?void 0:e.innerHTML)&&(L.current.stack.push(R.current.innerHTML),L.current.index+=1)}),300)}),[]),N=t.useMemo((function(){if("undefined"!=typeof window)return new MutationObserver((function(){R.current&&L.current&&(L.current.disabled?L.current.disabled=!1:H())}))}),[H]),B=t.useCallback((function(){var e=document.createRange();return{selection:window.getSelection(),range:e}}),[]),j=t.useCallback((function(){var e,n=B(),t=n.selection,r=n.range;return r.selectNodeContents(null!==(e=R.current.lastChild)&&void 0!==e?e:R.current),r.collapse(!1),t.removeAllRanges(),t.addRange(r),r}),[B]),A=t.useCallback((function(e){var n=B().range;if("historyUndo"===e.inputType||"historyRedo"===e.inputType){e.preventDefault&&e.preventDefault();var t=L.current,r=t.index,o=t.stack,a="historyUndo"===e.inputType?r-1:r+1;if(a>=0&&a<o.length){var i=o[a];R.current.innerHTML=i,k&&k(i.replace(/&nbsp;/g," "),p),n=j(),"historyUndo"===e.inputType?L.current.index-=1:L.current.index+=1;var c=n.getBoundingClientRect(),u=R.current.getBoundingClientRect();c.top<u.top?R.current.scrollTop-=u.top-c.top:c.bottom>u.bottom&&(R.current.scrollTop+=c.bottom-u.bottom)}L.current.disabled=!0,M.forEach((function(n){n.handleUndoRedo&&n.handleUndoRedo({type:e.inputType})}))}else{var l=L.current.index;l>0&&(L.current.stack=L.current.stack.slice(0,l+1)),L.current.disabled=!1}}),[p,k,B,M,j]),S=t.useCallback((function(e){var n=B().selection,t=R.current.innerHTML;if((e.ctrlKey&&"KeyB"===e.code||e.metaKey&&"KeyB"===e.code)&&e.preventDefault(),"KeyZ"===e.code&&(e.metaKey||e.ctrlKey)&&e.shiftKey&&(A(Object.assign(Object.assign({},e),{inputType:"historyRedo"})),e.preventDefault()),M.forEach((function(n){n.handleKeyDown&&n.handleKeyDown({event:e})})),!("Enter"!==e.code&&"NumpadEnter"!==e.code||e.shiftKey||e.nativeEvent.isComposing||R.current.innerHTML!==t)){e.preventDefault(),e.stopPropagation(),document.execCommand("insertLineBreak");var r=n.getRangeAt(0);(r=r.cloneRange()).setStart(r.startContainer,0);var o=r.getBoundingClientRect(),a=R.current.getBoundingClientRect();if(o.bottom>a.bottom){var i=o.bottom-a.bottom;R.current.scrollTo({top:R.current.scrollTop+2*i})}}T.onKeyDown&&T.onKeyDown(e)}),[B,A,M,T]),q=t.useCallback((function(e){e.target.innerHTML||(R.current.innerHTML=""),function(){var e=window.getSelection();if(e.rangeCount>0){var n=e.getRangeAt(0),t=n.startContainer.parentNode;if("tagName"in t&&"font"===t.tagName.toLowerCase()){var r=t.textContent,o=document.createDocumentFragment(),a=document.createTextNode(r);o.appendChild(a),t.parentNode.replaceChild(o,t),n.setStart(a,r.length),n.setEnd(a,r.length),e.removeAllRanges(),e.addRange(n)}}}();var n,t=u(M);try{for(t.s();!(n=t.n()).done;){var r=n.value;r.handleChange&&r.handleChange({event:e})}}catch(e){t.e(e)}finally{t.f()}k&&k(R.current.innerHTML.replace(/&nbsp;/g," "),p),T.onChange&&T.onChange(e),T.onInput&&T.onInput(e),H()}),[k,H,p,M,T]),P=t.useCallback((function(e){M.forEach((function(n){n.handleClick&&n.handleClick({event:e})}))}),[M]),U=t.useCallback((function(e){M.forEach((function(n){n.handleCopy&&n.handleCopy({event:e})})),T.onCopy&&T.onCopy(e)}),[M,T]),F=t.useCallback((function(e){var n,t,r,o,a,i;L.current.stack[L.current.index]!==R.current.innerHTML&&(L.current.stack.push(R.current.innerHTML),L.current.index+=1);var u=M,l=window.getSelection().focusNode,s=!!(null===(r=null===(t=null===(n=null==l?void 0:l.parentElement)||void 0===n?void 0:n.classList)||void 0===t?void 0:t.contains)||void 0===r?void 0:r.call(t,"hash")),d=!!(null===(i=null===(a=null===(o=null==l?void 0:l.parentElement)||void 0===o?void 0:o.classList)||void 0===a?void 0:a.contains)||void 0===i?void 0:i.call(a,"mention")),f=e.nativeEvent.clipboardData.getData("text");s&&c.checkValidHashTag(f)&&(u=u.filter((function(e){return"pasteToPlainText"!==e.commandKey}))),d&&c.checkValidMention(f)&&(u=u.filter((function(e){return"pasteToPlainText"!==e.commandKey}))),u.forEach((function(n){n.handlePaste&&n.handlePaste({event:e})})),T.onPaste&&T.onPaste(e)}),[M,T]),I=t.useCallback((function(e){M.forEach((function(n){n.handleFocus&&n.handleFocus({event:e})})),T.onFocus&&T.onFocus(e)}),[M,T]),O=t.useCallback((function(e){M.forEach((function(n){n.handleBlur&&n.handleBlur({event:e})})),T.onBlur&&T.onBlur(e)}),[M,T]),_=t.useCallback((function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{keepRange:!0};R.current.innerHTML=e,R.current.dispatchEvent(new Event("input",{bubbles:!0})),n.keepRange&&j()}),[j]);return t.useEffect((function(){M.forEach((function(e){e.setConfig&&e.setConfig(m[e.commandKey])}))}),[m,M]),t.useEffect((function(){if(N){var e=R.current;return N.observe(e,{childList:!0,subtree:!0,characterData:!0}),e.addEventListener("beforeinput",A),function(){N.disconnect(),e.removeEventListener("beforeinput",A)}}}),[N,A]),t.useEffect((function(){!v||R.current.innerHTML||w.current||(R.current.innerHTML=v,j(),w.current=!0)}),[v,j]),t.useEffect((function(){D(d({plugin:b,contentEditableEl:R}))}),[]),t.useImperativeHandle(i,(function(){return R.current.setData=_,R.current})),t.createElement("div",{className:s("wp-editor"),onClick:E},t.createElement(a,Object.assign({ref:R,className:s(f,"wp-editor-content")},T,{"aria-placeholder":y,"aria-valuemax":C,contentEditable:!0,onInput:q,onPaste:F,onCopy:U,onKeyDown:S,onFocus:I,onBlur:O,onClick:P})),M.filter((function(e){return null==e?void 0:e.component})).map((function(e,n){var r,o=e.component;return t.createElement(o,{key:null!==(r=e.commandKey)&&void 0!==r?r:n,plugin:e})})))}));f.displayName="WpEditor";var p=f;module.exports=p;
