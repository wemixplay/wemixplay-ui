"use client";
"use strict";var e=require("../../_virtual/_tslib.js"),t=require("react"),a=require("./FeedDetailEditor.module.scss.js"),n=require("../editor/WpEditor.js"),l=require("../../plugins/mention/Mention.js"),i=require("../../plugins/hashTag/HashTag.js"),r=require("../../plugins/autoUrlMatch/AutoUrlMatch.js"),s=require("../../plugins/pasteToPlainText/PasteToPlainText.js"),o=require("../../utils/forReactUtils.js"),c=require('./../../ext/lodash/uniqBy.js'),m=require('./../../ext/lodash/merge.js'),d=require("../../utils/fileUtils.js"),u=require("./FeedImagesView.js"),g=require("../../utils/urlUtils.js"),p=require("./FeedIframesView.js"),h=require("./FeedLinkPreview.js"),f=require("../../assets/svgs/ico-chevron-down.svg.js"),v=require("../../assets/svgs/ico-image.svg.js"),b=require("../../plugins/countTextLength/CountTextLength.js"),E=require("../../utils/valueParserUtils.js"),x=require("../avatars/Person.js"),C=require("../popover/PopoverButton.js"),w=require("../loadings/Spinner.js");const y=o.makeCxFunc(a),I=t.forwardRef(((a,o)=>{var I,{className:j="",textValue:U,images:N,media:S,ogMetaData:k,name:T,minLength:M=10,isOfficial:q,writerName:D,writerImg:L,channelName:A,channelImg:O,categoryName:P,btnSubmitText:F="POST",maxLength:R=1e3,placeholder:_="What is happening?!",config:V={},imageMaxCnt:H=4,iframeMaxCnt:W=4,selectChannelPopoverElement:z=t.createElement(t.Fragment,null),selectCategoryPopoverElement:B=t.createElement(t.Fragment,null),loading:J,isSubmitDisabled:Y=!1,handleTextChange:$,handleImageChange:G,handleMediaChange:K,handleSubmit:Q,handleExternalUrlChange:X,onSelectChannelClick:Z,onSelectCategoryClick:ee,onUserClick:te,onMaxImageUploads:ae,onMaxIframeUploads:ne}=a,le=e.__rest(a,["className","textValue","images","media","ogMetaData","name","minLength","isOfficial","writerName","writerImg","channelName","channelImg","categoryName","btnSubmitText","maxLength","placeholder","config","imageMaxCnt","iframeMaxCnt","selectChannelPopoverElement","selectCategoryPopoverElement","loading","isSubmitDisabled","handleTextChange","handleImageChange","handleMediaChange","handleSubmit","handleExternalUrlChange","onSelectChannelClick","onSelectCategoryClick","onUserClick","onMaxImageUploads","onMaxIframeUploads"]);const ie=t.useRef(),re=t.useRef(),[se,oe]=t.useState(null!==(I=null==U?void 0:U.length)&&void 0!==I?I:0),[ce,me]=t.useState(E.convertMarkdownToHtmlStr(null!=U?U:"")),[de,ue]=t.useState(N),[ge,pe]=t.useState(S),[he,fe]=t.useState(k),[ve,be]=t.useState([]),Ee=t.useMemo((()=>Object.assign(Object.assign({},ge),{textValue:ce,images:c(de,"src"),media:c(ge,"src")})),[ce,de,ge]),xe=t.useMemo((()=>{var e,t,a;const n=!!E.removeSpaceAndLineBreak(Ee.textValue),l=!!(null!==(e=Ee.images)&&void 0!==e?e:[]).length,i=!!(null!==(t=Ee.media)&&void 0!==t?t:[]).length,r=(null!==(a=Ee.images)&&void 0!==a?a:[]).some((e=>!!e.loading));return{loading:J||r,disabled:M>se||J||r||!i&&!l&&!n||Y}}),[J,M,se,Ee]),Ce=t.useCallback((e=>{var t;let a=[...null!==(t=null==Ee?void 0:Ee.images)&&void 0!==t?t:[]];if("newImage"in e){if(Array.isArray(e.newImage)&&a.length<H)a=[...a,...e.newImage.slice(0,H-a.length)];else if(!Array.isArray(e.newImage)){if(a.length>=H)return ae?ae():alert("이미지는 최대 ".concat(H,"까지 업로드가 가능합니다.")),a;a.push(e.newImage)}a=c(a,"src")}else a=a.filter(((t,a)=>e.deleteIndex!==a));return re.current.value="",a}),[Ee,T,H,ae]),we=t.useCallback((e=>{e.preventDefault()}),[]),ye=t.useCallback((t=>e.__awaiter(void 0,void 0,void 0,(function*(){var e;t.preventDefault();const a=Array.from(t.dataTransfer.files).filter((e=>e.type.startsWith("image/")));if(0===a.length)return;const n=[...null!==(e=null==Ee?void 0:Ee.images)&&void 0!==e?e:[]];for(const e of a){const t=yield d.readAsDataURLAsync(e);n.push({file:e,src:t})}const l=Ce({newImage:n});ue(l),G&&G(l,T)}))),[T,Ee,Ce,G]),Ie=t.useCallback((t=>e.__awaiter(void 0,void 0,void 0,(function*(){const{file:e,dataUrl:a}=yield d.imageFileUpload(t),n=Ce({newImage:{file:e,src:a}});ue(n),G&&G(n,T)}))),[T,Ee,Ce,G]),je=t.useCallback((e=>{let t=[...Ee.media];if("media"in e){if(t.length>=W)return ne&&ne(),t;if(Array.isArray(e.media)?t=[...t,...e.media]:t.push(e.media),t=c(t,"src"),t.length>W)return void(ne&&ne())}else t=t.filter(((t,a)=>e.deleteIndex!==a));return t}),[Ee.media,W]),Ue=t.useCallback((e=>{let{textUrls:t,mediaUrls:a}=e;const n=/\.(jpg|jpeg|png|gif|bmp|tiff|webp|avif)(\?.*)?$/i,l=[...t,...a.map((e=>e.src))].reduce(((e,t)=>{let a="etc";return n.test(t)?a="image":g.isYouTubeURL(t)?a="youtube":g.isTwitchURL(t)&&(a="twitch"),e[a]||(e[a]=[]),e[a].push(t),e}),{}),{image:i=[],youtube:r=[],twitch:s=[],etc:o=[]}=l,c=Ce({newImage:[...a.filter((e=>"img"===e.tag)),...i.map((e=>({src:e})))]}),m=je({media:[...r.map((e=>({type:"youtube",src:g.convertIframeYouTubeURL(e)}))),...s.map((e=>({type:"twitch",src:g.convertIframeTwitchURL(e)})))]});return pe(m),ue(c),K&&K(m,T),G&&G(c,T),t.map((e=>'<a href="'.concat(e.startsWith("http")?e:"https://".concat(e),'" target="_blank">').concat(e,"</a>")))}),[T,Ee,G,K,Ce,je]),Ne=t.useCallback((t=>e.__awaiter(void 0,void 0,void 0,(function*(){const e=t.clipboardData.items[0];if(0===e.type.indexOf("image")){const t=e.getAsFile(),a=yield d.readAsDataURLAsync(t);Ce({newImage:{file:t,src:a}})}}))),[Ce]),Se=t.useCallback((e=>{const t=E.convertHtmlToMarkdownStr(e);me(t),$&&$(t,T)}),[T,$]);return t.useEffect((()=>{pe(S)}),[JSON.stringify(S)]),t.useEffect((()=>{ue(N)}),[JSON.stringify(N)]),t.useEffect((()=>{fe(k)}),[JSON.stringify(k)]),t.useEffect((()=>{if(U&&!ce){const e=E.convertMarkdownToHtmlStr(U);me(e)}}),[U,ce]),t.useImperativeHandle(o,(()=>{const{setData:e}=ie.current;return ie.current.setData=t=>{const a=E.convertMarkdownToHtmlStr(t);e(a)},ie.current})),t.createElement("div",{className:y(j,"feed-detail-editor")},t.createElement("div",{className:y("feed-detail-editor-header",{"exist-user-click-event":!!te})},t.createElement(x,{src:L,size:"custom",className:y("avatar","user-img"),onClick:te}),t.createElement("div",{className:y("profile-info")},t.createElement("strong",{className:y("user-name"),onClick:te},D||"-"),t.createElement("div",{className:y("btn-post-popover")},q?t.createElement(C,{anchorId:ee?"":"post-category",id:"post-category",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:B,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!B&&!ee},onClick:ee},t.createElement("span",{className:y("selected-channel")},P||"-"," ",B||ee?t.createElement(f,null):t.createElement(t.Fragment,null))):t.createElement(C,{anchorId:Z?"":"post-channel",id:"post-channel",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:z,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!z&&!Z},onClick:Z},t.createElement("span",{className:y("selected-channel")},!!O&&t.createElement(x,{src:O,size:"custom",className:y("avatar")}),A||"내 채널에 포스트",z||Z?t.createElement(f,null):t.createElement(t.Fragment,null)))))),t.createElement("div",{className:y("feed-detail-editor-body")},t.createElement(n,Object.assign({className:y("editor","post-content",{filled:ce.length}),ref:ie,plugin:[l,i,r,s,b],initialValue:ce,placeholder:_,maxLength:R},le,{config:m({pasteToPlainText:{onMatchUrlReplace:Ue},autoUrlMatch:{onMatchUrl:e=>Ue({textUrls:[e],mediaUrls:[]}),onChangeMatchUrls:e=>{const t=/\.(jpg|jpeg|png|gif|bmp|webp|tiff|avif)$/i,a=e.filter((e=>!t.test(e)&&!g.isYouTubeURL(e)&&!g.isTwitchURL(e)));be(ve.filter((e=>a.includes(e))));const n=a.filter((e=>!ve.includes(e)));ve.includes(n[0])||X&&X(n[0])}},countTextLength:{hideUi:!0,onChangeTextLength:oe}},V),onDragOver:we,onDrop:ye,onPaste:Ne,handleChange:Se})),Ee.images.length>0&&t.createElement(u,{images:Ee.images,handleDeleteImg:e=>{let{deleteIndex:t}=e;const a=Ce({deleteIndex:t});ue(a),G&&G(a)}}),Ee.media.length>0&&t.createElement(p,{media:Ee.media,handleDeleteIframe:e=>{let{deleteIndex:t}=e;const a=je({deleteIndex:t});pe(a),K&&K(a)}}),!!he&&t.createElement(h,{ogMetaData:he,handleDeleteOgMetaData:e=>{let{urls:t}=e;fe(void 0),X&&X(void 0),be((e=>[...new Set([...e,...(null!=t?t:[]).map((e=>e.endsWith("/")?e.slice(0,-1):e))])]))}})),t.createElement("div",{className:y("control-box")},t.createElement("div",{className:y("left")},t.createElement("label",{className:y("btn-img-upload")},t.createElement("input",{ref:re,type:"file",accept:"image/png, image/gif, image/jpeg, image/jpg, image/webp, image/bmp, image/tiff",onChange:Ie}),t.createElement(v,null))),t.createElement("div",{className:y("right")},t.createElement("span",{className:y("text-count")},t.createElement("b",null,E.commaWithValue(se))," / ",E.commaWithValue(R)),t.createElement("button",{className:y("btn-submit",{loading:xe.loading}),disabled:xe.disabled,onClick:()=>Q(Object.assign(Object.assign({},Ee),{textValue:E.convertHtmlToMarkdownStr(Ee.textValue)}),T)},t.createElement("span",{className:y("text")},F),J?t.createElement("span",{className:y("spinner")},t.createElement(w,{size:20})):t.createElement(t.Fragment,null)))))}));I.displayName="FeedDetailEditor";var j=I;module.exports=j;
