"use client";
"use strict";var e=require("../../_virtual/_tslib.js"),t=require("react"),a=require("./FeedDetailEditor.module.scss.js"),n=require("../editor/WpEditor.js"),l=require("../../plugins/mention/Mention.js"),r=require("../../plugins/hashTag/HashTag.js"),i=require("../../plugins/autoUrlMatch/AutoUrlMatch.js"),s=require("../../plugins/pasteToPlainText/PasteToPlainText.js"),o=require("../../utils/forReactUtils.js"),c=require('./../../ext/lodash/uniqBy.js'),m=require('./../../ext/lodash/merge.js'),d=require("../../utils/fileUtils.js"),u=require("./FeedImagesView.js"),g=require("../../utils/urlUtils.js"),p=require("./FeedIframesView.js"),h=require("./FeedLinkPreview.js"),f=require("../../assets/svgs/ico-chevron-down.svg.js"),v=require("../../assets/svgs/ico-image.svg.js"),E=require("../../plugins/countTextLength/CountTextLength.js"),b=require("../../utils/valueParserUtils.js"),x=require("../avatars/Person.js"),C=require("../popover/PopoverButton.js"),w=require("../loadings/Spinner.js");const y=o.makeCxFunc(a),I=t.forwardRef(((a,o)=>{var I,{className:j="",textValue:U,images:N,media:k,ogMetaData:T,name:M,minLength:S=10,isOfficial:q,writerName:L,writerImg:D,channelName:A,channelImg:O,categoryName:P,btnSubmitText:F="POST",maxLength:R=1e3,placeholder:_="What is happening?!",config:V={},imageMaxCnt:H=4,iframeMaxCnt:W=4,selectChannelPopoverElement:z=t.createElement(t.Fragment,null),selectCategoryPopoverElement:B=t.createElement(t.Fragment,null),loading:J,handleTextChange:Y,handleImageChange:$,handleMediaChange:G,handleSubmit:K,handleExternalUrlChange:Q,onSelectChannelClick:X,onSelectCategoryClick:Z,onUserClick:ee,onMaxImageUploads:te,onMaxIframeUploads:ae}=a,ne=e.__rest(a,["className","textValue","images","media","ogMetaData","name","minLength","isOfficial","writerName","writerImg","channelName","channelImg","categoryName","btnSubmitText","maxLength","placeholder","config","imageMaxCnt","iframeMaxCnt","selectChannelPopoverElement","selectCategoryPopoverElement","loading","handleTextChange","handleImageChange","handleMediaChange","handleSubmit","handleExternalUrlChange","onSelectChannelClick","onSelectCategoryClick","onUserClick","onMaxImageUploads","onMaxIframeUploads"]);const le=t.useRef(),re=t.useRef(),[ie,se]=t.useState(null!==(I=null==U?void 0:U.length)&&void 0!==I?I:0),[oe,ce]=t.useState(b.convertMarkdownToHtmlStr(null!=U?U:"")),[me,de]=t.useState(N),[ue,ge]=t.useState(k),[pe,he]=t.useState(T),[fe,ve]=t.useState([]),Ee=t.useMemo((()=>Object.assign(Object.assign({},ue),{textValue:oe,images:c(me,"src"),media:c(ue,"src")})),[oe,me,ue]),be=t.useMemo((()=>{var e,t,a;const n=!!b.removeSpaceAndLineBreak(Ee.textValue),l=!!(null!==(e=Ee.images)&&void 0!==e?e:[]).length,r=!!(null!==(t=Ee.media)&&void 0!==t?t:[]).length,i=(null!==(a=Ee.images)&&void 0!==a?a:[]).some((e=>!!e.loading));return{loading:J||i,disalbed:S>ie||J||i||!r&&!l&&!n}}),[J,S,ie,Ee]),xe=t.useCallback((e=>{var t;let a=[...null!==(t=null==Ee?void 0:Ee.images)&&void 0!==t?t:[]];if("newImage"in e){if(Array.isArray(e.newImage)&&a.length<H)a=[...a,...e.newImage.slice(0,H-a.length)];else if(!Array.isArray(e.newImage)){if(a.length>=H)return te?te():alert("이미지는 최대 ".concat(H,"까지 업로드가 가능합니다.")),a;a.push(e.newImage)}a=c(a,"src")}else a=a.filter(((t,a)=>e.deleteIndex!==a));return re.current.value="",a}),[Ee,M,H,te]),Ce=t.useCallback((e=>{e.preventDefault()}),[]),we=t.useCallback((t=>e.__awaiter(void 0,void 0,void 0,(function*(){var e;t.preventDefault();const a=Array.from(t.dataTransfer.files).filter((e=>e.type.startsWith("image/")));if(0===a.length)return;const n=[...null!==(e=null==Ee?void 0:Ee.images)&&void 0!==e?e:[]];for(const e of a){const t=yield d.readAsDataURLAsync(e);n.push({file:e,src:t})}const l=xe({newImage:n});de(l),$&&$(l,M)}))),[M,Ee,xe,$]),ye=t.useCallback((t=>e.__awaiter(void 0,void 0,void 0,(function*(){const{file:e,dataUrl:a}=yield d.imageFileUpload(t),n=xe({newImage:{file:e,src:a}});de(n),$&&$(n,M)}))),[M,Ee,xe,$]),Ie=t.useCallback((e=>{let t=[...Ee.media];if("media"in e){if(t.length>=W)return ae&&ae(),t;if(Array.isArray(e.media)?t=[...t,...e.media]:t.push(e.media),t=c(t,"src"),t.length>W)return void(ae&&ae())}else t=t.filter(((t,a)=>e.deleteIndex!==a));return t}),[Ee.media,W]),je=t.useCallback((e=>{let{textUrls:t,mediaUrls:a}=e;const n=/\.(jpg|jpeg|png|gif|bmp|tiff|webp|avif)(\?.*)?$/i,l=[...t,...a.map((e=>e.src))].reduce(((e,t)=>{let a="etc";return n.test(t)?a="image":g.isYouTubeURL(t)?a="youtube":g.isTwitchURL(t)&&(a="twitch"),e[a]||(e[a]=[]),e[a].push(t),e}),{}),{image:r=[],youtube:i=[],twitch:s=[],etc:o=[]}=l,c=xe({newImage:[...a.filter((e=>"img"===e.tag)),...r.map((e=>({src:e})))]}),m=Ie({media:[...i.map((e=>({type:"youtube",src:g.convertIframeYouTubeURL(e)}))),...s.map((e=>({type:"twitch",src:g.convertIframeTwitchURL(e)})))]});return ge(m),de(c),G&&G(m,M),$&&$(c,M),t.map((e=>'<a href="'.concat(e.startsWith("http")?e:"https://".concat(e),'" target="_blank">').concat(e,"</a>")))}),[M,Ee,$,G,xe,Ie]),Ue=t.useCallback((t=>e.__awaiter(void 0,void 0,void 0,(function*(){const e=t.clipboardData.items[0];if(0===e.type.indexOf("image")){const t=e.getAsFile(),a=yield d.readAsDataURLAsync(t);xe({newImage:{file:t,src:a}})}}))),[xe]),Ne=t.useCallback((e=>{const t=b.convertHtmlToMarkdownStr(e);ce(t),Y&&Y(t,M)}),[M,Y]);return t.useEffect((()=>{ge(k)}),[JSON.stringify(k)]),t.useEffect((()=>{de(N)}),[JSON.stringify(N)]),t.useEffect((()=>{he(T)}),[JSON.stringify(T)]),t.useEffect((()=>{if(U&&!oe){const e=b.convertMarkdownToHtmlStr(U);ce(e)}}),[U,oe]),t.useImperativeHandle(o,(()=>{const{setData:e}=le.current;return le.current.setData=t=>{const a=b.convertMarkdownToHtmlStr(t);e(a)},le.current})),t.createElement("div",{className:y(j,"feed-detail-editor")},t.createElement("div",{className:y("feed-detail-editor-header",{"exist-user-click-event":!!ee})},t.createElement(x,{src:D,size:"custom",className:y("avatar","user-img"),onClick:ee}),t.createElement("div",{className:y("profile-info")},t.createElement("strong",{className:y("user-name"),onClick:ee},L||"-"),t.createElement("div",{className:y("btn-post-popover")},q?t.createElement(C,{anchorId:Z?"":"post-category",id:"post-category",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:B,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!B&&!Z},onClick:Z},t.createElement("span",{className:y("selected-channel")},P||"-"," ",B||Z?t.createElement(f,null):t.createElement(t.Fragment,null))):t.createElement(C,{anchorId:X?"":"post-channel",id:"post-channel",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:z,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!z&&!X},onClick:X},t.createElement("span",{className:y("selected-channel")},!!O&&t.createElement(x,{src:O,size:"custom",className:y("avatar")}),A||"내 채널에 포스트",z||X?t.createElement(f,null):t.createElement(t.Fragment,null)))))),t.createElement("div",{className:y("feed-detail-editor-body")},t.createElement(n,Object.assign({className:y("editor","post-content",{filled:oe.length}),ref:le,plugin:[l,r,i,s,E],initialValue:oe,placeholder:_,maxLength:R},ne,{config:m({pasteToPlainText:{onMatchUrlReplace:je},autoUrlMatch:{onMatchUrl:e=>je({textUrls:[e],mediaUrls:[]}),onChangeMatchUrls:e=>{const t=/\.(jpg|jpeg|png|gif|bmp|webp|tiff|avif)$/i,a=e.filter((e=>!t.test(e)&&!g.isYouTubeURL(e)&&!g.isTwitchURL(e)));ve(fe.filter((e=>a.includes(e))));const n=a.filter((e=>!fe.includes(e)));fe.includes(n[0])||Q&&Q(n[0])}},countTextLength:{hideUi:!0,onChangeTextLength:se}},V),onDragOver:Ce,onDrop:we,onPaste:Ue,handleChange:Ne})),Ee.images.length>0&&t.createElement(u,{images:Ee.images,handleDeleteImg:e=>{let{deleteIndex:t}=e;const a=xe({deleteIndex:t});de(a),$&&$(a)}}),Ee.media.length>0&&t.createElement(p,{media:Ee.media,handleDeleteIframe:e=>{let{deleteIndex:t}=e;const a=Ie({deleteIndex:t});ge(a),G&&G(a)}}),!!pe&&t.createElement(h,{ogMetaData:pe,handleDeleteOgMetaData:e=>{let{urls:t}=e;he(void 0),Q&&Q(void 0),ve((e=>[...new Set([...e,...(null!=t?t:[]).map((e=>e.endsWith("/")?e.slice(0,-1):e))])]))}})),t.createElement("div",{className:y("control-box")},t.createElement("div",{className:y("left")},t.createElement("label",{className:y("btn-img-upload")},t.createElement("input",{ref:re,type:"file",accept:"image/png, image/gif, image/jpeg, image/jpg, image/webp, image/bmp, image/tiff",onChange:ye}),t.createElement(v,null))),t.createElement("div",{className:y("right")},t.createElement("span",{className:y("text-count")},t.createElement("b",null,b.commaWithValue(ie))," / ",b.commaWithValue(R)),t.createElement("button",{className:y("btn-submit",{loading:be.loading}),disabled:be.disalbed,onClick:()=>K(Object.assign(Object.assign({},Ee),{textValue:b.convertHtmlToMarkdownStr(Ee.textValue)}),M)},t.createElement("span",{className:y("text")},F),J?t.createElement("span",{className:y("spinner")},t.createElement(w,{size:20})):t.createElement(t.Fragment,null)))))}));I.displayName="FeedDetailEditor";var j=I;module.exports=j;
