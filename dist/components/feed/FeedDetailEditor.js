"use client";
"use strict";var e=require("../../_virtual/_tslib.js"),t=require("react"),a=require("./FeedDetailEditor.module.scss.js"),n=require("../editor/WpEditor.js"),l=require("../../plugins/mention/Mention.js"),i=require("../../plugins/hashTag/HashTag.js"),r=require("../../plugins/autoUrlMatch/AutoUrlMatch.js"),s=require("../../plugins/pasteToPlainText/PasteToPlainText.js"),o=require("../../utils/forReactUtils.js"),c=require('./../../ext/lodash/uniqBy.js'),m=require('./../../ext/lodash/merge.js'),d=require("../../utils/fileUtils.js"),u=require("./FeedImagesView.js"),g=require("../../utils/urlUtils.js"),p=require("./FeedIframesView.js"),h=require("./FeedLinkPreview.js"),f=require("../../assets/svgs/icon-chevron-down.svg.js"),v=require("../../assets/svgs/icon-image.svg.js"),b=require("../../assets/svgs/icon-post.svg.js"),E=require("../../plugins/countTextLength/CountTextLength.js"),x=require("../../utils/valueParserUtils.js"),C=require("../avatars/Person.js"),w=require("../popover/PopoverButton.js"),y=require("../loadings/Spinner.js");const I=o.makeCxFunc(a),j=t.forwardRef(((a,o)=>{var j,{className:U="",textValue:N,images:S,media:k,ogMetaData:T,name:M,minLength:q=10,isOfficial:D,writerName:L,writerImg:A,channelName:O,channelImg:P,categoryName:F,btnSubmitText:R="POST",maxLength:_=1e3,placeholder:V="What is happening?!",config:H={},imageMaxCnt:W=4,iframeMaxCnt:z=4,selectChannelPopoverElement:B=t.createElement(t.Fragment,null),selectCategoryPopoverElement:J=t.createElement(t.Fragment,null),loading:Y,isSubmitDisabled:$=!1,handleTextChange:G,handleImageChange:K,handleMediaChange:Q,handleSubmit:X,handleExternalUrlChange:Z,onSelectChannelClick:ee,onSelectCategoryClick:te,onUserClick:ae,onMaxImageUploads:ne,onMaxIframeUploads:le}=a,ie=e.__rest(a,["className","textValue","images","media","ogMetaData","name","minLength","isOfficial","writerName","writerImg","channelName","channelImg","categoryName","btnSubmitText","maxLength","placeholder","config","imageMaxCnt","iframeMaxCnt","selectChannelPopoverElement","selectCategoryPopoverElement","loading","isSubmitDisabled","handleTextChange","handleImageChange","handleMediaChange","handleSubmit","handleExternalUrlChange","onSelectChannelClick","onSelectCategoryClick","onUserClick","onMaxImageUploads","onMaxIframeUploads"]);const re=t.useRef(),se=t.useRef(),[oe,ce]=t.useState(null!==(j=null==N?void 0:N.length)&&void 0!==j?j:0),[me,de]=t.useState(x.convertMarkdownToHtmlStr(null!=N?N:"")),[ue,ge]=t.useState(S),[pe,he]=t.useState(k),[fe,ve]=t.useState(T),[be,Ee]=t.useState([]),xe=t.useMemo((()=>Object.assign(Object.assign({},pe),{textValue:me,images:c(ue,"src"),media:c(pe,"src")})),[me,ue,pe]),Ce=t.useMemo((()=>{var e,t,a;const n=!!x.removeSpaceAndLineBreak(xe.textValue),l=!!(null!==(e=xe.images)&&void 0!==e?e:[]).length,i=!!(null!==(t=xe.media)&&void 0!==t?t:[]).length,r=(null!==(a=xe.images)&&void 0!==a?a:[]).some((e=>!!e.loading));return{loading:Y||r,disabled:q>oe||Y||r||!i&&!l&&!n||$}}),[Y,q,oe,xe]),we=t.useCallback((e=>{var t;let a=[...null!==(t=null==xe?void 0:xe.images)&&void 0!==t?t:[]];if("newImage"in e){if(Array.isArray(e.newImage)&&a.length<W)a=[...a,...e.newImage.slice(0,W-a.length)];else if(!Array.isArray(e.newImage)){if(a.length>=W)return ne?ne():alert("이미지는 최대 ".concat(W,"까지 업로드가 가능합니다.")),a;a.push(e.newImage)}a=c(a,"src")}else a=a.filter(((t,a)=>e.deleteIndex!==a));return se.current.value="",a}),[xe,M,W,ne]),ye=t.useCallback((e=>{e.preventDefault()}),[]),Ie=t.useCallback((t=>e.__awaiter(void 0,void 0,void 0,(function*(){var e;t.preventDefault();const a=Array.from(t.dataTransfer.files).filter((e=>e.type.startsWith("image/")));if(0===a.length)return;const n=[...null!==(e=null==xe?void 0:xe.images)&&void 0!==e?e:[]];for(const e of a){const t=yield d.readAsDataURLAsync(e);n.push({file:e,src:t})}const l=we({newImage:n});ge(l),K&&K(l,M)}))),[M,xe,we,K]),je=t.useCallback((t=>e.__awaiter(void 0,void 0,void 0,(function*(){const{file:e,dataUrl:a}=yield d.imageFileUpload(t),n=we({newImage:{file:e,src:a}});ge(n),K&&K(n,M)}))),[M,xe,we,K]),Ue=t.useCallback((e=>{let t=[...xe.media];if("media"in e){if(t.length>=z)return le&&le(),t;if(Array.isArray(e.media)?t=[...t,...e.media]:t.push(e.media),t=c(t,"src"),t.length>z)return void(le&&le())}else t=t.filter(((t,a)=>e.deleteIndex!==a));return t}),[xe.media,z]),Ne=t.useCallback((e=>{let{textUrls:t,mediaUrls:a}=e;const n=/\.(jpg|jpeg|png|gif|bmp|tiff|webp|avif)(\?.*)?$/i,l=[...t,...a.map((e=>e.src))].reduce(((e,t)=>{let a="etc";return n.test(t)?a="image":g.isYouTubeURL(t)?a="youtube":g.isTwitchURL(t)&&(a="twitch"),e[a]||(e[a]=[]),e[a].push(t),e}),{}),{image:i=[],youtube:r=[],twitch:s=[],etc:o=[]}=l,c=we({newImage:[...a.filter((e=>"img"===e.tag)),...i.map((e=>({src:e})))]}),m=Ue({media:[...r.map((e=>({type:"youtube",src:g.convertIframeYouTubeURL(e)}))),...s.map((e=>({type:"twitch",src:g.convertIframeTwitchURL(e)})))]});return he(m),ge(c),Q&&Q(m,M),K&&K(c,M),t.map((e=>'<a href="'.concat(e.startsWith("http")?e:"https://".concat(e),'" target="_blank">').concat(e,"</a>")))}),[M,xe,K,Q,we,Ue]),Se=t.useCallback((t=>e.__awaiter(void 0,void 0,void 0,(function*(){const e=t.clipboardData.items[0];if(0===e.type.indexOf("image")){const t=e.getAsFile(),a=yield d.readAsDataURLAsync(t);we({newImage:{file:t,src:a}})}}))),[we]),ke=t.useCallback((e=>{const t=x.convertHtmlToMarkdownStr(e);de(t),G&&G(t,M)}),[M,G]);return t.useEffect((()=>{he(k)}),[JSON.stringify(k)]),t.useEffect((()=>{ge(S)}),[JSON.stringify(S)]),t.useEffect((()=>{ve(T)}),[JSON.stringify(T)]),t.useEffect((()=>{if(N&&!me){const e=x.convertMarkdownToHtmlStr(N);de(e)}}),[N,me]),t.useImperativeHandle(o,(()=>{const{setData:e}=re.current;return re.current.setData=t=>{const a=x.convertMarkdownToHtmlStr(t);e(a)},re.current})),t.createElement("div",{className:I(U,"feed-detail-editor")},t.createElement("div",{className:I("feed-detail-editor-header",{"exist-user-click-event":!!ae})},t.createElement(C,{src:A,size:"custom",className:I("avatar","user-img"),onClick:ae}),t.createElement("div",{className:I("profile-info")},t.createElement("strong",{className:I("user-name"),onClick:ae},L||"-"),t.createElement("div",{className:I("btn-post-popover")},D?t.createElement(w,{anchorId:te?"":"post-category",id:"post-category",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:J,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!J&&!te},onClick:te},t.createElement("span",{className:I("selected-channel")},F||"-"," ",J||te?t.createElement(f,{width:16,height:16}):t.createElement(t.Fragment,null))):t.createElement(w,{anchorId:ee?"":"post-channel",id:"post-channel",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:B,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!B&&!ee},onClick:ee},t.createElement("span",{className:I("selected-channel")},!!P&&t.createElement(C,{src:P,size:"custom",className:I("avatar")}),O||"내 채널에 포스트",B||ee?t.createElement(f,{width:16,height:16}):t.createElement(t.Fragment,null)))))),t.createElement("div",{className:I("feed-detail-editor-body")},t.createElement(n,Object.assign({className:I("editor","post-content",{filled:me.length}),ref:re,plugin:[l,i,r,s,E],initialValue:me,placeholder:V,maxLength:_},ie,{config:m({pasteToPlainText:{onMatchUrlReplace:Ne},autoUrlMatch:{onMatchUrl:e=>Ne({textUrls:[e],mediaUrls:[]}),onChangeMatchUrls:e=>{const t=/\.(jpg|jpeg|png|gif|bmp|webp|tiff|avif)$/i,a=e.filter((e=>!t.test(e)&&!g.isYouTubeURL(e)&&!g.isTwitchURL(e)));Ee(be.filter((e=>a.includes(e))));const n=a.filter((e=>!be.includes(e)));be.includes(n[0])||Z&&Z(n[0])}},countTextLength:{hideUi:!0,onChangeTextLength:ce}},H),onDragOver:ye,onDrop:Ie,onPaste:Se,handleChange:ke})),xe.images.length>0&&t.createElement(u,{images:xe.images,handleDeleteImg:e=>{let{deleteIndex:t}=e;const a=we({deleteIndex:t});ge(a),K&&K(a)}}),xe.media.length>0&&t.createElement(p,{media:xe.media,handleDeleteIframe:e=>{let{deleteIndex:t}=e;const a=Ue({deleteIndex:t});he(a),Q&&Q(a)}}),!!fe&&t.createElement(h,{ogMetaData:fe,handleDeleteOgMetaData:e=>{let{urls:t}=e;ve(void 0),Z&&Z(void 0),Ee((e=>[...new Set([...e,...(null!=t?t:[]).map((e=>e.endsWith("/")?e.slice(0,-1):e))])]))}})),t.createElement("div",{className:I("control-box")},t.createElement("div",{className:I("left")},t.createElement("label",{className:I("btn-img-upload")},t.createElement("input",{ref:se,type:"file",accept:"image/png, image/gif, image/jpeg, image/jpg, image/webp, image/bmp, image/tiff",onChange:je}),t.createElement(v,null))),t.createElement("div",{className:I("right")},t.createElement("span",{className:I("text-count")},t.createElement("b",null,x.commaWithValue(oe))," / ",x.commaWithValue(_)),t.createElement("button",{className:I("btn-submit",{loading:Ce.loading}),disabled:Ce.disabled,onClick:()=>X(Object.assign(Object.assign({},xe),{textValue:x.convertHtmlToMarkdownStr(xe.textValue)}),M)},t.createElement(b,null),t.createElement("span",{className:I("text")},R),Y?t.createElement("span",{className:I("spinner")},t.createElement(y,{size:20})):t.createElement(t.Fragment,null)))))}));j.displayName="FeedDetailEditor";var U=j;module.exports=U;
