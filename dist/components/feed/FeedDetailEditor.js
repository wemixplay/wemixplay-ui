"use strict";var e=require("@babel/runtime/helpers/toConsumableArray"),t=require("@babel/runtime/helpers/slicedToArray"),n=require("@babel/runtime/regenerator"),a=require("../../_virtual/_tslib.js"),r=require("react"),i=require("./FeedDetailEditor.module.scss.js"),l=require("../editor/WpEditor.js"),o=require("../../plugins/mention/Mention.js"),s=require("../../plugins/hashTag/HashTag.js"),c=require("../../plugins/autoUrlMatch/AutoUrlMatch.js"),u=require("../../plugins/pasteToPlainText/PasteToPlainText.js"),m=require("../../utils/forReactUtils.js"),d=require("../../_virtual/uniqBy.js"),f=require("../../utils/fileUtils.js"),g=require("./FeedImagesView.js"),p=require("../../utils/urlUtils.js"),v=require("./FeedIframesView.js"),h=require("./FeedLinkPreview.js"),b=require("../../assets/svgs/ico-chevron-down.svg.js"),x=require("../../assets/svgs/ico-image.svg.js"),E=require("../../plugins/countTextLength/CountTextLength.js"),y=require("../../utils/valueParserUtils.js"),C=require("../avatars/Person.js"),w=require("../popover/PopoverButton.js"),I=require("../loadings/Spinner.js");function k(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return j(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?j(e,t):void 0}}(e))||t){n&&(e=n);var a=0,r=function(){};return{s:r,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,l=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return l=e.done,e},e:function(e){o=!0,i=e},f:function(){try{l||null==n.return||n.return()}finally{if(o)throw i}}}}function j(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}var U=m.makeCxFunc(i),S=r.forwardRef((function(i,m){var j,S=i.className,N=void 0===S?"":S,T=i.textValue,M=i.images,q=i.media,A=i.ogMetaData,L=i.name,D=i.minLength,O=void 0===D?10:D,P=i.isOfficial,F=i.writerName,R=i.writerImg,_=i.channelName,V=i.channelImg,H=i.categoryName,W=i.btnSubmitText,z=void 0===W?"POST":W,B=i.maxLength,J=void 0===B?1e3:B,Y=i.placeholder,$=void 0===Y?"What is happening?!":Y,G=i.config,K=void 0===G?{}:G,Q=i.imageMaxCnt,X=void 0===Q?4:Q,Z=i.iframeMaxCnt,ee=void 0===Z?4:Z,te=i.selectChannelPopoverElement,ne=void 0===te?r.createElement(r.Fragment,null):te,ae=i.selectCategoryPopoverElement,re=void 0===ae?r.createElement(r.Fragment,null):ae,ie=i.loading,le=i.handleTextChange,oe=i.handleImageChange,se=i.handleMediaChange,ce=i.handleSubmit,ue=i.handleExternalUrlChange,me=i.onSelectChannelClick,de=i.onSelectCategoryClick,fe=i.onUserClick,ge=i.onMaxImageUploads,pe=i.onMaxIframeUploads,ve=a.__rest(i,["className","textValue","images","media","ogMetaData","name","minLength","isOfficial","writerName","writerImg","channelName","channelImg","categoryName","btnSubmitText","maxLength","placeholder","config","imageMaxCnt","iframeMaxCnt","selectChannelPopoverElement","selectCategoryPopoverElement","loading","handleTextChange","handleImageChange","handleMediaChange","handleSubmit","handleExternalUrlChange","onSelectChannelClick","onSelectCategoryClick","onUserClick","onMaxImageUploads","onMaxIframeUploads"]),he=r.useRef(),be=r.useRef(),xe=r.useState(null!==(j=null==T?void 0:T.length)&&void 0!==j?j:0),Ee=t(xe,2),ye=Ee[0],Ce=Ee[1],we=r.useState(y.convertMarkdownToHtmlStr(null!=T?T:"")),Ie=t(we,2),ke=Ie[0],je=Ie[1],Ue=r.useState(M),Se=t(Ue,2),Ne=Se[0],Te=Se[1],Me=r.useState(q),qe=t(Me,2),Ae=qe[0],Le=qe[1],De=r.useState(A),Oe=t(De,2),Pe=Oe[0],Fe=Oe[1],Re=r.useState([]),_e=t(Re,2),Ve=_e[0],He=_e[1],We=r.useMemo((function(){return Object.assign(Object.assign({},Ae),{textValue:ke,images:d(Ne,"src"),media:d(Ae,"src")})}),[ke,Ne,Ae]),ze=r.useMemo((function(){var e,t,n,a=!!y.removeSpaceAndLineBreak(We.textValue),r=!!(null!==(e=We.images)&&void 0!==e?e:[]).length,i=!!(null!==(t=We.media)&&void 0!==t?t:[]).length,l=(null!==(n=We.images)&&void 0!==n?n:[]).some((function(e){return!!e.loading}));return{loading:ie||l,disalbed:O>ye||ie||l||!i&&!r&&!a}}),[ie,O,ye,We]),Be=r.useCallback((function(t){var n,a=e(null!==(n=null==We?void 0:We.images)&&void 0!==n?n:[]);if("newImage"in t){if(Array.isArray(t.newImage)&&a.length<X)a=[].concat(e(a),e(t.newImage.slice(0,X-a.length)));else if(!Array.isArray(t.newImage)){if(a.length>=X)return ge?ge():alert("이미지는 최대 ".concat(X,"까지 업로드가 가능합니다.")),a;a.push(t.newImage)}a=d(a,"src")}else a=a.filter((function(e,n){return t.deleteIndex!==n}));return be.current.value="",a}),[We,L,X,ge]),Je=r.useCallback((function(e){e.preventDefault()}),[]),Ye=r.useCallback((function(t){return a.__awaiter(void 0,void 0,void 0,n.mark((function a(){var r,i,l,o,s,c,u,m,d;return n.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(t.preventDefault(),i=Array.from(t.dataTransfer.files),l=i.filter((function(e){return e.type.startsWith("image/")})),0!==l.length){n.next=5;break}return n.abrupt("return");case 5:o=e(null!==(r=null==We?void 0:We.images)&&void 0!==r?r:[]),s=k(l),n.prev=7,s.s();case 9:if((c=s.n()).done){n.next=17;break}return u=c.value,n.next=13,f.readAsDataURLAsync(u);case 13:m=n.sent,o.push({file:u,src:m});case 15:n.next=9;break;case 17:n.next=22;break;case 19:n.prev=19,n.t0=n.catch(7),s.e(n.t0);case 22:return n.prev=22,s.f(),n.finish(22);case 25:d=Be({newImage:o}),Te(d),oe&&oe(d,L);case 28:case"end":return n.stop()}}),a,null,[[7,19,22,25]])})))}),[L,We,Be,oe]),$e=r.useCallback((function(e){return a.__awaiter(void 0,void 0,void 0,n.mark((function t(){var a,r,i,l;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,f.imageFileUpload(e);case 2:a=t.sent,r=a.file,i=a.dataUrl,l=Be({newImage:{file:r,src:i}}),Te(l),oe&&oe(l,L);case 8:case"end":return t.stop()}}),t)})))}),[L,We,Be,oe]),Ge=r.useCallback((function(t){var n=e(We.media);if("media"in t){if(n.length>=ee)return pe&&pe(),n;if(Array.isArray(t.media)?n=[].concat(e(n),e(t.media)):n.push(t.media),(n=d(n,"src")).length>ee)return void(pe&&pe())}else n=n.filter((function(e,n){return t.deleteIndex!==n}));return n}),[We.media,ee]),Ke=r.useCallback((function(t){var n=t.textUrls,a=t.mediaUrls,r=/\.(jpg|jpeg|png|gif|bmp|tiff|webp|avif)(\?.*)?$/i,i=[].concat(e(n),e(a.map((function(e){return e.src})))).reduce((function(e,t){var n="etc";return r.test(t)?n="image":p.isYouTubeURL(t)?n="youtube":p.isTwitchURL(t)&&(n="twitch"),e[n]||(e[n]=[]),e[n].push(t),e}),{}),l=i.image,o=void 0===l?[]:l,s=i.youtube,c=void 0===s?[]:s,u=i.twitch,m=void 0===u?[]:u,d=Be({newImage:[].concat(e(a.filter((function(e){return"img"===e.tag}))),e(o.map((function(e){return{src:e}}))))}),f=Ge({media:[].concat(e(c.map((function(e){return{type:"youtube",src:p.convertIframeYouTubeURL(e)}}))),e(m.map((function(e){return{type:"twitch",src:p.convertIframeTwitchURL(e)}}))))});return Le(f),Te(d),se&&se(f,L),oe&&oe(d,L),n.map((function(e){return'<a href="'.concat(e.startsWith("http")?e:"https://".concat(e),'" target="_blank">').concat(e,"</a>")}))}),[L,We,oe,se,Be,Ge]),Qe=r.useCallback((function(e){return a.__awaiter(void 0,void 0,void 0,n.mark((function t(){var a,r,i;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==(a=e.clipboardData.items[0]).type.indexOf("image")){t.next=7;break}return r=a.getAsFile(),t.next=5,f.readAsDataURLAsync(r);case 5:i=t.sent,Be({newImage:{file:r,src:i}});case 7:case"end":return t.stop()}}),t)})))}),[Be]),Xe=r.useCallback((function(e){var t=y.convertHtmlToMarkdownStr(e);je(t),le&&le(t,L)}),[L,le]);return r.useEffect((function(){Le(q)}),[JSON.stringify(q)]),r.useEffect((function(){Te(M)}),[JSON.stringify(M)]),r.useEffect((function(){Fe(A)}),[JSON.stringify(A)]),r.useEffect((function(){if(T&&!ke){var e=y.convertMarkdownToHtmlStr(T);je(e)}}),[T,ke]),r.useImperativeHandle(m,(function(){var e=he.current.setData;return he.current.setData=function(t){var n=y.convertMarkdownToHtmlStr(t);e(n)},he.current})),r.createElement("div",{className:U(N,"feed-detail-editor")},r.createElement("div",{className:U("feed-detail-editor-header",{"exist-user-click-event":!!fe})},r.createElement(C,{src:R,size:"custom",className:U("avatar","user-img"),onClick:fe}),r.createElement("div",{className:U("profile-info")},r.createElement("strong",{className:U("user-name"),onClick:fe},F||"-"),r.createElement("div",{className:U("btn-post-popover")},P?r.createElement(w,{anchorId:de?"":"post-category",id:"post-category",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:re,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!re&&!de},onClick:de},r.createElement("span",{className:U("selected-channel")},H||"-"," ",re||de?r.createElement(b,null):r.createElement(r.Fragment,null))):r.createElement(w,{anchorId:me?"":"post-channel",id:"post-channel",popoverStyle:{left:0,top:10,zIndex:9999},popoverElement:ne,popoverAnimation:{name:"modal-pop-fade",duration:300},ripple:{disabled:!ne&&!me},onClick:me},r.createElement("span",{className:U("selected-channel")},!!V&&r.createElement(C,{src:V,size:"custom",className:U("avatar")}),_||"내 채널에 포스트",ne||me?r.createElement(b,null):r.createElement(r.Fragment,null)))))),r.createElement("div",{className:U("feed-detail-editor-body")},r.createElement(l,Object.assign({className:U("editor","post-content",{filled:ke.length}),ref:he,plugin:[o,s,c,u,E],initialValue:ke,placeholder:$,maxLength:J},ve,{config:Object.assign(Object.assign({},K),{pasteToPlainText:{onMatchUrlReplace:Ke},autoUrlMatch:{onMatchUrl:function(e){return Ke({textUrls:[e],mediaUrls:[]})},onChangeMatchUrls:function(e){var t=/\.(jpg|jpeg|png|gif|bmp|webp|tiff|avif)$/i,n=e.filter((function(e){return!t.test(e)&&!p.isYouTubeURL(e)&&!p.isTwitchURL(e)}));He(Ve.filter((function(e){return n.includes(e)})));var a=n.filter((function(e){return!Ve.includes(e)}));Ve.includes(a[0])||ue&&ue(a[0])}},countTextLength:{hideUi:!0,onChangeTextLength:Ce}}),onDragOver:Je,onDrop:Ye,onPaste:Qe,handleChange:Xe})),We.images.length>0&&r.createElement(g,{images:We.images,handleDeleteImg:function(e){var t=e.deleteIndex,n=Be({deleteIndex:t});Te(n),oe&&oe(n)}}),We.media.length>0&&r.createElement(v,{media:We.media,handleDeleteIframe:function(e){var t=e.deleteIndex,n=Ge({deleteIndex:t});Le(n),se&&se(n)}}),!!Pe&&r.createElement(h,{ogMetaData:Pe,handleDeleteOgMetaData:function(t){var n=t.urls;Fe(void 0),ue&&ue(void 0),He((function(t){return e(new Set([].concat(e(t),e((null!=n?n:[]).map((function(e){return e.endsWith("/")?e.slice(0,-1):e}))))))}))}})),r.createElement("div",{className:U("control-box")},r.createElement("div",{className:U("left")},r.createElement("label",{className:U("btn-img-upload")},r.createElement("input",{ref:be,type:"file",accept:"image/png, image/gif, image/jpeg, image/jpg, image/webp, image/bmp, image/tiff",onChange:$e}),r.createElement(x,null))),r.createElement("div",{className:U("right")},r.createElement("span",{className:U("text-count")},r.createElement("b",null,y.commaWithValue(ye))," / ",y.commaWithValue(J)),r.createElement("button",{className:U("btn-submit",{loading:ze.loading}),disabled:ze.disalbed,onClick:function(){return ce(Object.assign(Object.assign({},We),{textValue:y.convertHtmlToMarkdownStr(We.textValue)}),L)}},r.createElement("span",{className:U("text")},z),ie?r.createElement("span",{className:U("spinner")},r.createElement(I,{size:20})):r.createElement(r.Fragment,null)))))}));S.displayName="FeedDetailEditor",module.exports=S;
