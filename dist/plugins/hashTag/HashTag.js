"use strict";var e=require("@babel/runtime/helpers/slicedToArray"),t=require("@babel/runtime/helpers/toConsumableArray"),n=require("@babel/runtime/helpers/classCallCheck"),a=require("@babel/runtime/helpers/createClass"),i=require("react"),s=require("../../_virtual/uniqueId.js"),o=require("./components/HashList.js"),r=require("./components/HashContainer.js"),l=require("../../utils/pluginUtils.js"),d=function(){return a((function e(t){var a=t.contentEditableEl;n(this,e),this.commandKey="hash",this.currentHashList=[],this._config={list:[],onWriteHash:function(e){}},this.contentEditableEl=a}),[{key:"hashId",get:function(){return this._hashId},set:function(e){this._hashId=e,this.setTargetHashId&&this.setTargetHashId(this._hashId),e?this.config.onOpenHashList&&this.config.onOpenHashList():this.config.onCloseHashList&&this.config.onCloseHashList()}},{key:"config",get:function(){return this._config},set:function(e){this._config=e,this.setNewConfig&&this.setNewConfig(e)}},{key:"setConfig",value:function(e){this.config=Object.assign(Object.assign({},this.config),null!=e?e:{})}},{key:"component",value:function(e){var t=this,n=e.plugin;return i.createElement(r,{hash:n},(function(e){var a=e.config,s=e.targetHashId;return i.createElement(o,{ref:function(e){n.hashListRef=e},contentEditableEl:n.contentEditableEl,targetHashId:s,list:a.detectDuplicate?a.list.filter((function(e){return t.currentHashList.every((function(t){return t.name!==e.name}))})):a.list,listElement:a.listElement,selectHashItem:function(e){n.selectHashItem(e)},closeHashList:function(){n.hashId=""}})}))}},{key:"getAllHashTag",value:function(){var e=this.contentEditableEl.current.querySelectorAll(".hash");return Array.from(e).map((function(e){return Object.assign(Object.assign({},Object.fromEntries(Object.entries(e.dataset))),{name:e.textContent.replace("#","").trim()})}))}},{key:"updateCurrentHashList",value:function(e){this.currentHashList=this.getAllHashTag(),e&&(this.currentHashList=[].concat(t(this.currentHashList),[e])),this.config.onCompleteHash&&this.config.onCompleteHash({allHashTag:this.currentHashList,currentHashTag:e})}},{key:"leaveHashTag",value:function(){var e,t,n,a,i,s,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=o.hash,l=o.keepTag,d=window.getSelection(),h=document.createRange(),c=this.contentEditableEl.current,u=this.hashId,v=c.querySelector("#".concat(u));if(v){var f="#"===(null===(t=null===(e=v.firstChild)||void 0===e?void 0:e.textContent)||void 0===t?void 0:t.trim())&&!r,m=new RegExp('<span\\s+id="'.concat(u,'"([^>]*)class="hash"([^>]*)>(.*?)<\\/span>'),"g");if(f){var g=document.createTextNode(null===(n=v.firstChild)||void 0===n?void 0:n.textContent);v.replaceWith(g);var p=document.createRange();return p.setStartAfter(g),p.setEndAfter(g),d.removeAllRanges(),d.addRange(p),void(this.hashId="")}if(r)if(this.config.detectDuplicate&&this.currentHashList.some((function(e){return e.name===r.name})))c.innerHTML=c.innerHTML.replace(m,'<span id="'.concat(u,'" class="duplicate-hash"$1$2>#').concat(r.name,"</span>"));else{c.innerHTML=c.innerHTML.replace(m,'<span id="'.concat(u,'" class="hash complete-hash"$1$2>#').concat(r.name,"</span>"));var E=c.querySelector("#".concat(u));E.dataset.id=String(r.id),E.dataset.name=r.name,E.textContent="#".concat(r.name)}else if(!l){var C=d.focusNode.textContent.trim();if(this.config.detectDuplicate&&this.currentHashList.some((function(e){return e.name===r.name})))c.innerHTML=c.innerHTML.replace(m,'<span id="'.concat(u,'" class="duplicate-hash"$1$2>').concat(C,"</span>"));else{c.innerHTML=c.innerHTML.replace(m,'<span id="'.concat(u,'" class="hash"$1$2>').concat(C,"</span>"));var H=c.querySelector("#".concat(u));H.dataset.id="0",H.dataset.name=C.replace("#",""),this.updateCurrentHashList({id:Number(H.dataset.id),name:H.dataset.name})}}this.hashId="";var x=null===(a=c.querySelector("#".concat(u)))||void 0===a?void 0:a.nextSibling;(Node.TEXT_NODE!==(null==x?void 0:x.TEXT_NODE)||(null===(i=null==x?void 0:x.nodeValue)||void 0===i?void 0:i.trim()))&&c.querySelector("#".concat(u)).insertAdjacentHTML("afterend","&nbsp;");var T=f?c:null===(s=c.querySelector("#".concat(u)))||void 0===s?void 0:s.nextSibling;f?(h.selectNodeContents(T),h.collapse(!1)):(h.setStart(T,1),h.collapse(!0)),d.removeAllRanges(),d.addRange(h),this.contentEditableEl.current.dispatchEvent(new Event("input",{bubbles:!0}))}}},{key:"selectHashItem",value:function(e){var t,n=this.hashListRef.handleSubmit(e);Number(this.contentEditableEl.current.ariaValueMax)<=(null!==(t=null==n?void 0:n.name)&&void 0!==t?t:"").length+this.contentEditableEl.current.textContent.length?this.hashId="":(this.leaveHashTag({hash:n}),this.updateCurrentHashList(n))}},{key:"handleClick",value:function(e){var t,n,a,i,s,o=window.getSelection(),r=o.focusNode,l=!!(null===(a=null===(n=null===(t=null==r?void 0:r.parentElement)||void 0===t?void 0:t.classList)||void 0===n?void 0:n.contains)||void 0===a?void 0:a.call(n,"hash")),d=o.getRangeAt(0);l&&d.startOffset>0&&d.startOffset===d.endOffset&&(this.hashId=r.parentElement.id,this.config.onWriteHash&&this.config.onWriteHash(null===(s=null===(i=null==r?void 0:r.parentElement)||void 0===i?void 0:i.textContent)||void 0===s?void 0:s.replace("#","")))}},{key:"handleKeyDown",value:function(e){var t,n,a,i,s,o,r,l,d,h,c=e.event,u=window.getSelection(),v=document.createRange(),f=this.hashId,m=u.focusNode,g=u.focusOffset,p=!!(null===(a=null===(n=null===(t=null==m?void 0:m.parentElement)||void 0===t?void 0:t.classList)||void 0===n?void 0:n.contains)||void 0===a?void 0:a.call(n,"hash")),E=p&&!(null===(o=null===(s=null===(i=null==m?void 0:m.parentElement)||void 0===i?void 0:i.classList)||void 0===s?void 0:s.contains)||void 0===o?void 0:o.call(s,"complete-hash"));if("ArrowLeft"!==c.code&&"ArrowRight"!==c.code||(p&&g>1&&!f?(this.config.onWriteHash&&this.config.onWriteHash(null===(l=null===(r=null==m?void 0:m.parentElement)||void 0===r?void 0:r.textContent)||void 0===l?void 0:l.replace("#","")),this.hashId=m.parentElement.id):p&&f&&g<=1?this.hashId="":f&&"#"===(null===(d=m.firstChild)||void 0===d?void 0:d.textContent)?this.leaveHashTag():(f&&!p||f&&p&&!E&&g>=m.textContent.length)&&(this.hashId="")),"ArrowRight"===c.code)f&&E&&!m.parentElement.nextElementSibling&&!c.nativeEvent.isComposing?(c.preventDefault(),this.leaveHashTag()):f&&"#"===(null===(h=m.firstChild)||void 0===h?void 0:h.textContent)&&this.leaveHashTag();else if("ArrowUp"===c.code||"ArrowDown"===c.code)f&&(c.preventDefault(),"ArrowUp"===c.code?this.hashListRef.handleArrowUp():this.hashListRef.handleArrowDown());else if("Enter"===c.code)if(f&&!c.nativeEvent.isComposing)c.preventDefault(),this.selectHashItem();else if(p&&g<=1){c.preventDefault();var C=document.createElement("br");m.parentElement.parentNode.insertBefore(C,m.parentElement),v.setStartAfter(C),v.setEndAfter(C),u.removeAllRanges(),u.addRange(v)}}},{key:"handleChange",value:function(t){var n,a,i,o,r,d,h,c,u,v,f,m=window.getSelection(),g=document.createRange(),p=this.contentEditableEl.current,E=m.focusNode,C=m.focusOffset,H=null===(n=null==E?void 0:E.textContent)||void 0===n?void 0:n[C-1],x=null===(a=null==E?void 0:E.textContent)||void 0===a?void 0:a[C-2],T=!!(null===(r=null===(o=null===(i=null==E?void 0:E.parentElement)||void 0===i?void 0:i.classList)||void 0===o?void 0:o.contains)||void 0===r?void 0:r.call(o,"hash")),b=T&&!!(null===(c=null===(h=null===(d=null==E?void 0:E.parentElement)||void 0===d?void 0:d.classList)||void 0===h?void 0:h.contains)||void 0===c?void 0:c.call(h,"complete-hash")),N=!(null==x?void 0:x.trim())&&(null==E?void 0:E.nodeType)===Node.TEXT_NODE&&!T&&"#"===H;if(this.hashId&&T){var L=E.parentElement,R=L.textContent.replace("#","");this.config.onWriteHash&&this.config.onWriteHash(R),R===(null===(u=this.config.list[0])||void 0===u?void 0:u.name)?L.dataset.id=String(this.config.list[0].id):L.dataset.id="0",L.dataset.name=R,this.updateCurrentHashList()}if(N){this.hashId="hash-".concat(s());var I=null!==(v=null==E?void 0:E.textContent)&&void 0!==v?v:"",S=I.slice(0,C-1),A=I.slice(C),y=document.createElement("span");y.id=this.hashId,y.className="hash",y.textContent="#",y.dataset.id="0",y.dataset.name=I,E.textContent=S;var w=E.parentNode;w.insertBefore(y,E.nextSibling);var k=document.createTextNode(A);w.insertBefore(k,y.nextSibling);var q=p.querySelector("#".concat(this.hashId));if(!q)return;g.setStart(q,1),g.collapse(!0),m.removeAllRanges(),m.addRange(g)}else if(T&&1===C&&" "===H){this.hashId="";var O=window.getSelection(),D=O.getRangeAt(0),W=D.startContainer.parentNode;W.textContent=W.textContent.trimStart();var B=document.createTextNode(" ");W.parentNode.insertBefore(B,W),D.setStartBefore(B),D.setEndBefore(B),O.removeAllRanges(),O.addRange(D)}else{if(T&&E.textContent.split(" ").length>1){this.hashId="";var j=E.textContent.split(" "),M=e(j,2),_=M[0],$=M[1],U=document.createTextNode("Â "),V=document.createTextNode("".concat(_," ")),X=document.createTextNode($);return E.parentNode.parentNode.insertBefore(X,E.parentNode.nextSibling),C!==E.textContent.length?(E.parentElement.replaceWith(V),g.setStartBefore(X),g.setEndBefore(X)):(E.textContent=_,"#"===_?(E.parentElement.replaceWith(V),g.setStartAfter(V),g.setEndAfter(V)):(E.parentNode.parentNode.insertBefore(U,E.parentNode.nextSibling),g.setStartAfter(X),g.setEndAfter(X))),m.removeAllRanges(),void m.addRange(g)}if(T&&!l.checkValidHashTag(E.parentElement.textContent)){this.hashId="";var K=m.getRangeAt(0).startOffset,P=E.parentNode,z=P.textContent.split("#");if((null==z?void 0:z.length)>2){var F=document.createTextNode(E.parentElement.textContent);E.parentElement.replaceWith(F);var G=document.createRange();G.setStart(F,F.length),G.setEnd(F,F.length),m.removeAllRanges(),m.addRange(G)}var J=e(z,2),Q=J[0],Y=J[1];if(Y&&Y===E.parentElement.dataset.name){var Z=document.createTextNode(Q);P.textContent="#".concat(Y),P.parentNode.insertBefore(Z,P);var ee=document.createRange();ee.setStart(Z,K),ee.setEnd(Z,K),m.removeAllRanges(),m.addRange(ee)}else if(Y){var te=document.createTextNode("".concat(E.textContent," "));E.parentElement.parentNode.replaceChild(te,E.parentNode);var ne=document.createRange();ne.setStart(te,K),ne.setEnd(te,K),m.removeAllRanges(),m.addRange(ne)}return}if(b&&E.parentElement.dataset.name.trim()!==E.parentElement.textContent.replace("#","").trim()){for(var ae in E.parentElement.classList.remove("complete-hash"),E.parentElement.dataset.id="0",E.parentElement.dataset.name=E.parentElement.textContent.replace("#","").trim(),E.parentElement.dataset)delete E.parentElement.dataset[ae];this.hashId=E.parentElement.id,g.setStart(E,C),g.collapse(!0),m.removeAllRanges(),m.addRange(g)}}N||T||(this.hashId=""),N||!T||b||this.hashId||!(null===(f=E.parentElement)||void 0===f?void 0:f.id)||(this.hashId=E.parentElement.id),!N&&T&&this.hashId&&!E.textContent.slice(-1).trim()&&this.leaveHashTag(),this.currentHashList.length!==this.getAllHashTag().length&&this.updateCurrentHashList()}},{key:"handleUndoRedo",value:function(){var e,t=document.createRange();if(null===(e=t.startContainer.classList)||void 0===e?void 0:e.contains("hash")){var n=t.startContainer,a=n.id;this.hashId||(this.config.onWriteHash&&this.config.onWriteHash(n.innerText.replace("#","")),this.hashId=a)}else this.hashId=""}},{key:"handlePaste",value:function(e){var t,n,a,i=e.event,s=window.getSelection(),o=s.focusNode,r=!!(null===(a=null===(n=null===(t=null==o?void 0:o.parentElement)||void 0===t?void 0:t.classList)||void 0===n?void 0:n.contains)||void 0===a?void 0:a.call(n,"hash")),d=i.nativeEvent.clipboardData.getData("text");if(r&&l.checkValidHashTag(d)){var h=o.parentElement,c=document.createTextNode(d);h.nextSibling?h.parentNode.insertBefore(c,h.nextSibling):h.parentNode.appendChild(c);var u=document.createRange();u.setStartAfter(c),u.collapse(!0),s.removeAllRanges(),s.addRange(u),i.preventDefault()}}},{key:"observe",value:function(e){var t=e.setTargetHashId,n=e.setConfig;this.setTargetHashId=t,this.setNewConfig=n}}])}();module.exports=d;
