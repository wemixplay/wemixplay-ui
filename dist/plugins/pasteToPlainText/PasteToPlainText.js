"use strict";var t=require("isomorphic-dompurify");const{sanitize:e}=t;module.exports=class{constructor(t){let{contentEditableEl:e}=t;this.commandKey="pasteToPlainText",this.config={},this.contentEditableEl=e}setConfig(t){this.config=Object.assign(Object.assign({},this.config),null!=t?t:{})}checkHTMLFormat(t){return/<(div|span|p|img|video|iframe)(\s[^>]*)?>/i.test(t)}getMediaMatchUrlList(t){const e=/<(img|video|iframe)(?=[^>]*\s+src=["']([^"']+)["'])[^>]*>/g;let i;const n=[];for(;null!==(i=e.exec(t));)n.push({tag:i[1],src:i[2].startsWith("http")?i[2]:"https://".concat(i[2])});return n}getUrlMatchList(t){var e,i;return null!==(i=null===(e=(null!=t?t:"").match(/\bhttps?:\/\/[^\s"']+|www\.[^\s"']+|ftp:\/\/[^\s"']+/gi))||void 0===e?void 0:e.map((t=>{const e=t.trim();return e.startsWith("http")?e:"https://".concat(e)})))&&void 0!==i?i:[]}handlePaste(t){let{event:i}=t;var n,a,s;const c=window.getSelection(),r=e(i.nativeEvent.clipboardData.getData("text")),l=e(i.nativeEvent.clipboardData.getData("text/html"));let o=i.nativeEvent.clipboardData.getData("text/plain");o=e(o);const d=this.contentEditableEl.current.getAttribute("aria-valuemax");if(d){const t=this.contentEditableEl.current.textContent.length,e=o.length;Number(d)-(t+e)<0&&(o="",i.preventDefault())}o=o.replace(/<img[^>]*src="([^"]*)"[^>]*>/gi,"$1").replace(/<video[^>]*>.*?<\/video>/gi,"").replace(/<iframe[^>]*>.*?<\/iframe>/gi,"");const h=[...new Set(this.getMediaMatchUrlList(this.checkHTMLFormat(r)?r:l))],g=[...new Set(this.getUrlMatchList(o))],p=[...new Set(null!==(s=null===(a=(n=this.config).onMatchUrlReplace)||void 0===a?void 0:a.call(n,{textUrls:g,mediaUrls:h}))&&void 0!==s?s:[])];if(g.forEach(((t,e)=>{if(p[e]){const i=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),n=t.replace("https://","");o.includes(t)?o=o.replace(new RegExp(i,"g"),((t,i)=>o.slice(Math.max(0,i-5),i).includes('src="')?t:p[e])):o.includes(n)&&(o=o.replace(new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),((t,i)=>o.slice(Math.max(0,i-5),i).includes('src="')?t:p[e])))}})),o.length>0){const t=c.getRangeAt(0);t.deleteContents();const e=document.createElement("div");e.innerHTML="".concat(o.replace(/<script\b[^>]*>([\s\S]*?)<\/script>|<style\b[^>]*>([\s\S]*?)<\/style>/gi,"").trim(),"&nbsp;");const i=e.lastChild;for(const i of Array.from(e.childNodes).reverse())t.insertNode(i);e.remove(),t.setStartAfter(i),t.setEndAfter(i),c.removeAllRanges(),c.addRange(t)}i.preventDefault(),this.contentEditableEl.current.dispatchEvent(new Event("input",{bubbles:!0}))}};
