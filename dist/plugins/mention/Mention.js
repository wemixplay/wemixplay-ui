"use strict";var e=require("../../_virtual/_tslib.js"),t=require("react"),n=require('./../../ext/lodash/uniqueId.js'),i=require("./components/MentionList.js"),o=require("./components/MentionContainer.js"),l=require("../../utils/pluginUtils.js");module.exports=class{constructor(e){let{contentEditableEl:t}=e;this.commandKey="mention",this.currentMentionList=[],this._config={list:[],onWriteMention:e=>{}},this.contentEditableEl=t}set mentionId(e){this._mentionId=e,this.setTargetMentionId&&this.setTargetMentionId(this._mentionId),e?this.config.onOpenMentionList&&this.config.onOpenMentionList():this.config.onCloseMentionList&&this.config.onCloseMentionList()}get mentionId(){return this._mentionId}set config(e){this._config=e,this.setNewConfig&&this.setNewConfig(e)}get config(){return this._config}setConfig(e){this.config=Object.assign(Object.assign({},this.config),null!=e?e:{})}component(e){let{plugin:n}=e;return t.createElement(o,{mention:n},(e=>{let{config:o,targetMentionId:l}=e;return t.createElement(i,{ref:e=>{n.mentionListRef=e},targetMentionId:l,contentEditableEl:n.contentEditableEl,list:o.detectDuplicate?o.list.filter((e=>this.currentMentionList.every((t=>t.name!==e.name)))):o.list,listElement:o.listElement,selectMentionItem:e=>{n.selectMentionItem(e)},closeMentionList:()=>{n.mentionId=""}})}))}getCurrentMentionList(){const e=this.contentEditableEl.current.querySelectorAll(".mention.complete-mention"),t=Array.from(e).map((e=>Object.assign(Object.assign({},Object.fromEntries(Object.entries(e.dataset))),{name:e.textContent.replace("@","").trim()})));return this.currentMentionList=t,this.config.onCompleteMention&&this.config.onCompleteMention({allMention:t}),t}leaveMentionTag(){let{mention:e,keepTag:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var n,i,o,l,s;const a=window.getSelection(),r=document.createRange(),c=this.contentEditableEl.current,d=this.mentionId,m=c.querySelector("#".concat(d));if(!m)return;const u="@"===(null===(n=null==m?void 0:m.textContent)||void 0===n?void 0:n.trim())&&!e,v=!!(null==m?void 0:m.classList.contains("will-mention")),g=new RegExp('<span\\s+id="'.concat(d,'"([^>]*)class="mention ').concat(v?"will-mention":"unknown-mention",'"([^>]*)>(.*?)<\\/span>'),"g");if(u){const e=document.createTextNode(null===(i=m.firstChild)||void 0===i?void 0:i.textContent);m.replaceWith(e);const t=document.createRange();return t.setStartAfter(e),t.setEndAfter(e),a.removeAllRanges(),a.addRange(t),void(this.mentionId="")}if(e){c.innerHTML=c.innerHTML.replace(g,'<span id="'.concat(d,'" class="mention complete-mention"$1$2>@').concat(e.name.trim(),"</span>"));const t=c.querySelector("#".concat(d));t.dataset.id=String(e.id),t.dataset.name=e.name.trim(),t.textContent="@".concat(e.name.trim())}else if(!t){const e=a.focusNode.textContent.trim();c.innerHTML=c.innerHTML.replace(g,'<span id="'.concat(d,'" class="mention unknown-mention"$1$2>').concat(e,"</span>"))}this.mentionId="";const h=null===(o=c.querySelector("#".concat(d)))||void 0===o?void 0:o.nextSibling;(Node.TEXT_NODE!==(null==h?void 0:h.TEXT_NODE)||(null===(l=null==h?void 0:h.nodeValue)||void 0===l?void 0:l.trim()))&&c.querySelector("#".concat(d)).insertAdjacentHTML("afterend","&nbsp;");const f=u?c:null===(s=c.querySelector("#".concat(d)))||void 0===s?void 0:s.nextSibling;u?(r.selectNodeContents(f),r.collapse(!1)):(r.setStart(f,1),r.collapse(!0)),a.removeAllRanges(),a.addRange(r),this.contentEditableEl.current.dispatchEvent(new Event("input",{bubbles:!0}))}handleClick(e){var t,n,i,o,l;const s=window.getSelection(),a=s.focusNode,r=!!(null===(i=null===(n=null===(t=null==a?void 0:a.parentElement)||void 0===t?void 0:t.classList)||void 0===n?void 0:n.contains)||void 0===i?void 0:i.call(n,"mention")),c=s.getRangeAt(0);r&&c.startOffset>0&&c.startOffset===c.endOffset&&(this.config.onWriteMention&&this.config.onWriteMention(null===(l=null===(o=null==a?void 0:a.parentElement)||void 0===o?void 0:o.textContent)||void 0===l?void 0:l.replace("@","")),this.mentionId=a.parentElement.id)}selectMentionItem(t){var n;return e.__awaiter(this,void 0,void 0,(function*(){const e=this.mentionListRef.handleSubmit(t);if(Number(this.contentEditableEl.current.ariaValueMax)<=(null!==(n=null==e?void 0:e.name)&&void 0!==n?n:"").length+this.contentEditableEl.current.textContent.length)return void(this.mentionId="");const i=this.contentEditableEl.current.querySelectorAll(".mention.complete-mention");if(this.config.maxMentionCnt&&this.config.maxMentionCnt<=i.length)return this.mentionId="",this.contentEditableEl.current.blur(),void(this.config.onMaxMentionList?yield this.config.onMaxMentionList():alert("최대 ".concat(this.config.maxMentionCnt,"개 까지 작성이 가능합니다.")));this.leaveMentionTag({mention:e});const o=Array.from(i).map((e=>Object.assign(Object.assign({},Object.fromEntries(Object.entries(e.dataset))),{name:e.textContent.replace("@","").trim()})));this.currentMentionList=[...o,e],this.config.onCompleteMention&&this.config.onCompleteMention({allMention:this.currentMentionList,currentMention:e})}))}handleKeyDown(e){let{event:t}=e;var n,i,o,l,s,a,r,c,d,m,u,v,g;const h=window.getSelection(),f=document.createRange(),p=this.mentionId,E=h.focusNode,M=h.focusOffset,C=!!(null===(o=null===(i=null===(n=null==E?void 0:E.parentElement)||void 0===n?void 0:n.classList)||void 0===i?void 0:i.contains)||void 0===o?void 0:o.call(i,"mention")),x=!!(null===(a=null===(s=null===(l=null==E?void 0:E.parentElement)||void 0===l?void 0:l.classList)||void 0===s?void 0:s.contains)||void 0===a?void 0:a.call(s,"will-mention"))||!!(null===(d=null===(c=null===(r=null==E?void 0:E.parentElement)||void 0===r?void 0:r.classList)||void 0===c?void 0:c.contains)||void 0===d?void 0:d.call(c,"unknown-mention"));if("ArrowLeft"!==t.code&&"ArrowRight"!==t.code||(!p&&M>1&&C?(this.config.onWriteMention&&this.config.onWriteMention(null===(u=null===(m=null==E?void 0:E.parentElement)||void 0===m?void 0:m.textContent)||void 0===u?void 0:u.replace("@","")),this.mentionId=E.parentElement.id):C&&p&&M<=1?this.mentionId="":C&&p&&"@"===(null===(v=E.firstChild)||void 0===v?void 0:v.textContent)?this.leaveMentionTag():(p&&!C||p&&C&&!x&&M>=E.textContent.length)&&(this.mentionId="")),"ArrowRight"===t.code)p&&x&&!E.parentElement.nextElementSibling&&!t.nativeEvent.isComposing?(t.preventDefault(),this.leaveMentionTag()):p&&"@"===(null===(g=E.firstChild)||void 0===g?void 0:g.textContent)&&this.leaveMentionTag();else if("ArrowUp"===t.code||"ArrowDown"===t.code)p&&(t.preventDefault(),"ArrowUp"===t.code?this.mentionListRef.handleArrowUp():this.mentionListRef.handleArrowDown());else if("Enter"===t.code)if(p&&!t.nativeEvent.isComposing)t.preventDefault(),this.selectMentionItem();else if(C&&M<=1){t.preventDefault();const e=document.createElement("br");E.parentElement.parentNode.insertBefore(e,E.parentElement),f.setStartAfter(e),f.setEndAfter(e),h.removeAllRanges(),h.addRange(f)}}handleChange(e){var t,i,o,s,a,r,c,d,m,u;const v=window.getSelection(),g=this.contentEditableEl.current,h=v.focusNode,f=v.focusOffset,p=null===(t=null==h?void 0:h.textContent)||void 0===t?void 0:t[f-1],E=null===(i=null==h?void 0:h.textContent)||void 0===i?void 0:i[f-2],M=!!(null===(a=null===(s=null===(o=null==h?void 0:h.parentElement)||void 0===o?void 0:o.classList)||void 0===s?void 0:s.contains)||void 0===a?void 0:a.call(s,"mention")),C=!!(null===(d=null===(c=null===(r=null==h?void 0:h.parentElement)||void 0===r?void 0:r.classList)||void 0===c?void 0:c.contains)||void 0===d?void 0:d.call(c,"complete-mention")),x=this.contentEditableEl.current.querySelectorAll(".mention.complete-mention"),b=!(null==E?void 0:E.trim())&&(null==h?void 0:h.nodeType)===Node.TEXT_NODE&&!M&&"@"===p;if(this.mentionId&&M&&this.config.onWriteMention&&this.config.onWriteMention(h.parentElement.firstChild.textContent.replace("@","")),b&&(null!=x?x:[]).length>=this.config.maxMentionCnt)this.config.onMaxMentionList?this.config.onMaxMentionList():alert("최대 ".concat(this.config.maxMentionCnt,"개 까지 작성이 가능합니다."));else if(b){const e=document.createRange();this.mentionId="mention-".concat(n());const t=null!==(m=h.textContent)&&void 0!==m?m:"",i=t.slice(0,f-1),o=t.slice(f),l=document.createElement("span");l.id=this.mentionId,l.className="mention will-mention",l.textContent="@",h.textContent=i;const s=h.parentNode;s.insertBefore(l,h.nextSibling);const a=document.createTextNode(o);s.insertBefore(a,l.nextSibling);const r=g.querySelector("#".concat(this.mentionId));if(!r)return;e.setStart(r,1),e.collapse(!0),v.removeAllRanges(),v.addRange(e)}else if(M&&1===f&&" "===p){this.mentionId="";const e=window.getSelection(),t=e.getRangeAt(0),n=t.startContainer.parentNode;n.textContent=n.textContent.trimStart();const i=document.createTextNode(" ");n.parentNode.insertBefore(i,n),t.setStartBefore(i),t.setEndBefore(i),e.removeAllRanges(),e.addRange(t)}else{if(M&&h.textContent.split(" ").length>1){this.mentionId="";const e=document.createRange(),[t,n]=h.textContent.split(" "),i=document.createTextNode(" "),o=document.createTextNode("".concat(t," ")),l=document.createTextNode(n);return h.parentNode.parentNode.insertBefore(l,h.parentNode.nextSibling),f!==h.textContent.length?(h.parentElement.replaceWith(o),e.setStartBefore(l),e.setEndBefore(l)):(h.textContent=t,h.parentNode.parentNode.insertBefore(i,h.parentNode.nextSibling),e.setStartAfter(l),e.setEndAfter(l)),v.removeAllRanges(),void v.addRange(e)}if(M&&!l.checkValidMention(h.textContent)){this.mentionId="";const e=v.getRangeAt(0).startOffset,t=document.createTextNode("".concat(h.textContent," "));h.parentElement.parentNode.replaceChild(t,h.parentNode);const n=document.createRange();return n.setStart(t,e),n.setEnd(t,e),v.removeAllRanges(),void v.addRange(n)}if(C&&h.parentElement.dataset.name.trim()!==h.parentElement.textContent.replace("@","").trim()){const e=document.createRange();h.parentElement.classList.replace("complete-mention","will-mention");for(const e in h.parentElement.dataset)delete h.parentElement.dataset[e];this.mentionId=h.parentElement.id,e.setStart(h,null!=f?f:0),e.collapse(!0),v.removeAllRanges(),v.addRange(e)}}return b||M||(this.mentionId=""),b||!M||C||this.mentionId||!(null===(u=h.parentElement)||void 0===u?void 0:u.id)||(this.mentionId=h.parentElement.id),!b&&M&&this.mentionId&&!h.textContent.slice(-1).trim()&&this.leaveMentionTag(),this.currentMentionList.length!==x.length&&this.getCurrentMentionList(),!1}handleUndoRedo(){var e;const t=document.createRange();if(null===(e=t.startContainer.classList)||void 0===e?void 0:e.contains("mention")){const e=t.startContainer,n=e.id;this.mentionId||(this.config.onWriteMention&&this.config.onWriteMention(e.innerText.replace("@","")),this.mentionId=n)}else this.mentionId=""}handlePaste(e){let{event:t}=e;var n,i,o;const s=window.getSelection(),a=s.focusNode,r=!!(null===(o=null===(i=null===(n=null==a?void 0:a.parentElement)||void 0===n?void 0:n.classList)||void 0===i?void 0:i.contains)||void 0===o?void 0:o.call(i,"mention")),c=t.nativeEvent.clipboardData.getData("text");if(r&&l.checkValidMention(c)){const e=a.parentElement,n=document.createTextNode(c);e.nextSibling?e.parentNode.insertBefore(n,e.nextSibling):e.parentNode.appendChild(n);const i=document.createRange();i.setStartAfter(n),i.collapse(!0),s.removeAllRanges(),s.addRange(i),t.preventDefault()}}observe(e){let{setTargetMentionId:t,setConfig:n}=e;this.setTargetMentionId=t,this.setNewConfig=n}};
